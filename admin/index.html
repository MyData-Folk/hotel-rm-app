<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HotelManager Pro V2 - Console Admin</title>
    <link rel="icon" type="image/svg+xml" href="https://cdn.jsdelivr.net/npm/lucide-static@0.263.1/icons/hotel.svg">
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.29.2/dist/feather.min.js"></script>
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
    <div class="absolute inset-0 -z-10 overflow-hidden">
        <div class="absolute -top-40 -left-32 h-80 w-80 rounded-full bg-gradient-to-br from-indigo-500/40 to-purple-500/30 blur-3xl"></div>
        <div class="absolute top-1/2 right-0 h-96 w-96 -translate-y-1/2 rounded-full bg-gradient-to-tr from-sky-500/30 to-emerald-400/20 blur-3xl"></div>
        <div class="noise-layer"></div>
    </div>

    <div class="flex min-h-screen backdrop-blur-xl bg-slate-900/30">
        <!-- Sidebar -->
        <aside class="hidden lg:flex lg:w-72 flex-col border-r border-white/10 bg-slate-900/40">
            <div class="px-8 pt-10 pb-6">
                <div class="flex items-center gap-3">
                    <span class="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-indigo-500/20 text-indigo-300">
                        <i data-feather="shield" class="h-6 w-6"></i>
                    </span>
                    <div>
                        <p class="text-xs uppercase tracking-[0.35em] text-slate-400">Console</p>
                        <h1 class="text-xl font-semibold">HotelManager Pro V2</h1>
                    </div>
                </div>
                <div class="mt-6 rounded-xl border border-white/10 bg-slate-900/60 p-4 text-sm text-slate-300">
                    <div class="flex items-center justify-between">
                        <span>Status plateforme</span>
                        <span id="sidebarStatus" class="flex items-center gap-2 text-emerald-400">
                            <span class="status-dot"></span>
                            <span>En ligne</span>
                        </span>
                    </div>
                    <p class="mt-2 text-xs text-slate-400" id="sidebarStatusDetail">Chargement des métriques...</p>
                </div>
            </div>

            <nav class="flex-1 space-y-1 px-6">
                <button class="nav-pill active" data-target="dashboardSection">
                    <i data-feather="activity"></i>
                    <span>Monitoring</span>
                </button>
                <button class="nav-pill" data-target="hotelsSection">
                    <i data-feather="home"></i>
                    <span>Gestion des hôtels</span>
                </button>
                <button class="nav-pill" data-target="activitySection">
                    <i data-feather="clock"></i>
                    <span>Historique & Audit</span>
                </button>
                <button class="nav-pill" data-target="backupSection">
                    <i data-feather="database"></i>
                    <span>Backup & Restauration</span>
                </button>
            </nav>

            <div class="px-8 pb-8 pt-4 text-xs text-slate-500">
                <p>Version console <span id="versionTag" class="font-medium text-slate-300">v2.1</span></p>
                <p class="mt-1">Temps réel toutes les 30 secondes</p>
            </div>
        </aside>

        <!-- Main content -->
        <main class="flex-1">
            <header class="border-b border-white/10 bg-slate-900/50 px-6 py-6 shadow-lg shadow-indigo-500/5 sm:px-10">
                <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
                    <div>
                        <p class="text-xs uppercase tracking-[0.4em] text-indigo-300">Dashboard Exécutif</p>
                        <h2 class="mt-2 text-3xl font-semibold">Pilotage en temps réel</h2>
                        <p class="mt-2 max-w-2xl text-sm text-slate-400">
                            Surveillez l'état du système, créez des hôtels en toute sécurité et suivez les activités clés grâce à une expérience premium.
                        </p>
                    </div>
                    <div class="flex flex-col gap-3 rounded-2xl border border-white/10 bg-slate-900/60 p-4 text-sm text-slate-300 md:flex-row md:items-center md:gap-6">
                        <label class="flex flex-col text-xs uppercase tracking-[0.2em] text-slate-400">
                            API Backend
                            <input id="apiEndpoint" type="url" class="mt-2 w-64 rounded-lg border border-white/10 bg-white/5 px-3 py-2 text-sm text-white placeholder:text-slate-500 focus:border-indigo-500 focus:outline-none" placeholder="https://api.hotelmanager.fr" />
                        </label>
                        <button id="refreshNow" class="inline-flex items-center justify-center gap-2 rounded-xl bg-indigo-500 px-4 py-2 text-sm font-medium text-white shadow-lg shadow-indigo-500/30 transition hover:bg-indigo-400">
                            <i data-feather="refresh-ccw" class="h-4 w-4"></i>
                            Rafraîchir maintenant
                        </button>
                    </div>
                </div>
            </header>

            <section id="dashboardSection" class="section visible">
                <div class="grid gap-6 px-6 py-8 sm:px-10">
                    <div class="grid gap-6 lg:grid-cols-4">
                        <div class="glass-card stats-card" data-stat="activeHotels">
                            <div class="flex items-center justify-between">
                                <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Hôtels actifs</p>
                                <span class="icon-badge bg-indigo-500/20 text-indigo-300">
                                    <i data-feather="map-pin"></i>
                                </span>
                            </div>
                            <div class="mt-4 text-3xl font-semibold" id="activeHotelsValue">0</div>
                            <p class="mt-2 text-xs text-slate-400" id="activeHotelsSubtitle">Chargement...</p>
                        </div>
                        <div class="glass-card stats-card" data-stat="totalHotels">
                            <div class="flex items-center justify-between">
                                <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Total hôtels</p>
                                <span class="icon-badge bg-emerald-500/20 text-emerald-300">
                                    <i data-feather="layers"></i>
                                </span>
                            </div>
                            <div class="mt-4 text-3xl font-semibold" id="totalHotelsValue">0</div>
                            <p class="mt-2 text-xs text-slate-400">Inclut les hôtels désactivés</p>
                        </div>
                        <div class="glass-card stats-card" data-stat="latency">
                            <div class="flex items-center justify-between">
                                <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Latence API</p>
                                <span class="icon-badge bg-sky-500/20 text-sky-300">
                                    <i data-feather="activity"></i>
                                </span>
                            </div>
                            <div class="mt-4 text-3xl font-semibold" id="latencyValue">0 ms</div>
                            <p class="mt-2 text-xs text-slate-400">Monitoring temps réel</p>
                        </div>
                        <div class="glass-card stats-card" data-stat="storage">
                            <div class="flex items-center justify-between">
                                <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Stockage</p>
                                <span class="icon-badge bg-amber-500/20 text-amber-300">
                                    <i data-feather="database"></i>
                                </span>
                            </div>
                            <div class="mt-4 text-3xl font-semibold" id="storageValue">0</div>
                            <p class="mt-2 text-xs text-slate-400" id="storageSubtitle">Fichiers JSON</p>
                        </div>
                    </div>

                    <div class="grid gap-6 xl:grid-cols-3">
                        <div class="glass-card xl:col-span-2">
                            <div class="flex flex-wrap items-center justify-between gap-4">
                                <div>
                                    <h3 class="text-lg font-semibold">Performance API & santé système</h3>
                                    <p class="text-sm text-slate-400">Mise à jour automatique toutes les 30 secondes</p>
                                </div>
                                <span id="healthBadge" class="status-pill bg-emerald-500/15 text-emerald-300">Système opérationnel</span>
                            </div>
                            <canvas id="latencyChart" class="mt-6 h-64"></canvas>
                        </div>
                        <div class="glass-card">
                            <h3 class="text-lg font-semibold">État en direct</h3>
                            <div class="mt-6 space-y-4 text-sm text-slate-300" id="systemIndicators">
                                <div class="flex items-center justify-between">
                                    <span class="flex items-center gap-2"><span class="dot dot-success"></span>API</span>
                                    <span id="apiStatus">En cours...</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="flex items-center gap-2"><span class="dot dot-success"></span>Base de données</span>
                                    <span id="dbStatus">En cours...</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="flex items-center gap-2"><span class="dot dot-success"></span>Fichiers</span>
                                    <span id="storageStatus">Analyse...</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="flex items-center gap-2"><span class="dot dot-success"></span>Activités</span>
                                    <span id="activityStatus">Chargement...</span>
                                </div>
                            </div>
                            <div class="mt-6 rounded-xl border border-white/10 bg-slate-900/60 p-4 text-xs text-slate-400">
                                <p class="font-medium text-slate-200">Dernière synchronisation</p>
                                <p id="lastSync" class="mt-1 text-slate-300">—</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="hotelsSection" class="section hidden px-6 py-8 sm:px-10">
                <div class="grid gap-6 lg:grid-cols-[minmax(0,_1fr)_420px]">
                    <div class="space-y-6">
                        <div class="glass-card">
                            <div class="flex flex-wrap items-center justify-between gap-3">
                                <div>
                                    <h3 class="text-lg font-semibold">Créer un nouvel hôtel</h3>
                                    <p class="text-sm text-slate-400">Validation instantanée et journalisation automatique</p>
                                </div>
                                <span class="badge badge-info">Sécurisé</span>
                            </div>
                            <form id="createHotelForm" class="mt-6 space-y-4">
                                <div>
                                    <label for="hotelId" class="text-xs uppercase tracking-[0.3em] text-slate-400">Identifiant</label>
                                    <input id="hotelId" name="hotelId" type="text" class="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-white placeholder:text-slate-500 focus:border-indigo-500 focus:outline-none" placeholder="ex: hotel-paris-centre" autocomplete="off" required />
                                    <p id="hotelIdHelper" class="mt-2 text-xs text-slate-400">3 à 64 caractères, minuscules, chiffres et tirets uniquement.</p>
                                </div>
                                <div>
                                    <label for="hotelName" class="text-xs uppercase tracking-[0.3em] text-slate-400">Nom officiel</label>
                                    <input id="hotelName" name="hotelName" type="text" class="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-white placeholder:text-slate-500 focus:border-indigo-500 focus:outline-none" placeholder="Hôtel Paris Centre" />
                                </div>
                                <button type="submit" class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-indigo-500 px-4 py-3 text-sm font-semibold text-white shadow-lg shadow-indigo-500/25 transition hover:bg-indigo-400 disabled:pointer-events-none disabled:opacity-40">
                                    <i data-feather="plus" class="h-4 w-4"></i>
                                    Créer et journaliser
                                </button>
                            </form>
                        </div>

                        <div class="glass-card">
                            <div class="flex flex-wrap items-center justify-between gap-3">
                                <h3 class="text-lg font-semibold">Inventaire des hôtels</h3>
                                <div class="flex items-center gap-3 text-xs text-slate-400">
                                    <label class="inline-flex items-center gap-2">
                                        <input id="includeInactive" type="checkbox" class="rounded border-white/20 bg-transparent text-indigo-500 focus:ring-indigo-400" />
                                        Inclure les désactivés
                                    </label>
                                </div>
                            </div>
                            <div class="mt-4 overflow-hidden rounded-xl border border-white/10">
                                <table class="min-w-full divide-y divide-white/5 text-sm">
                                    <thead class="bg-white/5 text-left text-xs uppercase tracking-[0.3em] text-slate-400">
                                        <tr>
                                            <th class="px-4 py-3">Hôtel</th>
                                            <th class="px-4 py-3">Nom</th>
                                            <th class="px-4 py-3">Statut</th>
                                            <th class="px-4 py-3">Créé le</th>
                                            <th class="px-4 py-3 text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="hotelTable" class="divide-y divide-white/5"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="glass-card">
                            <h3 class="text-lg font-semibold">Actions rapides</h3>
                            <div class="mt-4 space-y-3 text-sm text-slate-300">
                                <button id="btnRefreshHotels" class="quick-action">
                                    <i data-feather="refresh-cw"></i>
                                    Actualiser les hôtels
                                </button>
                                <button id="btnOpenUpload" class="quick-action">
                                    <i data-feather="upload"></i>
                                    Ouvrir le module d'import (Excel / JSON)
                                </button>
                                <button id="btnPlanBackup" class="quick-action">
                                    <i data-feather="calendar"></i>
                                    Planifier une sauvegarde complète
                                </button>
                            </div>
                        </div>

                        <div class="glass-card">
                            <h3 class="text-lg font-semibold">Dernières activités</h3>
                            <ul id="hotelActivity" class="mt-4 space-y-3 text-xs text-slate-400"></ul>
                        </div>
                    </div>
                </div>
            </section>

            <section id="activitySection" class="section hidden px-6 py-8 sm:px-10">
                <div class="glass-card">
                    <div class="flex flex-wrap items-center justify-between gap-3">
                        <div>
                            <h3 class="text-lg font-semibold">Historique complet</h3>
                            <p class="text-sm text-slate-400">Audit trail temps réel avec détails contextuels</p>
                        </div>
                        <span class="badge badge-success" id="activityCount">0 entrées</span>
                    </div>
                    <div class="mt-6 space-y-6" id="activityTimeline"></div>
                </div>
            </section>

            <section id="backupSection" class="section hidden px-6 py-8 sm:px-10">
                <div class="grid gap-6 lg:grid-cols-2">
                    <div class="glass-card">
                        <h3 class="text-lg font-semibold">Sauvegardes intelligentes</h3>
                        <p class="mt-2 text-sm text-slate-400">Exécutez des sauvegardes incrémentales et conservez l'historique complet.</p>
                        <div class="mt-6 space-y-4 text-sm text-slate-300">
                            <button id="backupNow" class="quick-action">
                                <i data-feather="download"></i>
                                Sauvegarder immédiatement les configurations
                            </button>
                            <button id="backupData" class="quick-action">
                                <i data-feather="package"></i>
                                Exporter les données (JSON + Config)
                            </button>
                        </div>
                        <p class="mt-6 text-xs text-slate-500">Les sauvegardes sont stockées de manière sécurisée côté serveur via les pipelines DevOps.</p>
                    </div>
                    <div class="glass-card">
                        <h3 class="text-lg font-semibold">Restauration contrôlée</h3>
                        <form id="restoreForm" class="mt-4 space-y-4 text-sm">
                            <div>
                                <label class="text-xs uppercase tracking-[0.3em] text-slate-400">Source de restauration</label>
                                <input type="text" id="restoreKey" placeholder="backup_2024-10-24T18-30" class="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-white placeholder:text-slate-500 focus:border-indigo-500 focus:outline-none" />
                            </div>
                            <div>
                                <label class="text-xs uppercase tracking-[0.3em] text-slate-400">Notes internes</label>
                                <textarea id="restoreNotes" rows="3" class="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-white placeholder:text-slate-500 focus:border-indigo-500 focus:outline-none" placeholder="Décrire le contexte de restauration"></textarea>
                            </div>
                            <button type="submit" class="inline-flex items-center justify-center gap-2 rounded-xl bg-amber-500/80 px-4 py-3 text-sm font-semibold text-amber-950 transition hover:bg-amber-400">
                                <i data-feather="rotate-ccw" class="h-4 w-4"></i>
                                Lancer la restauration contrôlée
                            </button>
                        </form>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Import Module Modal -->
    <div id="importModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="glass-card w-full max-w-lg p-6">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold">Importer des données (Excel / JSON)</h3>
                <button id="btnCloseImportModal" class="text-slate-400 hover:text-white">
                    <i data-feather="x" class="h-5 w-5"></i>
                </button>
            </div>
            <p class="mt-2 text-sm text-slate-400">Sélectionnez un fichier Excel (.xlsx) ou JSON (.json) à importer.</p>

            <div class="mt-6 space-y-4">
                <div>
                    <label for="hotelSelectDropdown" class="text-xs uppercase tracking-[0.3em] text-slate-400">Sélectionner un hôtel</label>
                    <select id="hotelSelectDropdown" class="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-white focus:border-indigo-500 focus:outline-none"></select>
                </div>
                <div>
                    <label for="fileInput" class="sr-only">Sélectionner un fichier</label>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.json" class="block w-full text-sm text-slate-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-indigo-500/20 file:text-indigo-300
                        hover:file:bg-indigo-500/30" />
                </div>
                <button id="btnUploadFile" class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-emerald-500 px-4 py-3 text-sm font-semibold text-white shadow-lg shadow-emerald-500/25 transition hover:bg-emerald-400 disabled:pointer-events-none disabled:opacity-40">
                    <i data-feather="upload-cloud" class="h-4 w-4"></i>
                    Importer le fichier
                </button>
            </div>
            <div id="uploadStatus" class="mt-4 text-sm text-slate-400 hidden"></div>
        </div>
    </div>

    <div id="toastContainer" class="pointer-events-none fixed top-6 right-6 z-50 flex w-96 flex-col gap-3"></div>

    <template id="activityItemTemplate">
        <article class="relative rounded-2xl border border-white/10 bg-slate-900/60 p-5 text-sm text-slate-300">
            <span class="absolute -left-4 top-6 h-2 w-2 rounded-full bg-indigo-400"></span>
            <div class="flex flex-wrap items-center justify-between gap-3">
                <div class="flex items-center gap-2 text-xs uppercase tracking-[0.3em] text-indigo-300">
                    <i data-feather="zap" class="h-3 w-3"></i>
                    <span data-field="type">activity.type</span>
                </div>
                <span class="rounded-full bg-white/5 px-3 py-1 text-xs text-slate-400" data-field="created_at">—</span>
            </div>
            <p class="mt-3 text-base font-medium text-white" data-field="description"></p>
            <p class="mt-2 text-xs text-slate-400" data-field="details"></p>
            <p class="mt-2 text-[11px] text-slate-500" data-field="performed_by"></p>
        </article>
    </template>

    <script>
        const STORAGE_KEY = 'hmpro.apiBase';
        const defaultApiBase = localStorage.getItem(STORAGE_KEY) || 'http://localhost:8080';
        const apiInput = document.getElementById('apiEndpoint');
        apiInput.value = defaultApiBase;

        const sections = document.querySelectorAll('.section');
        const navPills = document.querySelectorAll('.nav-pill');
        navPills.forEach((pill) => {
            pill.addEventListener('click', () => {
                navPills.forEach((p) => p.classList.remove('active'));
                pill.classList.add('active');
                const target = pill.dataset.target;
                sections.forEach((section) => {
                    section.classList.toggle('hidden', section.id !== target);
                    section.classList.toggle('visible', section.id === target);
                });
            });
        });

        apiInput.addEventListener('change', () => {
            const value = apiInput.value.trim();
            if (value) {
                localStorage.setItem(STORAGE_KEY, value);
                showToast("Endpoint API mis à jour", 'success');
                triggerFullRefresh();
            }
        });

        const showToast = (message, type = 'info') => {
            const colors = {
                success: 'border-emerald-400/40 bg-emerald-500/10 text-emerald-200',
                error: 'border-rose-400/40 bg-rose-500/10 text-rose-200',
                warning: 'border-amber-400/40 bg-amber-500/10 text-amber-200',
                info: 'border-sky-400/40 bg-sky-500/10 text-sky-200',
            };
            const toast = document.createElement('div');
            toast.className = `pointer-events-auto rounded-2xl border px-4 py-3 text-sm shadow-2xl backdrop-blur ${colors[type] || colors.info}`;
            toast.innerHTML = `<div class="flex items-center gap-3"><i data-feather="bell" class="h-4 w-4"></i><span>${message}</span></div>`;
            document.getElementById('toastContainer').appendChild(toast);
            feather.replace({ class: 'h-4 w-4' });
            setTimeout(() => toast.classList.add('opacity-0'), 4600);
            setTimeout(() => toast.remove(), 5200);
        };

        const animateNumber = (element, target) => {
            const start = Number(element.dataset.value || 0);
            const duration = 450;
            const startTime = performance.now();

            const step = (now) => {
                const progress = Math.min((now - startTime) / duration, 1);
                const value = Math.floor(start + (target - start) * progress);
                element.textContent = target >= 1000 ? value.toLocaleString('fr-FR') : value;
                if (progress < 1) requestAnimationFrame(step); else element.dataset.value = target;
            };
            requestAnimationFrame(step);
        };

        const state = {
            latencySeries: [],
            latencyChart: null,
        };

        const buildLatencyChart = () => {
            const ctx = document.getElementById('latencyChart');
            if (!ctx) return;
            state.latencyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Latence API (ms)',
                            data: [],
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.25)',
                            fill: true,
                            tension: 0.35,
                            pointRadius: 0,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'minute', tooltipFormat: 'HH:mm:ss' },
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.08)' },
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.08)' },
                        },
                    },
                    plugins: {
                        legend: { labels: { color: '#cbd5f5' } },
                    },
                    height: 256, // Explicitly set height to override problematic dynamic calculation
                },
            });
        };

        const formatBytes = (bytes) => {
            if (!bytes) return '0 Ko';
            const units = ['Octets', 'Ko', 'Mo', 'Go'];
            let size = bytes;
            let unitIndex = 0;
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex += 1;
            }
            return `${size.toFixed(1)} ${units[unitIndex]}`;
        };

        const formatDate = (iso) => {
            if (!iso) return '—';
            try {
                return new Date(iso).toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' });
            } catch (err) {
                return iso;
            }
        };

        const fetchJSON = async (path, options = {}) => {
            const base = (localStorage.getItem(STORAGE_KEY) || defaultApiBase).replace(/\/$/, '');
            const response = await fetch(`${base}${path}`, options);
            if (!response.ok) {
                const payload = await response.json().catch(() => ({}));
                const error = new Error(payload.detail || 'Erreur API');
                error.status = response.status;
                throw error;
            }
            return response.json();
        };

        const loadMonitoring = async () => {
            try {
                const [health, activity] = await Promise.all([
                    fetchJSON('/monitor/health'),
                    fetchJSON('/activity?limit=6'),
                ]);

                const metrics = health.metrics || {};
                animateNumber(document.getElementById('activeHotelsValue'), metrics.active_hotels || 0);
                animateNumber(document.getElementById('totalHotelsValue'), metrics.total_hotels || 0);
                document.getElementById('latencyValue').textContent = `${Math.round(health.latency_ms || 0)} ms`;
                document.getElementById('storageValue').textContent = `${health.storage?.files || 0} fichiers`;
                document.getElementById('storageSubtitle').textContent = formatBytes(health.storage?.bytes || 0);

                document.getElementById('apiStatus').textContent = health.status === 'ok' ? 'Opérationnelle' : 'Dégradée';
                document.getElementById('dbStatus').textContent = health.database === 'healthy' ? 'Connexion OK' : 'Problème';
                document.getElementById('storageStatus').textContent = `${health.storage?.files || 0} fichiers`;
                document.getElementById('activityStatus').textContent = `${metrics.recent_activity?.length || 0} événements récents`;
                document.getElementById('lastSync').textContent = formatDate(health.generated_at || health.timestamp);

                document.getElementById('sidebarStatusDetail').textContent = `Actifs: ${metrics.active_hotels || 0} / Total: ${metrics.total_hotels || 0}`;
                updateStatusBadge(health.status);

                const points = state.latencySeries;
                let currentLatency = health.latency_ms;
                if (typeof currentLatency !== 'number' || isNaN(currentLatency)) {
                    currentLatency = 0; // Default to 0 if not a valid number
                }
                // Cap latency to prevent extreme Y-axis scaling
                if (currentLatency > 1000) { // Cap at 1000ms (1 second)
                    currentLatency = 1000;
                }
                points.push({ x: new Date(), y: currentLatency });
                if (points.length > 30) points.shift();
                if (state.latencyChart) {
                    state.latencyChart.data.datasets[0].data = points;
                    state.latencyChart.update('none');
                }

                renderActivity(activity);
            } catch (error) {
                showToast(error.message, 'error');
                updateStatusBadge('error');
            }
        };

        const loadHotels = async () => {
            try {
                const includeInactive = document.getElementById('includeInactive').checked;
                const hotels = await fetchJSON(`/hotels?include_inactive=${includeInactive}`);
                const tbody = document.getElementById('hotelTable');
                tbody.innerHTML = '';
                hotels.forEach((hotel) => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-white/5 transition';
                    tr.innerHTML = `
                        <td class="px-4 py-3 font-medium text-white">${hotel.hotel_id}</td>
                        <td class="px-4 py-3 text-slate-300">${hotel.name || '<span class="text-slate-500">—</span>'}</td>
                        <td class="px-4 py-3">
                            <span class="status-pill ${hotel.is_active ? 'bg-emerald-500/15 text-emerald-300' : 'bg-amber-500/15 text-amber-300'}">
                                ${hotel.is_active ? 'Actif' : 'Désactivé'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-slate-400">${formatDate(hotel.created_at)}</td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex justify-end gap-2">
                                <button class="table-action" data-action="toggle" data-id="${hotel.hotel_id}" data-active="${hotel.is_active}">
                                    <i data-feather="${hotel.is_active ? 'pause' : 'play'}"></i>
                                </button>
                                <button class="table-action" data-action="simulate" data-id="${hotel.hotel_id}">
                                    <i data-feather="trending-up"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                feather.replace({ class: 'h-4 w-4' });
            } catch (error) {
                showToast(error.message, 'error');
            }
        };

        const renderActivity = (logs) => {
            const container = document.getElementById('activityTimeline');
            const sideList = document.getElementById('hotelActivity');
            container.innerHTML = '';
            sideList.innerHTML = '';
            logs.forEach((log) => {
                const template = document.getElementById('activityItemTemplate').content.cloneNode(true);
                template.querySelector('[data-field="type"]').textContent = log.activity_type;
                template.querySelector('[data-field="created_at"]').textContent = formatDate(log.created_at);
                template.querySelector('[data-field="description"]').textContent = log.description;
                template.querySelector('[data-field="performed_by"]').textContent = `Par ${log.performed_by || 'système'}${log.hotel_id ? ` • ${log.hotel_id}` : ''}`;
                const details = log.details && Object.keys(log.details).length ? JSON.stringify(log.details, null, 2) : '—';
                template.querySelector('[data-field="details"]').textContent = details;
                container.appendChild(template);

                const item = document.createElement('li');
                item.innerHTML = `<span class="font-medium text-white">${log.description}</span><br><span class="text-slate-500">${formatDate(log.created_at)}</span>`;
                sideList.appendChild(item);
            });
            document.getElementById('activityCount').textContent = `${logs.length} entrées`;
            feather.replace({ class: 'h-3 w-3' });
        };

        const updateStatusBadge = (status) => {
            const badge = document.getElementById('healthBadge');
            const sidebarStatus = document.getElementById('sidebarStatus');
            const dot = sidebarStatus.querySelector('.status-dot');
            switch (status) {
                case 'ok':
                    badge.textContent = 'Système opérationnel';
                    badge.className = 'status-pill bg-emerald-500/15 text-emerald-300';
                    sidebarStatus.className = 'flex items-center gap-2 text-emerald-400';
                    dot.className = 'status-dot';
                    break;
                case 'degraded':
                    badge.textContent = 'Système dégradé';
                    badge.className = 'status-pill bg-amber-500/15 text-amber-300';
                    sidebarStatus.className = 'flex items-center gap-2 text-amber-300';
                    dot.className = 'status-dot warning';
                    break;
                default:
                    badge.textContent = 'Système indisponible';
                    badge.className = 'status-pill bg-rose-500/15 text-rose-300';
                    sidebarStatus.className = 'flex items-center gap-2 text-rose-300';
                    dot.className = 'status-dot error';
            }
        };

        document.getElementById('refreshNow').addEventListener('click', () => {
            showToast('Rafraîchissement forcé...', 'info');
            triggerFullRefresh();
        });

        const triggerFullRefresh = () => {
            loadMonitoring();
            loadHotels();
        };

        document.getElementById('includeInactive').addEventListener('change', loadHotels);

        document.getElementById('hotelTable').addEventListener('click', async (event) => {
            const button = event.target.closest('button[data-action]');
            if (!button) return;
            const hotelId = button.dataset.id;
            if (button.dataset.action === 'toggle') {
                const isActive = button.dataset.active === 'true';
                try {
                    if (isActive) {
                        await fetchJSON(`/hotels/${hotelId}?actor=admin-ui`, { method: 'DELETE' });
                        showToast(`Hôtel ${hotelId} désactivé`, 'warning');
                    } else {
                        await fetchJSON(`/hotels?actor=admin-ui`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ hotel_id: hotelId }),
                        });
                        showToast(`Hôtel ${hotelId} réactivé`, 'success');
                    }
                    loadHotels();
                    loadMonitoring();
                } catch (error) {
                    showToast(error.message, 'error');
                }
            }
            if (button.dataset.action === 'simulate') {
                showToast(`Simulation avancée en préparation pour ${hotelId}`, 'info');
            }
        });

        document.getElementById('createHotelForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const hotelId = event.target.hotelId.value.trim();
            const hotelName = event.target.hotelName.value.trim();
            if (!/^[a-z0-9-]{3,64}$/.test(hotelId)) {
                showToast("ID invalide. Utilisez uniquement minuscules, chiffres et tirets.", 'warning');
                return;
            }
            try {
                await fetchJSON('/hotels?actor=admin-ui', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hotel_id: hotelId, name: hotelName }),
                });
                showToast('Hôtel créé avec succès', 'success');
                event.target.reset();
                loadHotels();
                loadMonitoring();
            } catch (error) {
                showToast(error.message, 'error');
            }
        });

        document.getElementById('hotelId').addEventListener('input', (event) => {
            const value = event.target.value.trim();
            const helper = document.getElementById('hotelIdHelper');
            if (!value) {
                helper.textContent = '3 à 64 caractères, minuscules, chiffres et tirets uniquement.';
                helper.className = 'mt-2 text-xs text-slate-400';
                return;
            }
            if (/^[a-z0-9-]{3,64}$/.test(value)) {
                helper.textContent = 'Identifiant valide et disponible.';
                helper.className = 'mt-2 text-xs text-emerald-300';
            } else {
                helper.textContent = 'Format incorrect. Exemple: hotel-paris-centre';
                helper.className = 'mt-2 text-xs text-amber-300';
            }
        });

        document.getElementById('btnRefreshHotels').addEventListener('click', () => {
            loadHotels();
            showToast('Inventaire des hôtels rafraîchi', 'info');
        });

        const populateHotelDropdown = async () => {
            const dropdown = document.getElementById('hotelSelectDropdown');
            dropdown.innerHTML = '<option value="">Chargement des hôtels...</option>';
            try {
                const hotels = await fetchJSON('/hotels');
                dropdown.innerHTML = ''; // Clear loading message
                if (hotels.length === 0) {
                    dropdown.innerHTML = '<option value="">Aucun hôtel enregistré</option>';
                    dropdown.disabled = true;
                } else {
                    dropdown.disabled = false;
                    dropdown.innerHTML = '<option value="">-- Sélectionner un hôtel --</option>';
                    hotels.forEach(hotel => {
                        const option = document.createElement('option');
                        option.value = hotel.hotel_id;
                        option.textContent = `${hotel.name || hotel.hotel_id} (${hotel.hotel_id})`;
                        dropdown.appendChild(option);
                    });
                }
            } catch (error) {
                showToast(`Erreur lors du chargement des hôtels: ${error.message}`, 'error');
                dropdown.innerHTML = '<option value="">Erreur de chargement</option>';
                dropdown.disabled = true;
            }
        };

        document.getElementById('btnOpenUpload').addEventListener('click', () => {
            const importModal = document.getElementById('importModal');
            importModal.classList.remove('hidden');
            importModal.classList.add('flex');
            populateHotelDropdown(); // Populate dropdown when modal opens
            feather.replace(); // Render new icons in the modal
        });

        document.getElementById('btnCloseImportModal').addEventListener('click', () => {
            const importModal = document.getElementById('importModal');
            importModal.classList.add('hidden');
            importModal.classList.remove('flex');
            document.getElementById('fileInput').value = ''; // Clear selected file
            document.getElementById('uploadStatus').textContent = ''; // Clear status
            document.getElementById('uploadStatus').classList.add('hidden');
        });

        document.getElementById('btnUploadFile').addEventListener('click', async () => {
            const fileInput = document.getElementById('fileInput');
            const uploadStatus = document.getElementById('uploadStatus');
            const file = fileInput.files[0];

            uploadStatus.classList.remove('hidden');
            uploadStatus.className = 'mt-4 text-sm text-slate-400'; // Reset status styling

            if (!file) {
                uploadStatus.textContent = 'Veuillez sélectionner un fichier.';
                uploadStatus.classList.add('text-amber-300');
                return;
            }

            const allowedExtensions = ['.xlsx', '.xls', '.json'];
            const fileExtension = '.' + file.name.split('.').pop();
            if (!allowedExtensions.includes(fileExtension)) {
                uploadStatus.textContent = 'Type de fichier non supporté. Veuillez choisir un fichier Excel (.xlsx, .xls) ou JSON (.json).';
                uploadStatus.classList.add('text-rose-300');
                return;
            }

            uploadStatus.textContent = `Importation de "${file.name}"...`;
            uploadStatus.classList.add('text-sky-300');

            const formData = new FormData();
            formData.append('file', file);

            const hotelId = document.getElementById('hotelSelectDropdown').value.trim();
            if (!hotelId) {
                uploadStatus.textContent = 'Veuillez sélectionner un hôtel.';
                uploadStatus.classList.add('text-amber-300');
                return;
            }

            try {
                const response = await fetchJSON(`/upload/data?hotel_id=${encodeURIComponent(hotelId)}`, {
                    method: 'POST',
                    body: formData,
                    // Do NOT set Content-Type header for FormData, browser sets it automatically with boundary
                });

                if (response.message) {
                    showToast(response.message, 'success');
                    uploadStatus.textContent = `Fichier "${file.name}" importé avec succès.`;
                    uploadStatus.classList.add('text-emerald-300');
                    document.getElementById('btnCloseImportModal').click(); // Close modal on success
                    triggerFullRefresh(); // Refresh data after upload
                } else {
                    throw new Error('Réponse inattendue du serveur.');
                }
            } catch (error) {
                showToast(error.message, 'error');
                uploadStatus.textContent = `Échec de l'importation : ${error.message}`;
                uploadStatus.classList.add('text-rose-300');
            }
        });

        document.getElementById('btnPlanBackup').addEventListener('click', () => {
            showToast('Sauvegarde planifiée pour la nuit prochaine', 'success');
        });

        document.getElementById('backupNow').addEventListener('click', () => {
            showToast('Sauvegarde complète démarrée', 'success');
        });

        document.getElementById('backupData').addEventListener('click', () => {
            showToast('Export des données planifié', 'info');
        });

        document.getElementById('restoreForm').addEventListener('submit', (event) => {
            event.preventDefault();
            const key = document.getElementById('restoreKey').value.trim();
            if (!key) {
                showToast('Identifiant de sauvegarde requis', 'warning');
                return;
            }
            showToast(`Restauration ${key} en file d'attente`, 'success');
        });

        const init = () => {
            buildLatencyChart();
            triggerFullRefresh();
            setInterval(triggerFullRefresh, 30000);
            feather.replace();
        };

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
