<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hotel RM ‚Ä¢ Admin</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Palette & font
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bg: "#0b1220",
            card: "#121a2b",
            border: "#1d2740",
            text: "#ecf1f6",
            muted: "#9aa4b6",
            accent: "#facc15",   // dor√©
            success: "#6ee7b7",
            danger: "#ef4444",
            info: "#60a5fa"
          },
          boxShadow: {
            card: "0 10px 25px rgba(0,0,0,.35)"
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .glass { background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); }
    .scroll-slim::-webkit-scrollbar{height:8px;width:8px}
    .scroll-slim::-webkit-scrollbar-thumb{background:#223054;border-radius:999px}
    .dot { width:10px; height:10px; border-radius:999px; display:inline-block; }
  </style>
</head>
<body class="bg-bg text-text">

  <!-- Layout -->
  <div class="min-h-screen flex">
    <!-- Sidebar -->
    <aside class="w-72 border-r border-border bg-[linear-gradient(180deg,#0b1220,#0b1220)]">
      <div class="px-6 py-5 flex items-center gap-3">
        <div class="w-8 h-8 rounded-xl bg-accent/20 border border-accent/40 flex items-center justify-center">
          <span class="text-accent font-semibold">RM</span>
        </div>
        <div>
          <div class="text-sm text-muted">Admin</div>
          <div class="font-semibold">Hotel RM App</div>
        </div>
      </div>
      <nav class="px-2 pt-2 space-y-1">
        <button data-tab="dashboard" class="tab-btn w-full text-left px-4 py-3 rounded-xl hover:bg-card/70 border border-transparent hover:border-border transition flex items-center gap-2">
          <span>üè†</span><span>Tableaux & Donn√©es</span>
        </button>
        <button data-tab="monitor" class="tab-btn w-full text-left px-4 py-3 rounded-xl hover:bg-card/70 border border-transparent hover:border-border transition flex items-center gap-2">
          <span>ü©∫</span><span>Monitoring & Maintenance</span>
        </button>
        <button data-tab="settings" class="tab-btn w-full text-left px-4 py-3 rounded-xl hover:bg-card/70 border border-transparent hover:border-border transition flex items-center gap-2">
          <span>‚öôÔ∏è</span><span>Param√®tres</span>
        </button>
      </nav>
      <div class="px-4 py-6 text-xs text-muted">
        Version interface: <span class="font-mono">admin-ui 1.0</span>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1">
      <!-- Header -->
      <header class="border-b border-border px-6 py-4 flex items-center gap-3">
        <div class="text-muted">Espace administrateur</div>
        <div class="text-accent">‚Ä¢</div>
        <div id="header-env" class="text-sm text-muted">API: <span class="font-mono" id="header-api-base"></span></div>
        <div class="ml-auto flex items-center gap-3">
          <button id="refresh-all" class="px-3 py-2 text-sm bg-card border border-border rounded-lg hover:bg-card/70">‚ü≥ Rafra√Æchir</button>
          <span id="pill-status" class="text-xs px-2 py-1 rounded-full border border-border text-muted">statut: inconnu</span>
        </div>
      </header>

      <!-- Content -->
      <section class="p-6 space-y-6">
        <!-- DASHBOARD TAB (placeholder) -->
        <div id="tab-dashboard" class="tab hidden">
          <div class="grid grid-cols-1 xl:grid-cols-3 gap-4">
            <div class="glass shadow-card border border-border rounded-2xl p-5">
              <h2 class="font-semibold mb-2">üìä Vue d‚Äôensemble</h2>
              <p class="text-sm text-muted">Ici tu gardes tes composants existants (chargement config, simulation, etc.).</p>
              <div class="mt-4 text-sm text-muted">
                Astuce: tu peux d√©clencher un export rapide pour tester l‚ÄôAPI :
              </div>
              <div class="mt-3 flex gap-2">
                <button id="btn-export-excel-demo" class="px-3 py-2 bg-card border border-border rounded-lg hover:bg-card/70">Export Excel (d√©mo)</button>
                <button id="btn-export-pdf-demo" class="px-3 py-2 bg-card border border-border rounded-lg hover:bg-card/70">Export PDF (d√©mo)</button>
              </div>
            </div>
            <div class="glass shadow-card border border-border rounded-2xl p-5">
              <h2 class="font-semibold mb-2">üè® H√¥tels</h2>
              <div id="hotels-list" class="text-sm text-muted">‚Äî</div>
            </div>
            <div class="glass shadow-card border border-border rounded-2xl p-5">
              <h2 class="font-semibold mb-2">üß† Conseils</h2>
              <ul class="list-disc pl-5 text-sm text-muted space-y-1">
                <li>Surveille `/monitor/health` pour l‚Äôespace disque et les dossiers mont√©s.</li>
                <li>D√©finis <code>ADMIN_TOKEN</code> et teste un backup DB.</li>
                <li>Monte <code>/app/data</code>, <code>/app/backups</code>, <code>/app/logs</code> dans Coolify.</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- MONITOR TAB -->
        <div id="tab-monitor" class="tab hidden">
          <div class="grid grid-cols-1 xl:grid-cols-3 gap-4">
            <!-- Sant√© -->
            <div class="glass shadow-card border border-border rounded-2xl p-5">
              <div class="flex items-center justify-between mb-2">
                <h2 class="font-semibold">ü©∫ Sant√©</h2>
                <button id="btn-refresh-health" class="text-xs px-2 py-1 bg-card border border-border rounded">Rafra√Æchir</button>
              </div>
              <pre id="health-json" class="text-xs text-muted whitespace-pre-wrap leading-relaxed">‚Äî</pre>
            </div>

            <!-- Fichiers -->
            <div class="glass shadow-card border border-border rounded-2xl p-5">
              <div class="flex items-center justify-between mb-3">
                <h2 class="font-semibold">üìÇ Fichiers (DATA_DIR)</h2>
                <button id="btn-refresh-files" class="text-xs px-2 py-1 bg-card border border-border rounded">Rafra√Æchir</button>
              </div>
              <div class="overflow-auto scroll-slim max-h-80">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="text-muted">
                      <th class="text-left py-2 border-b border-border">Nom</th>
                      <th class="text-left py-2 border-b border-border">Taille</th>
                      <th class="text-left py-2 border-b border-border">Modifi√©</th>
                    </tr>
                  </thead>
                  <tbody id="files-tbody"></tbody>
                </table>
              </div>
            </div>

            <!-- Logs -->
            <div class="glass shadow-card border border-border rounded-2xl p-5">
              <div class="flex items-center justify-between mb-2">
                <h2 class="font-semibold">üßæ Logs</h2>
                <div class="flex items-center gap-2">
                  <a id="link-log-file" href="#" target="_blank" class="text-info hover:underline text-sm">ouvrir app.log</a>
                  <button id="btn-refresh-logs" class="text-xs px-2 py-1 bg-card border border-border rounded">Actualiser</button>
                </div>
              </div>
              <pre id="logs-tail" class="text-xs text-muted whitespace-pre-wrap leading-relaxed max-h-64 overflow-auto scroll-slim">‚Äî</pre>
            </div>
          </div>

          <!-- Backup -->
          <div class="glass shadow-card border border-border rounded-2xl p-5">
            <h2 class="font-semibold mb-2">üíæ Backup Base (pg_dump)</h2>
            <div class="flex flex-col sm:flex-row gap-3 items-start">
              <input id="admin-token" type="password" class="px-3 py-2 bg-card border border-border rounded-lg w-full sm:w-80" placeholder="X-Admin-Token">
              <div class="flex gap-2">
                <button id="btn-backup" class="px-3 py-2 bg-accent text-black rounded-lg hover:brightness-105">Lancer un backup</button>
                <button id="btn-backup-open" class="px-3 py-2 bg-card border border-border rounded-lg">Ouvrir dernier backup</button>
              </div>
            </div>
            <div id="backup-result" class="mt-3 text-sm text-muted">‚Äî</div>
          </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="tab-settings" class="tab hidden">
          <div class="glass shadow-card border border-border rounded-2xl p-5">
            <h2 class="font-semibold mb-2">‚öôÔ∏è Param√®tres</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="text-sm text-muted">API Base URL</label>
                <input id="api-base" class="mt-1 w-full px-3 py-2 bg-card border border-border rounded-lg" placeholder="https://api-folkestone.e-hotelmanager.com">
                <p class="text-xs text-muted mt-1">Par d√©faut, l‚ÄôURL est devin√©e depuis le domaine (admin ‚Üí api).</p>
              </div>
              <div>
                <label class="text-sm text-muted">Admin Token (X-Admin-Token)</label>
                <input id="setting-token" type="password" class="mt-1 w-full px-3 py-2 bg-card border border-border rounded-lg" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <p class="text-xs text-muted mt-1">Stock√© localement (localStorage) c√¥t√© navigateur.</p>
              </div>
            </div>
            <div class="mt-4 flex gap-2">
              <button id="btn-save-settings" class="px-3 py-2 bg-accent text-black rounded-lg hover:brightness-105">Enregistrer</button>
              <button id="btn-reset-settings" class="px-3 py-2 bg-card border border-border rounded-lg">R√©initialiser</button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 right-6 px-4 py-3 rounded-xl bg-card border border-border shadow-card text-sm hidden"></div>

  <script>
    // ===== Helpers =====
    const $ = (s, p=document) => p.querySelector(s);
    const $$ = (s, p=document) => [...p.querySelectorAll(s)];
    const fmtSize = n => n<1024? n+' B' : n<1024*1024? (n/1024).toFixed(1)+' KB' : n<1024*1024*1024? (n/1024/1024).toFixed(1)+' MB' : (n/1024/1024/1024).toFixed(1)+' GB';
    const toast = (msg, ok=true) => {
      const el = $('#toast');
      el.textContent = msg;
      el.classList.remove('hidden');
      el.style.borderColor = ok ? '#2dd4bf33' : '#ef444433';
      el.style.boxShadow = ok ? '0 10px 25px rgba(45,212,191,.15)' : '0 10px 25px rgba(239,68,68,.15)';
      setTimeout(()=>el.classList.add('hidden'), 2500);
    };

    // Guess API base from current host (admin ‚Üí api), fallback to same origin
    function defaultApiBase() {
      try {
        const h = window.location.host;
        if (h.startsWith('admin-')) {
          return window.location.protocol + '//' + h.replace('admin-','api-');
        }
        return window.location.origin;
      } catch { return window.location.origin; }
    }

    const LS = {
      get API_BASE(){ return localStorage.getItem('API_BASE') || defaultApiBase(); },
      set API_BASE(v){ localStorage.setItem('API_BASE', v); },
      get ADMIN_TOKEN(){ return localStorage.getItem('ADMIN_TOKEN') || ''; },
      set ADMIN_TOKEN(v){ localStorage.setItem('ADMIN_TOKEN', v); },
      get LAST_BACKUP(){ return localStorage.getItem('LAST_BACKUP') || ''; },
      set LAST_BACKUP(v){ localStorage.setItem('LAST_BACKUP', v); }
    };

    function api(path, opts={}) {
      const base = LS.API_BASE.replace(/\/$/,'');
      return fetch(base + path, opts);
    }

    // ===== Tabs =====
    function showTab(name){
      $$('.tab').forEach(el => el.classList.add('hidden'));
      $('#tab-'+name).classList.remove('hidden');
      $$('.tab-btn').forEach(b => {
        if (b.dataset.tab === name) {
          b.classList.add('bg-card','border','border-border');
        } else {
          b.classList.remove('bg-card','border','border-border');
        }
      });
    }

    // ===== Monitoring actions =====
    async function loadHealth() {
      try {
        const r = await api('/monitor/health');
        const j = await r.json();
        $('#health-json').textContent = JSON.stringify(j, null, 2);
        $('#pill-status').textContent = 'statut: ' + (j.api || 'ok');
        $('#pill-status').className = 'text-xs px-2 py-1 rounded-full border border-border ' + (j.api==='ok'?'text-success':'text-danger');
      } catch (e) {
        $('#health-json').textContent = 'Erreur: ' + e;
        $('#pill-status').textContent = 'statut: erreur';
        $('#pill-status').className = 'text-xs px-2 py-1 rounded-full border border-border text-danger';
      }
    }

    async function loadFiles() {
      const tb = $('#files-tbody'); tb.innerHTML = '';
      try {
        const r = await api('/monitor/files');
        const j = await r.json();
        (j.files || []).forEach(f => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="py-2 border-b border-border">${f.name}</td>
            <td class="py-2 border-b border-border">${fmtSize(f.size_bytes)}</td>
            <td class="py-2 border-b border-border">${f.modified}</td>`;
          tb.appendChild(tr);
        });
      } catch(e) {
        tb.innerHTML = `<tr><td class="py-2 text-danger" colspan="3">Erreur: ${e}</td></tr>`;
      }
    }

    async function tailLogs() {
      try {
        const r = await api('/monitor/logs/tail?lines=200');
        const j = await r.json();
        $('#logs-tail').textContent = (j.content || []).join('\n') || '‚Äî';
      } catch(e) {
        $('#logs-tail').textContent = 'Erreur: ' + e;
      }
    }

    async function doBackup() {
      const token = $('#admin-token').value.trim() || LS.ADMIN_TOKEN;
      if (!token) { toast('Renseigne le token admin dans Param√®tres ou le champ ci-dessus', false); return; }
      try {
        const r = await api('/admin/backup', { method:'POST', headers: { 'X-Admin-Token': token } });
        const j = await r.json();
        if (j.status === 'ok' && j.path) {
          LS.LAST_BACKUP = j.path;
          $('#backup-result').innerHTML = `‚úÖ Backup cr√©√©: <a class="text-success underline" href="${LS.API_BASE.replace(/\/$/,'')}${j.path}" target="_blank">${j.path}</a>`;
          toast('Backup cr√©√© avec succ√®s');
        } else {
          $('#backup-result').textContent = 'Erreur: ' + (j.detail || JSON.stringify(j));
          toast('√âchec du backup', false);
        }
      } catch(e) {
        $('#backup-result').textContent = 'Erreur: ' + e;
        toast('√âchec du backup', false);
      }
    }

    function openLastBackup() {
      const p = LS.LAST_BACKUP;
      if (!p) { toast('Aucun backup enregistr√© pour cette session', false); return; }
      window.open(LS.API_BASE.replace(/\/$/,'') + p, '_blank');
    }

    // ===== Demo exports =====
    async function exportExcelDemo() {
      const payload = {
        title: "Export d√©mo",
        rows: [
          { date: "2025-10-20", hotel: "Folkestone Opera", room: "Double", price: 120, ota: "Booking" },
          { date: "2025-10-20", hotel: "Folkestone Opera", room: "Twin",   price: 130, ota: "Expedia" }
        ],
        summary: { lignes: 2 }
      };
      const r = await api('/export/excel', {
        method:'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!r.ok) { toast('Export Excel: erreur HTTP '+r.status, false); return; }
      const blob = await r.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'export-demo.xlsx';
      a.click();
      URL.revokeObjectURL(a.href);
      toast('Export Excel t√©l√©charg√©');
    }

    async function exportPdfDemo() {
      const payload = {
        title: "Rapport D√©mo",
        rows: [
          { date: "2025-10-20", hotel: "Folkestone Opera", room: "Double", price: 120, ota: "Booking" },
          { date: "2025-10-20", hotel: "Folkestone Opera", room: "Twin",   price: 130, ota: "Expedia" }
        ]
      };
      const r = await api('/export/pdf', {
        method:'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!r.ok) { toast('Export PDF: erreur HTTP '+r.status, false); return; }
      const blob = await r.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'export-demo.pdf';
      a.click();
      URL.revokeObjectURL(a.href);
      toast('Export PDF t√©l√©charg√©');
    }

    // ===== Settings =====
    function loadSettingsUI() {
      $('#api-base').value = LS.API_BASE;
      $('#setting-token').value = LS.ADMIN_TOKEN;
      $('#admin-token').value = LS.ADMIN_TOKEN;
      $('#header-api-base').textContent = LS.API_BASE;
      $('#link-log-file').href = LS.API_BASE.replace(/\/$/,'') + '/logs/app.log';
    }

    function saveSettings() {
      const base = $('#api-base').value.trim() || defaultApiBase();
      const tok = $('#setting-token').value.trim();
      LS.API_BASE = base;
      if (tok) LS.ADMIN_TOKEN = tok;
      $('#admin-token').value = LS.ADMIN_TOKEN;
      loadSettingsUI();
      toast('Param√®tres enregistr√©s');
    }

    function resetSettings() {
      localStorage.removeItem('API_BASE');
      localStorage.removeItem('ADMIN_TOKEN');
      localStorage.removeItem('LAST_BACKUP');
      loadSettingsUI();
      toast('Param√®tres r√©initialis√©s');
    }

    // ===== Hotels demo (optional fetch) =====
    async function loadHotels() {
      try {
        const r = await api('/hotels');
        const j = await r.json();
        $('#hotels-list').innerHTML = (j||[]).map(h => `<span class="inline-block text-xs px-2 py-1 rounded-full border border-border mr-1 mb-1">${h}</span>`).join('') || '‚Äî';
      } catch {
        $('#hotels-list').textContent = '‚Äî';
      }
    }

    // ===== Events & init =====
    document.addEventListener('DOMContentLoaded', () => {
      // Tabs
      $$('.tab-btn').forEach(btn => btn.addEventListener('click', () => showTab(btn.dataset.tab)));
      showTab('monitor'); // ouvrir sur Monitoring par d√©faut
      // Buttons
      $('#refresh-all').addEventListener('click', async ()=>{ await Promise.all([loadHealth(), loadFiles(), tailLogs(), loadHotels()]); toast('Donn√©es rafra√Æchies'); });
      $('#btn-refresh-health').addEventListener('click', loadHealth);
      $('#btn-refresh-files').addEventListener('click', loadFiles);
      $('#btn-refresh-logs').addEventListener('click', tailLogs);
      $('#btn-backup').addEventListener('click', doBackup);
      $('#btn-backup-open').addEventListener('click', openLastBackup);
      $('#btn-save-settings').addEventListener('click', saveSettings);
      $('#btn-reset-settings').addEventListener('click', resetSettings);
      $('#btn-export-excel-demo')?.addEventListener('click', exportExcelDemo);
      $('#btn-export-pdf-demo')?.addEventListener('click', exportPdfDemo);

      // Settings
      loadSettingsUI();
      // Initial loads
      loadHealth(); loadFiles(); tailLogs(); loadHotels();
    });
  </script>
</body>
</html>
