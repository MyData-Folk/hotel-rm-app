<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HotelManager Pro V3.2 - Console Admin</title>
  <link rel="icon" type="image/svg+xml" href="https://cdn.jsdelivr.net/npm/lucide-static@0.263.1/icons/hotel.svg">
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.29.2/dist/feather.min.js"></script>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="flex min-h-screen backdrop-blur-xl bg-slate-900/30">

    <!-- SIDEBAR -->
    <aside class="hidden lg:flex lg:w-72 flex-col border-r border-white/10 bg-slate-900/40">
      <div class="px-8 pt-10 pb-6">
        <div class="flex items-center gap-3">
          <span class="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-indigo-500/20 text-indigo-300">
            <i data-feather="shield" class="h-6 w-6"></i>
          </span>
          <div>
            <p class="text-xs uppercase tracking-[0.35em] text-slate-400">Console</p>
            <h1 class="text-xl font-semibold">HotelManager Pro V3.2</h1>
          </div>
        </div>
      </div>
      <nav class="flex-1 space-y-1 px-6">
        <button class="nav-pill active" data-target="dashboardSection"><i data-feather="activity"></i> Monitoring</button>
        <button class="nav-pill" data-target="hotelsSection"><i data-feather="home"></i> Gestion des hôtels</button>
        <button class="nav-pill" data-target="activitySection"><i data-feather="clock"></i> Historique</button>
        <button class="nav-pill" data-target="backupSection"><i data-feather="database"></i> Backup</button>
      </nav>
    </aside>

    <!-- MAIN -->
    <main class="flex-1">
      <header class="border-b border-white/10 bg-slate-900/50 px-6 py-6 shadow-lg shadow-indigo-500/5 sm:px-10">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-semibold">Console Administrateur</h2>
          <div>
            <label class="text-sm text-slate-400 mr-2">API :</label>
            <input id="apiEndpoint" type="url" value="https://api.hotelmanager.fr"
              class="rounded-md border border-white/10 bg-white/5 px-3 py-1.5 text-sm text-white w-72">
          </div>
        </div>
      </header>

      <!-- DASHBOARD -->
      <section id="dashboardSection" class="section px-6 py-8">
        <div class="grid gap-6">
          <div class="glass-card">
            <h3 class="text-lg font-semibold mb-4">Performance API & santé système</h3>
            <canvas id="latencyChart" class="h-72"></canvas>
          </div>
        </div>
      </section>

      <!-- HOTELS -->
      <section id="hotelsSection" class="section hidden px-6 py-8">
        <div class="grid gap-6 lg:grid-cols-[minmax(0,_1fr)_420px]">
          <div class="space-y-6">

            <!-- INVENTAIRE -->
            <div class="glass-card">
              <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-semibold">Inventaire des hôtels</h3>
                <button id="btnRefreshHotels" class="btn btn-primary text-sm"><i data-feather="refresh-cw"></i> Rafraîchir</button>
              </div>
              <table class="w-full text-sm">
                <thead class="text-slate-400 uppercase text-xs border-b border-white/10">
                  <tr><th class="py-2 text-left">Hôtel</th><th class="text-left">Nom</th><th>Statut</th></tr>
                </thead>
                <tbody id="hotelTable"></tbody>
              </table>
            </div>

            <!-- ACTIONS -->
            <div class="glass-card">
              <h3 class="text-lg font-semibold mb-4">Actions rapides</h3>
              <button id="btnOpenUpload" class="quick-action"><i data-feather="upload"></i> Importer Excel / JSON</button>
              <input type="file" id="fileUploadInput" class="hidden" accept=".xlsx,.json" />
            </div>

            <!-- MODULE FICHIERS EXISTANTS -->
            <div class="glass-card">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold">Fichiers existants de l'hôtel</h3>
                <button id="btnLoadFiles" class="btn btn-primary text-sm"><i data-feather="folder"></i> Charger</button>
              </div>
              <select id="selectedHotelFiles" class="mt-4 w-full bg-white/5 border border-white/10 rounded-md text-sm text-white p-2"></select>
              <div id="fileList" class="mt-4 space-y-2 text-sm text-slate-300">
                <p class="text-slate-500">Aucun fichier à afficher.</p>
              </div>
            </div>

          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="toastContainer" class="fixed top-6 right-6 z-50 flex flex-col gap-3"></div>

  <script>
    const STORAGE_KEY = 'hmpro.apiBase';
    const defaultApiBase = 'https://api.hotelmanager.fr';
    const apiInput = document.getElementById('apiEndpoint');
    apiInput.value = localStorage.getItem(STORAGE_KEY) || defaultApiBase;
    apiInput.addEventListener('change', () => localStorage.setItem(STORAGE_KEY, apiInput.value));
    const apiBase = () => (localStorage.getItem(STORAGE_KEY) || apiInput.value).replace(/\/$/, '');

    const showToast = (msg, type = 'info') => {
      const colors = { success: 'bg-emerald-600/20 text-emerald-200', error: 'bg-rose-600/20 text-rose-200', info: 'bg-sky-600/20 text-sky-200' };
      const div = document.createElement('div');
      div.className = `rounded-lg px-4 py-2 text-sm border border-white/10 shadow-lg ${colors[type]}`;
      div.textContent = msg;
      document.getElementById('toastContainer').appendChild(div);
      setTimeout(() => div.remove(), 4000);
    };

    const fetchJSON = async (url, opt = {}) => {
      const res = await fetch(apiBase() + url, opt);
      if (!res.ok) throw new Error((await res.json()).detail || res.statusText);
      return res.json();
    };

    // MONITORING GRAPH
    const ctx = document.getElementById('latencyChart').getContext('2d');
    const latencyChart = new Chart(ctx, {
      type: 'line',
      data: { datasets: [{ label: 'Latence API (ms)', data: [], borderColor: '#4f46e5', backgroundColor: 'rgba(79,70,229,0.25)', fill: true, tension: 0.3 }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { type: 'time', time: { unit: 'minute' }, grid: { color: 'rgba(255,255,255,0.05)' } },
          y: { beginAtZero: true, min: 0, suggestedMax: 3000, grid: { color: 'rgba(255,255,255,0.05)' } }
        },
        plugins: { legend: { labels: { color: '#cbd5f5' } } }
      }
    });

    async function refreshMonitoring() {
      try {
        const health = await fetchJSON('/health');
        const latency = Number.isFinite(health.latency_ms) ? Math.max(0, health.latency_ms) : 0;
        const dataset = latencyChart.data.datasets[0].data;
        dataset.push({ x: new Date(), y: latency });
        if (dataset.length > 20) dataset.shift();
        latencyChart.update();
      } catch (err) {
        showToast('Erreur API: ' + err.message, 'error');
      }
    }

    setInterval(refreshMonitoring, 30000);
    refreshMonitoring();

    // HOTELS
    async function loadHotels() {
      try {
        const hotels = await fetchJSON('/hotels');
        const tbody = document.getElementById('hotelTable');
        const select = document.getElementById('selectedHotelFiles');
        tbody.innerHTML = ''; select.innerHTML = '';
        hotels.forEach(h => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="py-2">${h.hotel_id}</td><td>${h.name || '-'}</td><td>${h.is_active ? '✅' : '⛔'}</td>`;
          tbody.appendChild(tr);
          const opt = document.createElement('option'); opt.value = h.hotel_id; opt.textContent = h.hotel_id;
          select.appendChild(opt);
        });
      } catch (err) { showToast(err.message, 'error'); }
    }

    loadHotels();

    document.getElementById('btnRefreshHotels').addEventListener('click', loadHotels);

    // MODULE UPLOAD
    document.getElementById("btnOpenUpload").addEventListener("click", () => {
      const input = document.getElementById("fileUploadInput");
      input.value = "";
      input.click();
    });

    document.getElementById("fileUploadInput").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const hotelId = prompt("Entrez l'identifiant de l'hôtel (ex: folkestone-opera) :");
      if (!hotelId) return showToast("Aucun hôtel spécifié.", "warning");

      const formData = new FormData();
      formData.append("file", file);
      const isJSON = file.name.endsWith(".json");
      const endpoint = isJSON ? `/upload/config?hotel_id=${encodeURIComponent(hotelId)}` : `/upload/excel?hotel_id=${encodeURIComponent(hotelId)}`;

      try {
        showToast(`Téléversement de ${file.name}...`, "info");
        await fetch(apiBase() + endpoint, { method: "POST", body: formData });
        showToast(`Fichier ${file.name} téléversé avec succès`, "success");
      } catch (err) {
        showToast(`Erreur téléversement : ${err.message}`, "error");
      }
    });

    // MODULE FICHIERS EXISTANTS
    document.getElementById('btnLoadFiles').addEventListener('click', async () => {
      const hotelId = document.getElementById('selectedHotelFiles').value;
      if (!hotelId) return showToast('Sélectionnez un hôtel', 'warning');
      try {
        const data = await fetchJSON(`/hotel/files?hotel_id=${hotelId}`);
        const list = document.getElementById('fileList');
        if (!data.files.length) { list.innerHTML = '<p class="text-slate-500">Aucun fichier disponible.</p>'; return; }
        list.innerHTML = '';
        data.files.forEach(f => {
          const ext = f.filename.split('.').pop();
          const color = ext === 'json' ? 'text-amber-300' : 'text-sky-300';
          const size = (f.size/1024).toFixed(1) + ' Ko';
          const date = new Date(f.modified).toLocaleString('fr-FR');
          const openUrl = `${apiBase()}/hotel/files/download?hotel_id=${hotelId}&filename=${encodeURIComponent(f.filename)}`;
          list.innerHTML += `
            <div class="flex justify-between items-center bg-white/5 rounded-md px-3 py-2">
              <div><span class="${color}">${f.filename}</span><br><span class="text-xs text-slate-500">${size} • ${date}</span></div>
              <div class="flex gap-2">
                ${ext === 'json' ? `<button class="text-emerald-400 hover:text-emerald-300" onclick="showToast('JSON chargé (console)', 'info')"><i data-feather='play-circle'></i></button>` : ''}
                <a href="${openUrl}" target="_blank" class="text-indigo-400 hover:text-indigo-300"><i data-feather="external-link"></i></a>
              </div>
            </div>`;
        });
        feather.replace();
      } catch (err) { showToast(err.message, 'error'); }
    });

    feather.replace();
  </script>
</body>
</html>
