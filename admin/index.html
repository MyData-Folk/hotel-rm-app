<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Outil RM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8">
    <div class="max-w-6xl mx-auto space-y-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-indigo-700">Panneau d'Administration</h1>
            <a href="https://folkestone.e-hotelmanager.com" class="text-sm text-indigo-600 hover:underline">Aller au Simulateur</a>
        </header>

        <!-- Module de Gestion des Hôtels -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-hotel text-indigo-500 mr-3"></i>Gestion des Hôtels</h2>
            <div id="hotel-list" class="space-y-2 mb-4"></div>
            <form id="addHotelForm" class="flex gap-4">
                <input type="text" id="newHotelId" class="w-full p-2 border rounded-md" placeholder="Nouvel ID d'hôtel (ex: monhotel)" required>
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md font-semibold">Ajouter</button>
            </form>
        </div>

        <!-- Module d'Upload -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-upload text-purple-500 mr-3"></i>Chargement des Données</h2>
            <div class="mb-6">
                <label for="hotelSelect" class="block font-semibold mb-2">1. Sélectionner un Hôtel</label>
                <select id="hotelSelect" class="w-full p-2 border rounded-md"></select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 border-t pt-6">
                <!-- Formulaire d'upload de PLANNING (Excel) -->
                <form id="excelUploadForm" class="space-y-3">
                    <h3 class="font-semibold text-lg">2a. Charger le Planning</h3>
                    <input type="file" id="excelFile" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-indigo-50" accept=".xlsx" required>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md">Envoyer Planning (.xlsx)</button>
                </form>
                <!-- Formulaire d'upload de CONFIG (JSON) -->
                <form id="configUploadForm" class="space-y-3">
                    <h3 class="font-semibold text-lg">2b. Charger une Configuration</h3>
                    <input type="file" id="configFile" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-purple-50" accept=".json" required>
                    <button type="submit" class="w-full bg-purple-600 text-white font-bold py-2 px-4 rounded-md">Envoyer Config (.json)</button>
                </form>
            </div>
        </div>

        <!-- Module de Génération de Configuration (Optionnel) -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-magic-wand-sparkles text-green-500 mr-3"></i>OU Créer une Nouvelle Configuration...</h2>
            <p class="text-gray-600">Le module de génération de configuration (l'assistant pas-à-pas) sera intégré ici en tant qu'alternative.</p>
        </div>
    </div>

    <div id="spinner-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="spinner"></div></div>
    <div id="toast" class="toast"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_URL = 'https://api-folkestone.e-hotelmanager.com';
        const hotelListDiv = document.getElementById('hotel-list');
        const addHotelForm = document.getElementById('addHotelForm');
        const hotelSelect = document.getElementById('hotelSelect');
        const excelUploadForm = document.getElementById('excelUploadForm');
        const configUploadForm = document.getElementById('configUploadForm'); // Ajout du sélecteur pour le nouveau formulaire
        const spinner = document.getElementById('spinner-overlay');
        const toastContainer = document.getElementById('toast');

        const showToast = (message, isError = false) => {
            toastContainer.className = `toast show ${isError ? 'bg-red-500 text-white p-3 rounded-lg shadow-lg' : 'bg-green-500 text-white p-3 rounded-lg'}`;
            toastContainer.innerHTML = `<i class="fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'} mr-2"></i> ${message}`;
            setTimeout(() => toastContainer.classList.remove('show'), 4000);
        };
        
        async function fetchAndRenderHotels() {
            try {
                const response = await fetch(`${API_URL}/hotels`);
                if (!response.ok) throw new Error('Impossible de charger les hôtels.');
                const hotels = await response.json();
                hotelListDiv.innerHTML = ''; hotelSelect.innerHTML = '';
                if (hotels.length === 0) {
                    hotelListDiv.innerHTML = '<p class="text-gray-500">Aucun hôtel configuré.</p>';
                    hotelSelect.innerHTML = '<option>Veuillez ajouter un hôtel</option>';
                    return;
                }
                hotels.forEach(id => {
                    hotelListDiv.innerHTML += `<div class="flex justify-between items-center p-2 bg-gray-50 rounded-md"><span>${id}</span><button data-id="${id}" class="delete-hotel-btn text-red-500 hover:text-red-700 font-bold">&times;</button></div>`;
                    hotelSelect.innerHTML += `<option value="${id}">${id}</option>`;
                });
            } catch (error) { showToast(error.message, true); }
        }

        addHotelForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newHotelId = document.getElementById('newHotelId').value.trim().toLowerCase();
            if (!newHotelId) return;
            try {
                const response = await fetch(`${API_URL}/hotels?hotel_id=${newHotelId}`, { method: 'POST' });
                if (!response.ok) throw new Error((await response.json()).detail);
                showToast(`Hôtel '${newHotelId}' ajouté.`);
                addHotelForm.reset();
                fetchAndRenderHotels();
            } catch (error) { showToast(error.message, true); }
        });

        hotelListDiv.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-hotel-btn')) {
                const hotelId = e.target.dataset.id;
                if (confirm(`Voulez-vous vraiment supprimer l'hôtel '${hotelId}' et toutes ses données (planning et config) ?`)) {
                    try {
                        const response = await fetch(`${API_URL}/hotels/${hotelId}`, { method: 'DELETE' });
                        if (!response.ok) throw new Error((await response.json()).detail);
                        showToast(`Hôtel '${hotelId}' supprimé.`);
                        fetchAndRenderHotels();
                    } catch (error) { showToast(error.message, true); }
                }
            }
        });

        const handleUpload = async (form, url) => {
            const hotelId = hotelSelect.value;
            const fileInput = form.querySelector('input[type="file"]');
            if (!hotelId || !fileInput.files.length) {
                showToast('Veuillez sélectionner un hôtel et un fichier.', true);
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            spinner.classList.remove('hidden');
            try {
                const response = await fetch(`${url}?hotel_id=${hotelId}`, { method: 'POST', body: formData });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Erreur serveur');
                showToast(`Fichier pour '${hotelId}' envoyé avec succès.`);
                form.reset();
            } catch (error) { showToast(`Erreur: ${error.message}`, true); }
            finally { spinner.classList.add('hidden'); }
        };

        excelUploadForm.addEventListener('submit', (e) => { 
            e.preventDefault(); 
            handleUpload(excelUploadForm, `${API_URL}/upload/excel`); 
        });

        // On attache l'événement au nouveau formulaire d'upload de config
        configUploadForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleUpload(configUploadForm, `${API_URL}/upload/config`);
        });

        fetchAndRenderHotels();
    });
    </script>
</body>
</html>