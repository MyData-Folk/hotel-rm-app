<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Outil RM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="gradient-header text-white shadow-lg">
        <div class="container mx-auto px-4 py-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold">Panneau d'Administration</h1>
                <p class="mt-2 text-lg text-blue-100">Gérez les hôtels, les configurations et les plannings.</p>
            </div>
            <a href="https://folkestone.e-hotelmanager.com" class="btn btn-secondary bg-white/20 hover:bg-white/30"><i class="fas fa-chart-line mr-2"></i>Aller au Simulateur</a>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Colonne de gauche: Panneau de Contrôle -->
            <div class="lg:col-span-1 space-y-8">
                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-hotel text-indigo-500 mr-3"></i>Gestion des Hôtels</h2>
                    <div id="hotel-list" class="space-y-2 mb-4"></div>
                    <form id="addHotelForm" class="flex gap-2">
                        <input type="text" id="newHotelId" class="form-input" placeholder="Nouvel ID d'hôtel" required>
                        <button type="submit" class="btn btn-secondary">Ajouter</button>
                    </form>
                </div>
                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-upload text-purple-500 mr-3"></i>Chargement des Fichiers</h2>
                    <form id="uploadForms" class="space-y-4">
                        <div>
                            <label for="hotelSelect" class="block text-sm font-medium mb-1">Pour l'hôtel :</label>
                            <select id="hotelSelect" class="form-input"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Fichier Planning (.xlsx)</label>
                            <label class="file-input-label"><i class="fas fa-calendar-alt mr-3 text-gray-400"></i><span id="excelFileName">Choisir un fichier...</span><input type="file" id="excelFile" class="sr-only" accept=".xlsx"></label>
                        </div>
                        <button type="button" id="uploadExcelBtn" class="btn btn-tertiary w-full">Envoyer le Planning</button>
                    </form>
                </div>
            </div>

            <!-- Colonne de droite: Générateur de Configuration -->
            <div class="lg:col-span-2 card p-6">
                 <h2 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-magic-wand-sparkles text-green-500 mr-3"></i>Générateur de Configuration</h2>
                 <div id="generator-wizard">
                    <div id="step1-content">
                        <label class="block text-sm font-medium mb-2">Fichier CSV (Partenaire;Plan;Chambre)</label>
                        <label class="file-input-label"><i class="fas fa-file-csv mr-3 text-gray-400"></i><span id="csvFileName">Choisir un fichier...</span><input type="file" id="csv-file" class="sr-only" accept=".csv"></label>
                        <div id="file-info" class="hidden mt-4 p-3 bg-indigo-50 rounded-md text-sm"></div>
                    </div>
                    <div id="step2-content" class="hidden">
                        <h3 class="font-semibold text-gray-700 mb-2">Commissions & Remises</h3>
                        <div class="overflow-x-auto"><table class="w-full text-sm">
                            <thead class="bg-gray-50"><tr><th class="p-2 text-left">Partenaire</th><th class="p-2">Comm(%)</th><th class="p-2">Remise?</th><th class="p-2">Rem(%)</th><th class="p-2 text-left">Exclusions</th></tr></thead>
                            <tbody id="commission-table-body"></tbody></table>
                        </div>
                    </div>
                     <div id="step3-content" class="hidden">
                        <h3 class="font-semibold text-gray-700 mb-2">Ordre d'Affichage</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><h4 class="font-semibold mb-1">Chambres</h4><div id="room-list-generator" class="min-h-[150px] p-2 bg-gray-100 rounded border space-y-2"></div></div>
                            <div><h4 class="font-semibold mb-1">Plans</h4><div id="plan-list-generator" class="min-h-[150px] p-2 bg-gray-100 rounded border space-y-2"></div></div>
                        </div>
                    </div>
                    <div id="step4-content" class="hidden">
                         <h3 class="font-semibold text-gray-700 mb-2">Aperçu & Envoi</h3>
                         <pre id="json-preview" class="bg-gray-800 text-white text-xs p-4 rounded-md max-h-64 overflow-auto"></pre>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button id="prev-step" class="btn btn-tertiary hidden">Précédent</button>
                        <button id="next-step" class="btn btn-gradient-primary disabled:opacity-50" disabled>Suivant</button>
                        <div id="final-buttons" class="hidden flex gap-4">
                             <button id="download-json" class="btn btn-secondary">Télécharger</button>
                             <button id="upload-json-api" class="btn btn-gradient-primary">Envoyer à l'API</button>
                        </div>
                    </div>
                 </div>
            </div>
        </div>
    </main>

    <div id="spinner-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="spinner"></div></div>
    <div id="toast" class="toast"></div>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_URL = 'https://api-folkestone.e-hotelmanager.com';
        let currentStep = 1;
        let partnersData = [], roomCategories = new Set(), planCategories = new Set();
        let commissionRates = {}, discountSettings = {};

        const hotelListDiv = document.getElementById('hotel-list'), addHotelForm = document.getElementById('addHotelForm'), hotelSelect = document.getElementById('hotelSelect');
        const excelUploadForm = document.getElementById('uploadForms'), uploadExcelBtn = document.getElementById('uploadExcelBtn');
        const csvFileInput = document.getElementById('csv-file'), fileInfo = document.getElementById('file-info'), csvFileNameSpan = document.getElementById('csvFileName');
        const steps = { 1: 'step1-content', 2: 'step2-content', 3: 'step3-content', 4: 'step4-content' };
        const commissionTableBody = document.getElementById('commission-table-body'), roomList = document.getElementById('room-list-generator'), planList = document.getElementById('plan-list-generator');
        const jsonPreview = document.getElementById('json-preview'), prevBtn = document.getElementById('prev-step'), nextBtn = document.getElementById('next-step'), finalButtons = document.getElementById('final-buttons');
        const spinner = document.getElementById('spinner-overlay'), toastContainer = document.getElementById('toast');

        const showSpinner = () => spinner.classList.remove('hidden'); const hideSpinner = () => spinner.classList.add('hidden');
        const showToast = (message, isError = false) => {
            toastContainer.className = `toast show ${isError ? 'bg-red-500' : 'bg-green-600'}`;
            toastContainer.innerHTML = `<i class="fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'} mr-2"></i> ${message}`;
            setTimeout(() => toastContainer.classList.remove('show'), 3000);
        };

        // --- Hotel Management ---
        async function fetchAndRenderHotels() {
            try {
                const hotels = await (await fetch(`${API_URL}/hotels`)).json();
                hotelListDiv.innerHTML = ''; hotelSelect.innerHTML = '';
                if (hotels.length === 0) { hotelListDiv.innerHTML = '<p class="text-gray-500">Aucun hôtel.</p>'; hotelSelect.innerHTML = '<option>Ajoutez un hôtel</option>'; return; }
                hotels.forEach(id => {
                    hotelListDiv.innerHTML += `<div class="flex justify-between items-center p-2 bg-gray-50 rounded-md"><span>${id}</span><button data-id="${id}" class="delete-hotel-btn text-red-500 hover:text-red-700">&times;</button></div>`;
                    hotelSelect.innerHTML += `<option value="${id}">${id}</option>`;
                });
            } catch (error) { showToast('Erreur chargement hôtels', true); }
        }
        addHotelForm.addEventListener('submit', async e => {
            e.preventDefault(); const newHotelId = document.getElementById('newHotelId').value.trim(); if (!newHotelId) return;
            try {
                const res = await fetch(`${API_URL}/hotels?hotel_id=${newHotelId}`, { method: 'POST' });
                if (!res.ok) throw new Error((await res.json()).detail);
                showToast(`Hôtel '${newHotelId}' ajouté.`); addHotelForm.reset(); fetchAndRenderHotels();
            } catch (error) { showToast(error.message, true); }
        });
        hotelListDiv.addEventListener('click', async e => {
            if (!e.target.classList.contains('delete-hotel-btn')) return;
            const hotelId = e.target.dataset.id;
            if (confirm(`Supprimer l'hôtel '${hotelId}' et toutes ses données ?`)) {
                try {
                    const res = await fetch(`${API_URL}/hotels/${hotelId}`, { method: 'DELETE' });
                    if (!res.ok) throw new Error((await res.json()).detail);
                    showToast(`Hôtel '${hotelId}' supprimé.`); fetchAndRenderHotels();
                } catch (error) { showToast(error.message, true); }
            }
        });

        // --- File Uploads ---
        uploadExcelBtn.addEventListener('click', async () => {
            const hotelId = hotelSelect.value; const fileInput = document.getElementById('excelFile');
            if (!hotelId || !fileInput.files.length) return showToast('Sélectionnez un hôtel et un fichier Excel.', true);
            const formData = new FormData(); formData.append('file', fileInput.files[0]);
            showSpinner();
            try {
                const res = await fetch(`${API_URL}/upload/excel?hotel_id=${hotelId}`, { method: 'POST', body: formData });
                const result = await res.json(); if (!res.ok) throw new Error(result.detail || 'Erreur serveur');
                showToast(`Planning pour '${hotelId}' chargé.`); fileInput.value = ''; document.getElementById('excelFileName').textContent = 'Choisir un fichier...';
            } catch(error) { showToast(error.message, true); } finally { hideSpinner(); }
        });
        document.getElementById('excelFile').addEventListener('change', e => document.getElementById('excelFileName').textContent = e.target.files[0]?.name || 'Choisir un fichier...');

        // --- Config Generator Wizard ---
        const updateWizardUI = () => { /* ... (gardez la fonction updateWizardUI de votre version précédente) ... */ };
        csvFileInput.addEventListener('change', e => { /* ... (gardez la fonction de gestion du CSV) ... */ });
        // ... (gardez toute la logique du générateur de configuration)

        // Initial Load
        fetchAndRenderHotels();
    });
    </script>
</body>
</html>