<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Folkestone RM (Stable)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4f46e5;
      --primary-dark: #4338ca;
      --secondary: #6b7280;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
    }
    
    body {
      font-family: 'Inter', system-ui, Arial, sans-serif;
      font-size: 14px;
      background: #f3f4f6;
      color: #111;
      margin: 0;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .card {
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,.05);
      margin-bottom: 24px;
      border: 1px solid #e5e7eb;
    }
    
    h1, h2, h3 {
      margin-top: 0;
      color: #1f2937;
    }
    
    h1 {
      font-size: 1.875rem;
      margin-bottom: 8px;
    }
    
    h2 {
      font-size: 1.5rem;
      margin-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 8px;
    }
    
    h3 {
      font-size: 1.25rem;
      margin-bottom: 12px;
    }
    
    input, select, button {
      font: inherit;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: white;
      transition: all 0.2s;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    button {
      cursor: pointer;
      font-weight: 500;
      border: none;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    
    .btn-secondary {
      background: var(--secondary);
      color: white;
    }
    
    .flex {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .small {
      font-size: 13px;
      color: #6b7280;
    }
    
    .toast {
      position: fixed;
      right: 20px;
      bottom: 20px;
      padding: 16px 20px;
      border-radius: 12px;
      display: none;
      box-shadow: 0 10px 25px rgba(0,0,0,.15);
      z-index: 1000;
      color: white;
      font-weight: 500;
    }
    
    .toast.show {
      display: flex;
      align-items: center;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(0,0,0,.08);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-radius: 8px;
      background: #f8fafc;
      margin-bottom: 8px;
      border: 1px solid #e5e7eb;
    }
    
    .grid {
      display: grid;
      gap: 16px;
    }
    
    .grid-cols-1 { grid-template-columns: 1fr; }
    .grid-cols-2 { grid-template-columns: 1fr 1fr; }
    .grid-cols-3 { grid-template-columns: 1fr 1fr 1fr; }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-ok { background: #dcfce7; color: #166534; }
    .status-error { background: #fef2f2; color: #dc2626; }
    .status-warning { background: #fffbeb; color: #d97706; }
    
    .space-y-4 > * + * { margin-top: 16px; }
    .space-x-2 > * + * { margin-left: 8px; }
    
    .max-h-32 { max-height: 128px; }
    .overflow-y-auto { overflow-y: auto; }
    .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    
    #spinner {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      display: none;
      z-index: 9999;
    }
    
    .upload-section {
      background: #f8fafc;
      padding: 20px;
      border-radius: 8px;
      border: 2px dashed #d1d5db;
    }
    
    @media (max-width: 768px) {
      .grid-cols-2, .grid-cols-3 {
        grid-template-columns: 1fr;
      }
      
      .flex {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="card">
      <h1>üöÄ Admin Folkestone RM - Version Stable</h1>
      <p class="small">Gestion des h√¥tels & chargement rapide (Excel/CSV + JSON config)</p>
    </header>

    <section class="card" id="hotels-card">
      <h2>üè® Gestion des h√¥tels</h2>
      <div id="hotelList" class="space-y-4" style="margin-bottom: 16px"></div>

      <form id="addHotelForm" class="flex">
        <input id="newHotelId" placeholder="Nouvel ID d'h√¥tel (ex: folkestone)" required style="flex: 1">
        <button id="addHotelBtn" class="btn-primary">Ajouter l'h√¥tel</button>
      </form>
    </section>

    <section class="card" id="monitoring-card">
      <h2>üìä Monitoring des H√¥tels</h2>
      <div id="hotelStatus" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="text-gray-500">Chargement des statuts...</div>
      </div>
    </section>

    <section class="card" id="data-preview">
      <h2>üëÅÔ∏è Aper√ßu des Donn√©es Charg√©es</h2>
      <div id="dataPreview" class="text-sm">
        <p class="text-gray-500">S√©lectionnez un h√¥tel et chargez les donn√©es pour voir l'aper√ßu.</p>
      </div>
    </section>

    <section class="card" id="upload-card">
      <h2>üì§ Chargement rapide</h2>
      <div style="margin-bottom: 16px">
        <label class="small"><strong>S√©lectionner l'h√¥tel pour l'upload</strong></label><br>
        <select id="hotelSelect" style="width: 100%; margin-top: 8px; padding: 12px"></select>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="upload-section">
          <h3><i class="fas fa-file-excel mr-2" style="color: #10b981"></i>1) Planning (.xlsx/.csv)</h3>
          <p class="small">Fichier Excel ou CSV contenant les tarifs et disponibilit√©s</p>
          <input id="excelFile" type="file" accept=".xlsx,.csv" style="width: 100%; margin: 12px 0"><br>
          <button id="sendExcelBtn" class="btn-primary" style="width: 100%">
            <i class="fas fa-upload mr-2"></i>Envoyer planning
          </button>
        </div>

        <div class="upload-section">
          <h3><i class="fas fa-file-code mr-2" style="color: #3b82f6"></i>2) Configuration (.json)</h3>
          <p class="small">Fichier JSON de configuration des partenaires et plans tarifaires</p>
          <input id="configFile" type="file" accept=".json" style="width: 100%; margin: 12px 0"><br>
          <button id="sendConfigBtn" class="btn-primary" style="width: 100%">
            <i class="fas fa-upload mr-2"></i>Envoyer config
          </button>
        </div>
      </div>
    </section>

    <section class="card" id="debug-card">
      <h2>üêõ Outils de D√©bogage</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <button id="testApiBtn" class="btn-secondary">
          <i class="fas fa-heartbeat mr-2"></i>Tester l'API
        </button>
        <button id="refreshAllBtn" class="btn-secondary">
          <i class="fas fa-sync-alt mr-2"></i>Rafra√Æchir tout
        </button>
      </div>
      <div id="debugOutput" class="mt-4 text-sm" style="display: none;">
        <pre class="bg-gray-100 p-4 rounded-lg overflow-auto max-h-64"></pre>
      </div>
    </section>
  </div>

  <div id="spinner">
    <div class="spinner"></div>
  </div>

  <div id="toast" class="toast"></div>

<script>
(function(){
  const API_URL = 'https://api-folkestone.e-hotelmanager.com';
  const hotelListEl = document.getElementById('hotelList');
  const hotelSelect = document.getElementById('hotelSelect');
  const addHotelForm = document.getElementById('addHotelForm');
  const newHotelId = document.getElementById('newHotelId');
  const sendExcelBtn = document.getElementById('sendExcelBtn');
  const sendConfigBtn = document.getElementById('sendConfigBtn');
  const excelFile = document.getElementById('excelFile');
  const configFile = document.getElementById('configFile');
  const spinner = document.getElementById('spinner');
  const toast = document.getElementById('toast');
  const testApiBtn = document.getElementById('testApiBtn');
  const refreshAllBtn = document.getElementById('refreshAllBtn');
  const debugOutput = document.getElementById('debugOutput');

  const showSpinner = (on = true) => spinner.style.display = on ? 'block' : 'none';
  
  const showToast = (msg, err = false) => {
    toast.textContent = msg;
    toast.style.background = err ? '#ef4444' : '#10b981';
    toast.className = 'toast show';
    setTimeout(() => toast.className = 'toast', 4000);
  };

  const debugLog = (data) => {
    debugOutput.style.display = 'block';
    debugOutput.querySelector('pre').textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
  };

  // Test de l'API
  async function testApi() {
    try {
      showSpinner(true);
      const response = await fetch(`${API_URL}/health`);
      const data = await response.json();
      
      if (response.ok) {
        debugLog(data);
        showToast('‚úÖ API en ligne et fonctionnelle');
      } else {
        throw new Error(`API error: ${response.status}`);
      }
    } catch (error) {
      debugLog(`‚ùå Erreur API: ${error.message}`);
      showToast('‚ùå API hors ligne', true);
    } finally {
      showSpinner(false);
    }
  }

  // Chargement des h√¥tels
  async function fetchHotels(){
    try{
      const res = await fetch(`${API_URL}/hotels`);
      if(!res.ok) throw new Error(`Erreur ${res.status}: ${res.statusText}`);
      const hotels = await res.json();
      renderHotels(hotels);
      await displayHotelStatus();
    }catch(err){
      console.error('Erreur chargement h√¥tels:', err);
      renderHotels([]);
      showToast('‚ùå Erreur chargement h√¥tels: ' + err.message, true);
    }
  }

  function renderHotels(hotels){
    hotelListEl.innerHTML = '';
    hotelSelect.innerHTML = '';
    
    if(!hotels || hotels.length === 0){
      hotelListEl.innerHTML = '<div class="small">Aucun h√¥tel configur√©. Ajoutez-en un pour commencer.</div>';
      hotelSelect.innerHTML = '<option value="">-- Aucun h√¥tel --</option>';
      return;
    }
    
    hotels.forEach(id => {
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `
        <div style="font-weight: 600; font-size: 16px">üè® ${id}</div>
        <div style="display: flex; gap: 8px; align-items: center">
          <button data-id="${id}" class="btn-danger delete-btn" title="Supprimer">
            <i class="fas fa-trash mr-1"></i>Supprimer
          </button>
        </div>
      `;
      hotelListEl.appendChild(div);

      const opt = document.createElement('option');
      opt.value = id; 
      opt.textContent = id;
      hotelSelect.appendChild(opt);
    });
  }

  // Suppression d'h√¥tel
  hotelListEl.addEventListener('click', async (e) => {
    if(!e.target.closest('.delete-btn')) return;
    const btn = e.target.closest('.delete-btn');
    const id = btn.dataset.id;
    
    if(!confirm(`Supprimer l'h√¥tel '${id}' et toutes ses donn√©es ? Cette action est irr√©versible.`)) return;
    
    try{
      showSpinner(true);
      const encodedId = encodeURIComponent(id);
      const res = await fetch(`${API_URL}/hotels/${encodedId}`, { method: 'DELETE' });
      
      if(!res.ok){
        const err = await res.json().catch(() => ({detail: res.statusText}));
        throw new Error(err.detail || `Erreur ${res.status}`);
      }
      
      showToast(`‚úÖ H√¥tel '${id}' supprim√© avec succ√®s.`);
      await fetchHotels();
    }catch(err){
      console.error('Erreur suppression:', err);
      showToast(`‚ùå Erreur suppression: ${err.message}`, true);
    }finally{ 
      showSpinner(false); 
    }
  });

  // Ajout d'h√¥tel
  if(addHotelForm){
    addHotelForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const id = (newHotelId.value || '').trim().toLowerCase();
      if(!id) return showToast('‚ùå ID h√¥tel requis', true);
      
      try{
        showSpinner(true);
        const encodedId = encodeURIComponent(id);
        const res = await fetch(`${API_URL}/hotels?hotel_id=${encodedId}`, { method: 'POST' });
        
        if(res.status === 409){
          const body = await res.json().catch(() => ({detail: 'Conflit'}));
          throw new Error(body.detail || 'ID existe d√©j√†');
        }
        
        if(!res.ok) {
          const body = await res.json().catch(() => ({detail: res.statusText}));
          throw new Error(body.detail || `Erreur ${res.status}`);
        }
        
        showToast(`‚úÖ H√¥tel '${id}' ajout√© avec succ√®s.`);
        newHotelId.value = '';
        await fetchHotels();
      }catch(err){
        console.error('Erreur ajout h√¥tel:', err);
        showToast('‚ùå Erreur ajout: ' + err.message, true);
      }finally{ 
        showSpinner(false); 
      }
    });
  }

  // V√©rification statut fichiers
  async function checkFileStatus(hotelId) {
    try {
      const encodedHotelId = encodeURIComponent(hotelId);
      const response = await fetch(`${API_URL}/files/status?hotel_id=${encodedHotelId}`);
      if (response.ok) {
        return await response.json();
      }
    } catch (error) {
      console.error('Erreur v√©rification statut fichiers:', error);
    }
    return null;
  }

  // Monitoring des h√¥tels
  async function displayHotelStatus() {
    const hotels = Array.from(hotelSelect.options)
      .map(opt => opt.value)
      .filter(val => val);
    
    if (!hotels.length) {
      document.getElementById('hotelStatus').innerHTML = '<div class="text-gray-500">Aucun h√¥tel configur√©</div>';
      return;
    }
    
    const statuses = await Promise.all(hotels.map(async (hotelId) => {
      const fileStatus = await checkFileStatus(hotelId);
      const [dataRes, configRes] = await Promise.allSettled([
        fetch(`${API_URL}/data?hotel_id=${encodeURIComponent(hotelId)}`),
        fetch(`${API_URL}/config?hotel_id=${encodeURIComponent(hotelId)}`)
      ]);
      
      return {
        hotelId,
        data: dataRes.status === 'fulfilled' && dataRes.value.ok,
        config: configRes.status === 'fulfilled' && configRes.value.ok,
        fileStatus: fileStatus
      };
    }));
    
    document.getElementById('hotelStatus').innerHTML = statuses.map(status => {
      const hasData = status.data;
      const hasConfig = status.config;
      const statusClass = hasData && hasConfig ? 'bg-green-50 border-green-200' : 
                         hasData || hasConfig ? 'bg-yellow-50 border-yellow-200' : 
                         'bg-red-50 border-red-200';
      
      return `
      <div class="border rounded-lg p-4 ${statusClass}">
        <div class="font-semibold text-lg mb-2">üè® ${status.hotelId}</div>
        <div class="space-y-2 text-sm">
          <div class="flex items-center gap-2">
            <span class="status-badge ${hasData ? 'status-ok' : 'status-error'}">
              ${hasData ? '‚úÖ' : '‚ùå'} Donn√©es
            </span>
            <span class="status-badge ${hasConfig ? 'status-ok' : 'status-error'}">
              ${hasConfig ? '‚úÖ' : '‚ùå'} Config
            </span>
          </div>
          ${status.fileStatus ? `
          <div class="text-xs space-y-1">
            <div>üìä Fichier donn√©es: ${status.fileStatus.data_file_exists ? '‚úÖ' : '‚ùå'}</div>
            <div>‚öôÔ∏è Config DB: ${status.fileStatus.config_exists ? '‚úÖ' : '‚ùå'}</div>
          </div>
          ` : ''}
        </div>
      </div>
      `;
    }).join('');
  }

  // Aper√ßu des donn√©es
  async function previewHotelData(hotelId) {
    try {
      const encodedHotelId = encodeURIComponent(hotelId);
      const response = await fetch(`${API_URL}/data?hotel_id=${encodedHotelId}`);
      
      if (!response.ok) {
        throw new Error(`Donn√©es non disponibles (${response.status})`);
      }
      
      const data = await response.json();
      const preview = document.getElementById('dataPreview');
      
      let html = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4">`;
      
      // Statistiques g√©n√©rales
      html += `<div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
        <h3 class="font-semibold mb-2">üìä Statistiques</h3>
        <p><strong>Chambres:</strong> ${Object.keys(data.rooms || {}).length}</p>
        <p><strong>Dates:</strong> ${data.dates_processed?.length || 'N/A'}</p>
        <p class="text-xs text-gray-500 mt-2">G√©n√©r√©: ${new Date(data.report_generated_at).toLocaleDateString('fr-FR')}</p>
      </div>`;
      
      // Liste des chambres
      const rooms = Object.keys(data.rooms || {});
      html += `<div class="bg-green-50 p-4 rounded-lg border border-green-200">
        <h3 class="font-semibold mb-2">üè® Chambres (${rooms.length})</h3>
        <div class="max-h-32 overflow-y-auto text-xs space-y-1">
          ${rooms.slice(0, 10).map(room => `<div>‚Ä¢ ${room}</div>`).join('')}
          ${rooms.length > 10 ? `<div class="text-gray-500">... et ${rooms.length - 10} autres</div>` : ''}
        </div>
      </div>`;
      
      // Plans tarifaires (premi√®re chambre)
      const firstRoom = rooms[0];
      if (firstRoom && data.rooms[firstRoom]?.plans) {
        const plans = Object.keys(data.rooms[firstRoom].plans);
        html += `<div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
          <h3 class="font-semibold mb-2">üí∞ Plans (${plans.length})</h3>
          <div class="max-h-32 overflow-y-auto text-xs space-y-1">
            ${plans.slice(0, 8).map(plan => `<div class="truncate" title="${plan}">‚Ä¢ ${plan}</div>`).join('')}
            ${plans.length > 8 ? `<div class="text-gray-500">... et ${plans.length - 8} autres</div>` : ''}
          </div>
        </div>`;
      }
      
      html += `</div>`;
      preview.innerHTML = html;
      
    } catch (error) {
      console.error('Erreur aper√ßu donn√©es:', error);
      document.getElementById('dataPreview').innerHTML = 
        `<p class="text-red-500">‚ùå Impossible de charger l'aper√ßu: ${error.message}</p>`;
    }
  }

  // Upload de fichiers
  async function uploadFile(endpoint, fileInput, fileType){
    const hotelId = hotelSelect.value;
    if(!hotelId) {
      showToast('‚ùå S√©lectionnez d\'abord un h√¥tel', true);
      return;
    }
    
    if(!fileInput || !fileInput.files || fileInput.files.length === 0) {
      showToast('‚ùå Choisissez un fichier', true);
      return;
    }
    
    try{
      showSpinner(true);
      const fd = new FormData(); 
      fd.append('file', fileInput.files[0]);
      
      // Encoder l'ID d'h√¥tel pour les URLs
      const encodedHotelId = encodeURIComponent(hotelId);
      const url = `${API_URL}/${endpoint}?hotel_id=${encodedHotelId}`;
      
      console.log(`Upload ${fileType} pour ${hotelId} (encod√©: ${encodedHotelId})`);
      
      const res = await fetch(url, { 
        method: 'POST', 
        body: fd 
      });
      
      const body = await res.json().catch(() => null);
      if(!res.ok) {
        const errorMsg = (body && body.detail) ? body.detail : `Erreur ${res.status}: ${res.statusText}`;
        throw new Error(errorMsg);
      }
      
      let successMsg = `‚úÖ ${fileType} upload√© avec succ√®s pour ${hotelId}`;
      
      // Messages d√©taill√©s selon le type de fichier
      if (body.partners_count !== undefined) {
        successMsg += ` (${body.partners_count} partenaires)`;
      }
      if (body.rooms_found !== undefined) {
        successMsg += ` (${body.rooms_found} chambres)`;
      }
      
      showToast(successMsg);
      fileInput.value = '';
      
      // Mettre √† jour les statuts et aper√ßu
      await displayHotelStatus();
      await previewHotelData(hotelId);
      
    } catch(err) {
      console.error(`Erreur upload ${fileType}:`, err);
      showToast(`‚ùå Erreur upload ${fileType}: ${err.message}`, true);
    } finally { 
      showSpinner(false); 
    }
  }

  // Event listeners pour les uploads
  if(sendExcelBtn) {
    sendExcelBtn.addEventListener('click', (e) => { 
      e.preventDefault(); 
      uploadFile('upload/excel', excelFile, 'Planning'); 
    });
  }
  
  if(sendConfigBtn) {
    sendConfigBtn.addEventListener('click', (e) => { 
      e.preventDefault(); 
      uploadFile('upload/config', configFile, 'Configuration'); 
    });
  }

  // Mettre √† jour l'aper√ßu quand un h√¥tel est s√©lectionn√©
  hotelSelect.addEventListener('change', function() {
    if (this.value) {
      previewHotelData(this.value);
    } else {
      document.getElementById('dataPreview').innerHTML = 
        '<p class="text-gray-500">S√©lectionnez un h√¥tel et chargez les donn√©es pour voir l\'aper√ßu.</p>';
    }
  });

  // Outils de d√©bogage
  if(testApiBtn) {
    testApiBtn.addEventListener('click', testApi);
  }

  if(refreshAllBtn) {
    refreshAllBtn.addEventListener('click', async () => {
      showSpinner(true);
      await fetchHotels();
      showSpinner(false);
      showToast('‚úÖ Donn√©es rafra√Æchies');
    });
  }

  // Auto-refresh p√©riodique
  setInterval(fetchHotels, 30000);

  // Load on start
  fetchHotels();
  testApi(); // Test automatique au chargement

  // Afficher la version actuelle
  console.log('üöÄ Admin Folkestone RM - Version Stable charg√©e');
})();
</script>
</body>
</html>