<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HotelVision RM v2.0 - Tableau de Bord</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        
        #vanta-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.15;
        }
        
        .gradient-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }
        
        .btn-gradient-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transition: all 0.3s ease;
        }
        
        .btn-gradient-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -10px rgba(79, 70, 229, 0.6);
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
        }
        
        .tab-link {
            transition: all 0.3s ease;
        }
        
        .tab-link.tab-active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        
        .form-input {
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
        }
        
        .form-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #4f46e5;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .sticky-table-header th {
            position: sticky;
            top: 0;
            background-color: #f8fafc;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="vanta-bg"></div>
    
    <header class="gradient-header text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex items-center space-x-3">
                    <i data-feather="home" class="w-8 h-8"></i>
                    <h1 class="text-2xl md:text-3xl font-bold">HotelVision RM v2.0</h1>
                </div>
                <div class="flex items-center gap-4">
                    <div class="hidden md:flex items-center gap-2 bg-white/10 rounded-full px-4 py-2">
                        <i data-feather="user" class="w-5 h-5"></i>
                        <span id="userEmail">user@example.com</span>
                    </div>
                    <button id="logoutBtn" class="p-2 rounded-full hover:bg-white/10">
                        <i data-feather="log-out" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="card p-6 md:p-8 mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex-grow w-full md:w-auto">
                    <label for="hotelId" class="block text-sm font-medium text-gray-700 mb-2">
                        <i data-feather="home" class="inline mr-2 w-4 h-4"></i> Sélectionnez votre hôtel :
                    </label>
                    <div class="flex">
                        <select id="hotelId" class="form-input rounded-r-none flex-grow px-4 py-2">
                            <option value="">-- Sélectionner --</option>
                        </select>
                        <button id="refreshDataBtn" class="btn btn-gradient-primary rounded-l-none px-4 py-2 flex items-center" title="Charger/Rafraîchir les données">
                            <i data-feather="refresh-cw" class="mr-2 w-4 h-4"></i> Rafraîchir
                        </button>
                    </div>
                </div>
                <div class="flex items-center gap-4 mt-4 md:mt-0">
                    <a href="https://admin-hv.e-hotelmanager.com" id="adminLink" class="btn btn-secondary flex items-center px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 hidden">
                        <i data-feather="settings" class="mr-2 w-4 h-4"></i> Administration
                    </a>
                </div>
            </div>
            <p id="statusMessage" class="text-sm text-gray-600 mt-4 flex items-center">
                <i data-feather="info" class="mr-2 w-4 h-4"></i> Veuillez sélectionner un hôtel et cliquer sur rafraîchir.
            </p>
        </div>

        <div id="main-tools" class="card p-0 opacity-50 pointer-events-none transition-all duration-300">
            <div class="flex border-b border-gray-200">
                <button class="tab-link tab-active px-6 py-4" data-tab="simulator">
                    <i data-feather="calendar" class="mr-2 w-4 h-4"></i> Simulateur
                </button>
                <button class="tab-link px-6 py-4" data-tab="availability">
                    <i data-feather="check-circle" class="mr-2 w-4 h-4"></i> Disponibilités
                </button>
                <button class="tab-link px-6 py-4" data-tab="data">
                    <i data-feather="database" class="mr-2 w-4 h-4"></i> Données
                </button>
            </div>
            
            <!-- Tab Simulator -->
            <div id="tab-content-simulator" class="p-6 md:p-8">
                <form id="simulationForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 items-end">
                    <div>
                        <label for="simPartner" class="block text-sm font-medium mb-1 flex items-center">
                            <i data-feather="users" class="mr-2 w-4 h-4"></i> Partenaire
                        </label>
                        <select id="simPartner" class="form-input w-full px-4 py-2">
                            <option value="">En Direct (0%)</option>
                        </select>
                    </div>
                    <div>
                        <label for="simRoomType" class="block text-sm font-medium mb-1 flex items-center">
                            <i data-feather="home" class="mr-2 w-4 h-4"></i> Type de chambre
                        </label>
                        <select id="simRoomType" class="form-input w-full px-4 py-2">
                            <option value="">-- Sélectionner --</option>
                        </select>
                    </div>
                    <div>
                        <label for="simRatePlan" class="block text-sm font-medium mb-1 flex items-center">
                            <i data-feather="dollar-sign" class="mr-2 w-4 h-4"></i> Plan tarifaire
                        </label>
                        <select id="simRatePlan" class="form-input w-full px-4 py-2">
                            <option value="">-- Sélectionner --</option>
                        </select>
                    </div>
                    <div>
                        <label for="simStartDate" class="block text-sm font-medium mb-1 flex items-center">
                            <i data-feather="calendar" class="mr-2 w-4 h-4"></i> Date d'arrivée
                        </label>
                        <input type="date" id="simStartDate" class="form-input w-full px-4 py-2">
                    </div>
                    <div>
                        <label for="simEndDate" class="block text-sm font-medium mb-1 flex items-center">
                            <i data-feather="calendar" class="mr-2 w-4 h-4"></i> Date de départ
                        </label>
                        <input type="date" id="simEndDate" class="form-input w-full px-4 py-2">
                    </div>
                    <div class="flex items-end">
                        <button type="submit" class="btn btn-gradient-primary w-full px-4 py-2 rounded-md text-white font-medium flex items-center justify-center">
                            <i data-feather="zap" class="mr-2 w-4 h-4"></i> Simuler
                        </button>
                    </div>
                </form>

                <div class="flex flex-col md:flex-row items-start md:items-center gap-4 mt-6 p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="applyCommission" checked class="rounded border-gray-300 h-4 w-4 text-indigo-600 focus:ring-indigo-500">
                        <label for="applyCommission" class="text-sm font-medium" id="commissionLabel">Appliquer commission (0%)</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="applyPartnerDiscount" checked class="rounded border-gray-300 h-4 w-4 text-indigo-600 focus:ring-indigo-500">
                        <label for="applyPartnerDiscount" class="text-sm font-medium" id="partnerDiscountLabel">Appliquer remise partenaire (0%)</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="promoDiscount" class="text-sm font-medium">Remise (%):</label>
                        <input type="number" id="promoDiscount" min="0" max="100" value="0" class="w-20 px-2 py-1 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
            </div>

            <!-- Tab Availability -->
            <div id="tab-content-availability" class="p-6 md:p-8 hidden">
                <form id="availabilityForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1 flex items-center">
                            <i data-feather="grid" class="mr-2 w-4 h-4"></i> Types de chambres
                        </label>
                        <div id="availRoomTypesContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 p-4 border rounded-lg bg-gray-50">
                            <!-- Les cases à cocher seront générées ici -->
                        </div>
                        <div class="flex gap-2 mt-2">
                          <button type="button" id="selectAllRoomsBtn" class="text-xs text-indigo-600 hover:text-indigo-800 flex items-center">
                            <i data-feather="check-square" class="mr-1 w-3 h-3"></i> Tout sélectionner
                          </button>
                          <span>/</span>
                          <button type="button" id="deselectAllRoomsBtn" class="text-xs text-indigo-600 hover:text-indigo-800 flex items-center">
                            <i data-feather="square" class="mr-1 w-3 h-3"></i> Tout désélectionner
                          </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                         <div>
                             <label for="availStartDate" class="block text-sm font-medium mb-1 flex items-center">
                                 <i data-feather="calendar" class="mr-2 w-4 h-4"></i> Date de début
                             </label>
                             <input type="date" id="availStartDate" class="form-input w-full px-4 py-2">
                         </div>
                         <div>
                             <label for="availEndDate" class="block text-sm font-medium mb-1 flex items-center">
                                 <i data-feather="calendar" class="mr-2 w-4 h-4"></i> Date de fin
                             </label>
                             <input type="date" id="availEndDate" class="form-input w-full px-4 py-2">
                         </div>
                         <div class="flex items-end">
                             <button type="submit" class="btn btn-gradient-primary w-full px-4 py-2 rounded-md text-white font-medium flex items-center justify-center">
                                 <i data-feather="search" class="mr-2 w-4 h-4"></i> Vérifier
                             </button>
                         </div>
                    </div>
                </form>
                <div id="availabilityResults" class="mt-6 hidden">
                    <div class="flex justify-between items-center border-b pb-4 mb-4">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center">
                            <i data-feather="list" class="mr-2 w-5 h-5"></i> Tableau des Disponibilités
                        </h2>
                    </div>
                    <div id="availabilityTableContainer" class="overflow-x-auto relative max-h-[500px] overflow-y-auto"></div>
                </div>
            </div>

            <!-- Tab Data -->
            <div id="tab-content-data" class="p-6 md:p-8 hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Data Summary -->
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i data-feather="bar-chart-2" class="mr-2 w-5 h-5"></i> Résumé des données
                            </h3>
                            <div id="dataSummary" class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Types de chambres</span>
                                    <span id="roomTypesCount" class="text-sm font-semibold text-gray-900">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Plans tarifaires</span>
                                    <span id="ratePlansCount" class="text-sm font-semibold text-gray-900">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Partenaires</span>
                                    <span id="partnersCount" class="text-sm font-semibold text-gray-900">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Data Validation -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i data-feather="check-circle" class="mr-2 w-5 h-5"></i> Validation des données
                            </h3>
                            <button id="validateDataBtn" class="w-full flex items-center justify-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                                <i data-feather="refresh-cw" class="mr-2 w-4 h-4"></i> Valider les données
                            </button>
                            <div id="validationResults" class="mt-4 space-y-2 hidden">
                                <!-- Validation results will be inserted here -->
                            </div>
                        </div>
                    </div>

                    <!-- Export Options -->
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i data-feather="download" class="mr-2 w-5 h-5"></i> Exporter les données
                            </h3>
                            <div class="space-y-3">
                                <button id="exportTariffBtn" class="w-full flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                                    <i data-feather="file-text" class="mr-2 w-4 h-4"></i> Exporter les tarifs
                                </button>
                                <button id="exportConfigBtn" class="w-full flex items-center justify-center px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">
                                    <i data-feather="settings" class="mr-2 w-4 h-4"></i> Exporter la configuration
                                </button>
                                <button id="exportHistoryBtn" class="w-full flex items-center justify-center px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
                                    <i data-feather="clock" class="mr-2 w-4 h-4"></i> Exporter l'historique
                                </button>
                            </div>
                        </div>

                        <!-- Hotel Info -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i data-feather="info" class="mr-2 w-5 h-5"></i> Informations de l'hôtel
                            </h3>
                            <div id="hotelInfo" class="space-y-3 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Nom:</span>
                                    <span id="hotelName" class="font-medium text-gray-900">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">ID:</span>
                                    <span id="hotelIdDisplay" class="font-medium text-gray-900">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Admin:</span>
                                    <span id="hotelAdmin" class="font-medium text-gray-900">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Contact:</span>
                                    <span id="hotelContact" class="font-medium text-gray-900">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data History -->
                <div class="mt-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i data-feather="history" class="mr-2 w-5 h-5"></i> Historique des mises à jour
                    </h3>
                    <div id="dataHistory" class="space-y-3">
                        <!-- History will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <div id="resultsContainer" class="card mt-8 hidden animate-fade-in">
            <div class="border-b pb-4 mb-6">
                <h2 class="text-xl font-bold text-gray-800 flex items-center">
                    <i data-feather="file-text" class="mr-2 w-5 h-5"></i> Simulation : <span id="simRoomName" class="ml-1">-</span>
                </h2>
                <p class="text-sm text-gray-600 mt-1 flex items-center" id="simSourceInfo">
                    <i data-feather="info" class="mr-2 w-4 h-4"></i> Source: -
                </p>
            </div>
            <div class="overflow-x-auto relative max-h-[500px] overflow-y-auto">
                <table class="w-full text-sm sticky-table-header">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">Date</th>
                            <th class="px-4 py-3 text-right font-semibold text-gray-700">Prix Brut (€)</th>
                            <th class="px-4 py-3 text-right font-semibold text-gray-700">Prix Net (€)</th>
                            <th class="px-4 py-3 text-right font-semibold text-gray-700">Stock</th>
                            <th class="px-4 py-3 text-right font-semibold text-gray-700">Disponibilité</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div class="mt-6 p-4 bg-gray-50 rounded-lg grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i data-feather="calculator" class="mr-2 w-4 h-4"></i> Détail des calculs
                    </h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Sous-Total Brut:</span>
                            <span id="subtotalBrut" class="font-semibold">- €</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Remises & Promos:</span>
                            <span id="totalDiscount" class="font-semibold text-green-600">- €</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Total Commission:</span>
                            <span id="totalCommission" class="font-semibold text-red-600">- €</span>
                        </div>
                    </div>
                </div>
                <div class="border-l pl-6">
                    <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i data-feather="credit-card" class="mr-2 w-4 h-4"></i> Total Net Final
                    </h3>
                    <div id="totalNetFinal" class="text-2xl font-bold text-indigo-700">- €</div>
                </div>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row justify-end gap-4">
                <button id="newSimulationBtn" class="btn btn-secondary px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 flex items-center justify-center">
                    <i data-feather="plus" class="mr-2 w-4 h-4"></i> Nouvelle Simulation
                </button>
                <button id="exportBtn" class="btn btn-gradient-primary px-4 py-2 rounded-md text-white font-medium flex items-center justify-center">
                    <i data-feather="download" class="mr-2 w-4 h-4"></i> Exporter en Excel
                </button>
            </div>
        </div>
    </main>
  
    <div id="spinner-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="spinner"></div>
    </div>
    <div id="toast" class="toast"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Initialisation de Vanta.js pour l'arrière-plan
    VANTA.NET({
        el: "#vanta-bg",
        color: 0x4f46e5,
        backgroundColor: 0xf8fafc,
        points: 12,
        maxDistance: 20,
        spacing: 15
    });

    // Configuration Supabase avec les clés fournies
    const SUPABASE_URL = 'https://supabase.e-hotelmanager.com';
    const SUPABASE_ANON_KEY = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJzdXBhYmFzZSIsImlhdCI6MTc1OTYzMjAwMCwiZXhwIjo0OTE1MzA1NjAwLCJyb2xlIjoiYW5vbiJ9.REKN8YlJRDjhxS3HcDwmw5_KVZ8ylGG4ARkAvybsOUY';
    
    const { supabase } = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    const API_URL = 'https://hotelvision.e-hotelmanager.com';
    let hotelData = {}, hotelConfig = {}, currentSimulationData = null;
    let currentUser = null;
    let authToken = localStorage.getItem('hotelvision_token');

    const DOMElements = {
        hotelIdSelect: document.getElementById('hotelId'),
        refreshDataBtn: document.getElementById('refreshDataBtn'),
        statusMessage: document.getElementById('statusMessage'),
        mainTools: document.getElementById('main-tools'),
        simPartnerSelect: document.getElementById('simPartner'),
        simRoomTypeSelect: document.getElementById('simRoomType'),
        simRatePlanSelect: document.getElementById('simRatePlan'),
        simulationForm: document.getElementById('simulationForm'),
        simStartDate: document.getElementById('simStartDate'),
        simEndDate: document.getElementById('simEndDate'),
        resultsContainer: document.getElementById('resultsContainer'),
        resultsTableBody: document.getElementById('resultsTableBody'),
        spinner: document.getElementById('spinner-overlay'),
        toast: document.getElementById('toast'),
        applyCommission: document.getElementById('applyCommission'),
        applyPartnerDiscount: document.getElementById('applyPartnerDiscount'),
        promoDiscount: document.getElementById('promoDiscount'),
        exportBtn: document.getElementById('exportBtn'),
        newSimulationBtn: document.getElementById('newSimulationBtn'),
        availabilityForm: document.getElementById('availabilityForm'),
        availRoomTypesContainer: document.getElementById('availRoomTypesContainer'),
        availStartDate: document.getElementById('availStartDate'),
        availEndDate: document.getElementById('availEndDate'),
        availabilityResults: document.getElementById('availabilityResults'),
        availabilityTableContainer: document.getElementById('availabilityTableContainer'),
        selectAllRoomsBtn: document.getElementById('selectAllRoomsBtn'),
        deselectAllRoomsBtn: document.getElementById('deselectAllRoomsBtn'),
        commissionLabel: document.getElementById('commissionLabel'),
        partnerDiscountLabel: document.getElementById('partnerDiscountLabel'),
        userEmail: document.getElementById('userEmail'),
        logoutBtn: document.getElementById('logoutBtn'),
        adminLink: document.getElementById('adminLink'),
        validateDataBtn: document.getElementById('validateDataBtn'),
        validationResults: document.getElementById('validationResults'),
        exportTariffBtn: document.getElementById('exportTariffBtn'),
        exportConfigBtn: document.getElementById('exportConfigBtn'),
        exportHistoryBtn: document.getElementById('exportHistoryBtn'),
        dataSummary: document.getElementById('dataSummary'),
        hotelInfo: document.getElementById('hotelInfo'),
        dataHistory: document.getElementById('dataHistory'),
        roomTypesCount: document.getElementById('roomTypesCount'),
        ratePlansCount: document.getElementById('ratePlansCount'),
        partnersCount: document.getElementById('partnersCount'),
        hotelName: document.getElementById('hotelName'),
        hotelIdDisplay: document.getElementById('hotelIdDisplay'),
        hotelAdmin: document.getElementById('hotelAdmin'),
        hotelContact: document.getElementById('hotelContact')
    };

    const showSpinner = () => {
        if (DOMElements.spinner) DOMElements.spinner.classList.remove('hidden');
    };
    
    const hideSpinner = () => {
        if (DOMElements.spinner) DOMElements.spinner.classList.add('hidden');
    };
    
    const showToast = (message, isError = false) => {
        if (!DOMElements.toast) return;
        DOMElements.toast.textContent = message;
        DOMElements.toast.className = `toast show ${isError ? 'bg-red-500' : 'bg-green-600'}`;
        setTimeout(() => {
            if (DOMElements.toast) DOMElements.toast.classList.remove('show');
        }, 4000);
    };

    const formatCurrency = (val) => {
        if (val === null || val === undefined) return '–';
        return `${val.toFixed(2).replace('.', ',')} €`;
    };

    // Vérifier l'authentification
    async function checkAuth() {
        if (!authToken) {
            window.location.href = '/login';
            return;
        }
        
        try {
            // Vérifier la validité du token avec notre API
            const response = await fetch(`${API_URL}/api/verify-token`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Token invalide');
            }
            
            const data = await response.json();
            currentUser = data.user;
            
            // Mettre à jour l'interface utilisateur
            if (DOMElements.userEmail) {
                DOMElements.userEmail.textContent = currentUser.email;
            }
            
            // Afficher le lien d'administration si l'utilisateur est un admin
            if (currentUser.role === 'admin' && DOMElements.adminLink) {
                DOMElements.adminLink.classList.remove('hidden');
            }
            
            // Charger les hôtels de l'utilisateur
            await loadUserHotels();
            
        } catch (error) {
            console.error('Erreur d\'authentification:', error);
            localStorage.removeItem('hotelvision_token');
            window.location.href = '/login';
        }
    }

    // Charger les hôtels de l'utilisateur
    async function loadUserHotels() {
        try {
            showSpinner();
            
            const response = await fetch(`${API_URL}/api/me/hotels`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Impossible de charger les hôtels');
            }
            
            const hotels = await response.json();
            
            if (DOMElements.hotelIdSelect) {
                DOMElements.hotelIdSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
                hotels.forEach(id => {
                    DOMElements.hotelIdSelect.innerHTML += `<option value="${id}">${id}</option>`;
                });
            }
            
            hideSpinner();
            
        } catch (error) {
            console.error('Erreur chargement hôtels:', error);
            showToast(error.message, true);
            hideSpinner();
        }
    }

    const loadData = async () => {
        const hotelId = DOMElements.hotelIdSelect?.value;
        if (!hotelId) return showToast("Veuillez sélectionner un hôtel.", true);
        
        showSpinner();
        if (DOMElements.statusMessage) {
            DOMElements.statusMessage.textContent = 'Chargement des données...';
        }
        if (DOMElements.mainTools) {
            DOMElements.mainTools.classList.add('opacity-50', 'pointer-events-none');
        }
        
        try {
            // Charger les données tarifaires et configuration
            const [dataRes, configRes] = await Promise.all([
                fetch(`${API_URL}/api/hotel/tariff-data?hotel_id=${encodeURIComponent(hotelId)}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                }),
                fetch(`${API_URL}/api/hotel/configuration?hotel_id=${encodeURIComponent(hotelId)}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                })
            ]);
            
            if (!dataRes.ok) throw new Error('Données tarifaires introuvables');
            if (!configRes.ok) throw new Error('Configuration introuvable');
            
            const data = await dataRes.json();
            const config = await configRes.json();
            
            // Mettre à jour les données
            hotelData = data.data || {};
            hotelConfig = config.data || {};
            
            // Mettre à jour les sélecteurs
            populateSelectors();
            
            // Mettre à jour le résumé des données
            updateDataSummary();
            
            // Mettre à jour les informations de l'hôtel
            updateHotelInfo(hotelId);
            
            // Charger l'historique
            await loadDataHistory(hotelId);
            
            if (DOMElements.statusMessage) {
                DOMElements.statusMessage.textContent = `Données pour '${hotelId}' chargées avec succès.`;
            }
            if (DOMElements.mainTools) {
                DOMElements.mainTools.classList.remove('opacity-50', 'pointer-events-none');
            }
            showToast(`Données pour ${hotelId} chargées avec succès`);
            
        } catch (error) {
            console.error('Erreur chargement données:', error);
            if (DOMElements.statusMessage) {
                DOMElements.statusMessage.textContent = `Erreur: ${error.message}`;
            }
            showToast(error.message, true);
        } finally {
            hideSpinner();
        }
    };

    const updateDataSummary = () => {
        // Compter les éléments
        const roomTypes = Object.keys(hotelData).length;
        const ratePlans = new Set();
        const partners = Object.keys(hotelConfig.partners || {}).length;
        
        // Compter les plans tarifaires
        Object.values(hotelData).forEach(room => {
            room.rate_plans?.forEach(plan => ratePlans.add(plan));
        });
        
        // Mettre à jour le résumé
        if (DOMElements.roomTypesCount) DOMElements.roomTypesCount.textContent = roomTypes;
        if (DOMElements.ratePlansCount) DOMElements.ratePlansCount.textContent = ratePlans.size;
        if (DOMElements.partnersCount) DOMElements.partnersCount.textContent = partners;
    };

    const updateHotelInfo = async (hotelId) => {
        try {
            const response = await fetch(`${API_URL}/api/hotel/hotel-info?hotel_id=${encodeURIComponent(hotelId)}`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            
            if (!response.ok) return;
            
            const data = await response.json();
            const hotelInfo = data.hotel_info;
            
            if (DOMElements.hotelName) DOMElements.hotelName.textContent = hotelInfo.hotel_name;
            if (DOMElements.hotelIdDisplay) DOMElements.hotelIdDisplay.textContent = hotelInfo.hotel_id;
            if (DOMElements.hotelAdmin) DOMElements.hotelAdmin.textContent = hotelInfo.contact_email || 'Non défini';
            if (DOMElements.hotelContact) DOMElements.hotelContact.textContent = hotelInfo.contact_phone || 'Non défini';
            
        } catch (error) {
            console.error('Erreur chargement infos hôtel:', error);
        }
    };

    const loadDataHistory = async (hotelId) => {
        try {
            const response = await fetch(`${API_URL}/api/hotel/history/updates?hotel_id=${encodeURIComponent(hotelId)}`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            
            if (!response.ok) return;
            
            const data = await response.json();
            const history = data.tariff_history || [];
            
            if (DOMElements.dataHistory) {
                if (history.length === 0) {
                    DOMElements.dataHistory.innerHTML = '<div class="text-sm text-gray-500">Aucune mise à jour récente</div>';
                } else {
                    DOMElements.dataHistory.innerHTML = history.map(item => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <i data-feather="file-text" class="w-4 h-4 text-gray-500"></i>
                                <div>
                                    <div class="text-sm font-medium">${item.plan_name}</div>
                                    <div class="text-xs text-gray-500">${new Date(item.upload_date).toLocaleDateString('fr-FR')}</div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500">${item.uploaded_by || 'Système'}</div>
                        </div>
                    `).join('');
                }
            }
            
        } catch (error) {
            console.error('Erreur chargement historique:', error);
        }
    };

    const populateSelectors = () => {
        if (!DOMElements.simPartnerSelect || !DOMElements.simRoomTypeSelect || !DOMElements.availRoomTypesContainer) {
            return;
        }

        // Partenaires
        DOMElements.simPartnerSelect.innerHTML = '<option value="">En Direct (0%)</option>';
        
        if (hotelConfig.partners) {
            Object.keys(hotelConfig.partners).sort().forEach(name => {
                const partner = hotelConfig.partners[name];
                DOMElements.simPartnerSelect.innerHTML += `<option value="${name}">${name} (${partner.commission}%)</option>`;
            });
        }

        // Types de chambres
        const roomOrder = hotelConfig.displayOrder?.rooms || Object.keys(hotelData);
        DOMElements.simRoomTypeSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
        DOMElements.availRoomTypesContainer.innerHTML = '';
        
        roomOrder.filter(room => hotelData[room]).forEach(room => {
            DOMElements.simRoomTypeSelect.innerHTML += `<option value="${room}">${room}</option>`;
            DOMElements.availRoomTypesContainer.innerHTML += `
                <div class="flex items-center">
                    <input type="checkbox" id="room-${room}" value="${room}" checked class="room-checkbox rounded border-gray-300 h-4 w-4 text-indigo-600 focus:ring-indigo-500">
                    <label for="room-${room}" class="ml-2 text-sm">${room}</label>
                </div>`;
        });

        updateRatePlans();
    };
    
    const updateRatePlans = async () => {
        if (!DOMElements.simRoomTypeSelect || !DOMElements.simPartnerSelect || !DOMElements.hotelIdSelect || 
            !DOMElements.simRatePlanSelect || !DOMElements.commissionLabel || !DOMElements.partnerDiscountLabel) {
            return;
        }

        const room = DOMElements.simRoomTypeSelect.value;
        const partner = DOMElements.simPartnerSelect.value;
        const hotelId = DOMElements.hotelIdSelect.value;
        
        if (!room || !hotelId) {
            DOMElements.simRatePlanSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
            return;
        }
        
        showSpinner();
        try {
            // Utiliser l'API des hôtels pour récupérer les plans
            const tariffData = await fetch(`${API_URL}/api/hotel/tariff-data?hotel_id=${encodeURIComponent(hotelId)}`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            
            if (!tariffData.ok) throw new Error('Erreur chargement plans');
            
            const data = await tariffData.json();
            const plans = data.data || [];
            
            // Filtrer les plans pour ce type de chambre
            const roomPlans = plans.filter(plan => plan.room_type === room).map(plan => plan.rate_plan);
            
            DOMElements.simRatePlanSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
            
            if (roomPlans.length > 0) {
                [...new Set(roomPlans)].sort().forEach(plan => {
                    DOMElements.simRatePlanSelect.innerHTML += `<option value="${plan}">${plan}</option>`;
                });
            } else {
                DOMElements.simRatePlanSelect.innerHTML = '<option value="">Aucun plan disponible</option>';
            }
            
            const partnerInfo = hotelConfig.partners?.[partner];
            if (partnerInfo) {
                DOMElements.commissionLabel.textContent = `Appliquer commission (${partnerInfo.commission || 0}%)`;
                DOMElements.partnerDiscountLabel.textContent = `Appliquer remise partenaire (${partnerInfo.defaultDiscount?.percentage || 0}%)`;
            } else {
                DOMElements.commissionLabel.textContent = `Appliquer commission (0%)`;
                DOMElements.partnerDiscountLabel.textContent = `Appliquer remise partenaire (0%)`;
            }
            
        } catch (error) {
            console.error('Erreur chargement plans:', error);
            DOMElements.simRatePlanSelect.innerHTML = '<option value="">Erreur chargement</option>';
            showToast('Erreur chargement des plans', true);
        } finally {
            hideSpinner();
        }
    };

    const handleSimulation = async (e) => {
        e.preventDefault();
        const payload = {
            hotel_id: DOMElements.hotelIdSelect.value,
            room: DOMElements.simRoomTypeSelect.value,
            plan: DOMElements.simRatePlanSelect.value,
            start: DOMElements.simStartDate.value,
            end: DOMElements.simEndDate.value,
            partner_name: DOMElements.simPartnerSelect.value || null,
            apply_commission: DOMElements.applyCommission.checked,
            apply_partner_discount: DOMElements.applyPartnerDiscount.checked,
            promo_discount: parseFloat(DOMElements.promoDiscount.value) || 0
        };
        
        if (!payload.start || !payload.end) return showToast("Les dates sont requises.", true);
        if (!payload.room) return showToast("Le type de chambre est requis.", true);
        if (!payload.plan) return showToast("Le plan tarifaire est requis.", true);
        
        showSpinner();
        try {
            const res = await fetch(`${API_URL}/api/simulations/simulate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(payload)
            });
            
            const result = await res.json();
            if (!res.ok) throw new Error(result.detail || 'Erreur de simulation');
            
            displayResults(result);
            showToast('Simulation terminée avec succès');
            
        } catch (error) {
            console.error('Erreur simulation:', error);
            showToast(error.message, true);
        } finally {
            hideSpinner();
        }
    };

    const displayResults = (data) => {
        currentSimulationData = data;
        DOMElements.resultsContainer.classList.remove('hidden');
        
        document.getElementById('simRoomName').textContent = data.simulation_info.room;
        document.getElementById('simSourceInfo').textContent = `Source: ${data.simulation_info.source}`;
        
        DOMElements.resultsTableBody.innerHTML = data.results.map(day => {
            const stockColor = (day.stock ?? 0) > 2 ? 'text-green-600' : (day.stock ?? 0) > 0 ? 'text-orange-500' : 'text-red-500';
            return `<tr class="hover:bg-gray-50">
                <td class="px-4 py-3 whitespace-nowrap">${day.date_display}</td>
                <td class="px-4 py-3 text-right whitespace-nowrap">${formatCurrency(day.gross_price)}</td>
                <td class="px-4 py-3 text-right font-semibold text-indigo-700 whitespace-nowrap">${formatCurrency(day.net_price)}</td>
                <td class="px-4 py-3 text-right font-medium ${stockColor} whitespace-nowrap">${day.stock ?? 'N/A'}</td>
                <td class="px-4 py-3 text-right whitespace-nowrap">${day.availability}</td>
            </tr>`;
        }).join('');
        
        const { summary } = data;
        document.getElementById('subtotalBrut').textContent = formatCurrency(summary.subtotal_brut);
        document.getElementById('totalDiscount').textContent = `- ${formatCurrency(summary.total_discount)}`;
        document.getElementById('totalCommission').textContent = `- ${formatCurrency(summary.total_commission)}`;
        document.getElementById('totalNetFinal').textContent = formatCurrency(summary.total_net);
    };

    const handleAvailability = async (e) => {
        e.preventDefault();
        const selectedRooms = Array.from(document.querySelectorAll('.room-checkbox:checked')).map(cb => cb.value);
        if (selectedRooms.length === 0) return showToast("Veuillez sélectionner au moins une chambre.", true);
        
        const payload = {
            hotel_id: DOMElements.hotelIdSelect.value,
            start_date: DOMElements.availStartDate.value,
            end_date: DOMElements.availEndDate.value,
            room_types: selectedRooms
        };
        
        if (!payload.start_date || !payload.end_date) return showToast("Les dates sont requises.", true);
        
        showSpinner();
        try {
            const res = await fetch(`${API_URL}/api/simulations/availability`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(payload)
            });
            
            const result = await res.json();
            if (!res.ok) throw new Error(result.detail || 'Erreur disponibilités');
            
            displayAvailabilityResults(result);
            showToast('Disponibilités chargées avec succès');
            
        } catch (error) {
            console.error('Erreur disponibilités:', error);
            showToast(error.message, true);
        } finally {
            hideSpinner();
        }
    };

    const displayAvailabilityResults = (data) => {
        DOMElements.availabilityResults.classList.remove('hidden');
        
        let tableHTML = `
            <table class="w-full text-sm sticky-table-header">
                <thead>
                    <tr>
                        <th class="px-4 py-3 text-left font-semibold text-gray-700 sticky left-0 bg-gray-50 z-10">Type de chambre</th>
        `;
        
        data.period.dates.forEach(date => {
            tableHTML += `<th class="px-2 py-2 text-center font-semibold text-gray-700 sticky top-0 bg-gray-50">${data.period.date_display[date]}</th>`;
        });
        
        tableHTML += '</tr></thead><tbody class="divide-y divide-gray-200">';
        
        Object.entries(data.availability).forEach(([roomName, dates]) => {
            tableHTML += '<tr class="hover:bg-gray-50">';
            tableHTML += `<td class="px-4 py-3 font-medium sticky left-0 bg-white z-10 whitespace-nowrap">${roomName}</td>`;
            
            data.period.dates.forEach(date => {
                const stock = dates[date];
                let bgColor = 'bg-red-100 text-red-800';
                if (stock > 0) bgColor = 'bg-orange-100 text-orange-800';
                if (stock > 2) bgColor = 'bg-green-100 text-green-800';
                tableHTML += `<td class="px-2 py-2 text-center font-semibold ${bgColor}">${stock}</td>`;
            });
            
            tableHTML += '</tr>';
        });
        
        tableHTML += '</tbody></table>';
        DOMElements.availabilityTableContainer.innerHTML = tableHTML;
    };

    const validateData = async () => {
        const hotelId = DOMElements.hotelIdSelect?.value;
        if (!hotelId) return showToast("Veuillez sélectionner un hôtel.", true);
        
        showSpinner();
        try {
            const response = await fetch(`${API_URL}/api/hotel/data-validation?hotel_id=${encodeURIComponent(hotelId)}`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            
            if (!response.ok) throw new Error('Erreur de validation');
            
            const data = await response.json();
            
            // Afficher les résultats
            let html = '';
            if (data.tariff_validation.issues.length === 0 && data.config_validation.issues.length === 0) {
                html = `
                    <div class="p-4 bg-green-100 border border-green-400 rounded-lg">
                        <div class="flex items-center">
                            <i data-feather="check-circle" class="mr-2 w-5 h-5 text-green-600"></i>
                            <span class="text-green-800 font-medium">Les données sont valides !</span>
                        </div>
                    </div>`;
            } else {
                html = '<div class="space-y-2">';
                if (data.tariff_validation.issues.length > 0) {
                    html += `
                        <div class="p-4 bg-red-100 border border-red-400 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i data-feather="alert-circle" class="mr-2 w-5 h-5 text-red-600"></i>
                                <span class="text-red-800 font-medium">Erreurs tarifaires</span>
                            </div>
                            <ul class="text-sm text-red-700 space-y-1">
                                ${data.tariff_validation.issues.map(issue => `<li>• ${issue}</li>`).join('')}
                            </ul>
                        </div>`;
                }
                if (data.config_validation.issues.length > 0) {
                    html += `
                        <div class="p-4 bg-red-100 border border-red-400 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i data-feather="alert-circle" class="mr-2 w-5 h-5 text-red-600"></i>
                                <span class="text-red-800 font-medium">Erreurs de configuration</span>
                            </div>
                            <ul class="text-sm text-red-700 space-y-1">
                                ${data.config_validation.issues.map(issue => `<li>• ${issue}</li>`).join('')}
                            </ul>
                        </div>`;
                }
                html += '</div>';
            }
            
            DOMElements.validationResults.innerHTML = html;
            DOMElements.validationResults.classList.remove('hidden');
            
            showToast('Validation terminée');
            
        } catch (error) {
            console.error('Erreur validation:', error);
            showToast(error.message, true);
        } finally {
            hideSpinner();
        }
    };

    const handleExport = async (type) => {
        const hotelId = DOMElements.hotelIdSelect?.value;
        if (!hotelId) return showToast("Veuillez sélectionner un hôtel.", true);
        
        showSpinner();
        try {
            let url = '';
            let filename = '';
            
            switch(type) {
                case 'tariff':
                    url = `${API_URL}/api/hotel/export/tariff?hotel_id=${encodeURIComponent(hotelId)}&format=csv`;
                    filename = `tarifs_${hotelId}.csv`;
                    break;
                case 'config':
                    url = `${API_URL}/api/hotel/export/config?hotel_id=${encodeURIComponent(hotelId)}&format=json`;
                    filename = `config_${hotelId}.json`;
                    break;
                case 'history':
                    url = `${API_URL}/api/hotel/history/updates?hotel_id=${encodeURIComponent(hotelId)}`;
                    filename = `historique_${hotelId}.json`;
                    break;
            }
            
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            
            if (!response.ok) throw new Error('Erreur export');
            
            const blob = await response.blob();
            const urlObj = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = urlObj;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(urlObj);
            document.body.removeChild(a);
            
            showToast(`Export ${type} réussi`);
            
        } catch (error) {
            console.error('Erreur export:', error);
            showToast(error.message, true);
        } finally {
            hideSpinner();
        }
    };
    
    // Gérer la déconnexion
    async function handleLogout() {
        try {
            await supabase.auth.signOut();
            localStorage.removeItem('hotelvision_token');
            localStorage.removeItem('hotelvision_user');
            window.location.href = '/login';
        } catch (error) {
            console.error('Erreur de déconnexion:', error);
            showToast('Erreur lors de la déconnexion', true);
        }
    }
    
    // Event listeners
    DOMElements.refreshDataBtn.addEventListener('click', loadData);
    DOMElements.simRoomTypeSelect.addEventListener('change', updateRatePlans);
    DOMElements.simPartnerSelect.addEventListener('change', updateRatePlans);
    DOMElements.simulationForm.addEventListener('submit', handleSimulation);
    DOMElements.availabilityForm.addEventListener('submit', handleAvailability);
    DOMElements.newSimulationBtn.addEventListener('click', () => DOMElements.resultsContainer.classList.add('hidden'));
    DOMElements.logoutBtn.addEventListener('click', handleLogout);
    DOMElements.validateDataBtn.addEventListener('click', validateData);
    DOMElements.exportTariffBtn.addEventListener('click', () => handleExport('tariff'));
    DOMElements.exportConfigBtn.addEventListener('click', () => handleExport('config'));
    DOMElements.exportHistoryBtn.addEventListener('click', () => handleExport('history'));
    
    DOMElements.selectAllRoomsBtn.addEventListener('click', () => {
        document.querySelectorAll('.room-checkbox').forEach(cb => cb.checked = true);
    });
    
    DOMElements.deselectAllRoomsBtn.addEventListener('click', () => {
        document.querySelectorAll('.room-checkbox').forEach(cb => cb.checked = false);
    });
    
    document.querySelectorAll('.tab-link').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.tab-link').forEach(btn => btn.classList.remove('tab-active'));
            button.classList.add('tab-active');
            document.querySelectorAll('[id^="tab-content-"]').forEach(content => content.classList.add('hidden'));
            document.getElementById(`tab-content-${button.dataset.tab}`).classList.remove('hidden');
        });
    });

    // Initialisation des dates
    const today = new Date();
    const nextWeek = new Date(new Date().setDate(today.getDate() + 7));
    [DOMElements.simStartDate, DOMElements.availStartDate].forEach(el => el.value = today.toISOString().split('T')[0]);
    [DOMElements.simEndDate, DOMElements.availEndDate].forEach(el => el.value = nextWeek.toISOString().split('T')[0]);
    
    // Vérifier l'authentification au chargement de la page
    checkAuth();
    feather.replace();
});
</script>
</body>
</html>
