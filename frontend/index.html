<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Simulateur RM - Folkestone Opera</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bg: "#0b1220",
            card: "#121a2b",
            border: "#1d2740",
            text: "#ecf1f6",
            accent: "#facc15",
            muted: "#9aa4b6",
            success: "#6ee7b7",
            danger: "#ef4444"
          },
          boxShadow: {
            card: "0 10px 25px rgba(0,0,0,.25)"
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial}
    .scroll-slim::-webkit-scrollbar{height:8px;width:8px}
    .scroll-slim::-webkit-scrollbar-thumb{background:#223054;border-radius:999px}
  </style>
</head>
<body class="bg-bg text-text">
  <header class="p-6 border-b border-border flex items-center justify-between">
    <h1 class="text-xl font-semibold">üè® Simulateur de Revenue Management</h1>
    <button id="openSettings" class="text-sm text-muted hover:text-accent">‚öôÔ∏è Param√®tres</button>
  </header>

  <main class="p-6 max-w-6xl mx-auto space-y-6">
    <!-- HOTEL SELECTION -->
    <section class="glass border border-border rounded-2xl shadow-card p-6">
      <h2 class="font-semibold text-lg mb-4">Choix de l'h√¥tel</h2>
      <div class="flex flex-col md:flex-row items-center gap-4">
        <select id="hotelSelect" class="flex-1 px-4 py-2 rounded-lg bg-card border border-border text-text">
          <option value="">Chargement...</option>
        </select>
        <button id="simulateBtn" class="px-4 py-2 bg-accent text-black font-semibold rounded-lg hover:brightness-110">Lancer la Simulation</button>
      </div>
    </section>

    <!-- SIMULATION RESULT -->
    <section id="resultsSection" class="glass border border-border rounded-2xl shadow-card p-6 hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-semibold text-lg">R√©sultats de la Simulation</h2>
        <div class="flex gap-2">
          <button id="exportExcelBtn" class="px-3 py-2 text-sm bg-card border border-border rounded-lg hover:bg-card/80">üìä Export Excel</button>
          <button id="exportPdfBtn" class="px-3 py-2 text-sm bg-card border border-border rounded-lg hover:bg-card/80">üßæ Export PDF</button>
        </div>
      </div>
      <div class="overflow-auto scroll-slim">
        <table id="resultsTable" class="min-w-full text-sm border-collapse border border-border">
          <thead class="bg-card">
            <tr>
              <th class="border border-border px-3 py-2 text-left">OTA</th>
              <th class="border border-border px-3 py-2 text-left">Type Chambre</th>
              <th class="border border-border px-3 py-2 text-right">Tarif (‚Ç¨)</th>
              <th class="border border-border px-3 py-2 text-right">Remise (%)</th>
              <th class="border border-border px-3 py-2 text-right">Commission (%)</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>
      <div class="mt-4 text-right text-sm text-muted" id="summaryStats"></div>
    </section>

    <!-- AVAILABILITIES -->
    <section id="availSection" class="glass border border-border rounded-2xl shadow-card p-6 hidden">
      <h2 class="font-semibold text-lg mb-4">Mes disponibilit√©s</h2>
      <div class="overflow-auto scroll-slim">
        <table id="availTable" class="min-w-full text-sm border-collapse border border-border">
          <thead class="bg-card">
            <tr>
              <th class="border border-border px-3 py-2 text-left">Type de Chambre</th>
              <th class="border border-border px-3 py-2 text-right">Disponibles</th>
            </tr>
          </thead>
          <tbody id="availBody"></tbody>
        </table>
      </div>
      <div class="mt-4 text-right text-sm text-muted" id="availSummary"></div>
    </section>
  </main>

  <!-- SETTINGS MODAL -->
  <div id="settingsModal" class="fixed inset-0 bg-black/70 flex items-center justify-center hidden">
    <div class="bg-card border border-border rounded-2xl p-6 w-full max-w-md shadow-card">
      <h2 class="text-lg font-semibold mb-3">‚öôÔ∏è Param√®tres</h2>
      <label class="text-sm text-muted">API Base URL</label>
      <input id="apiBaseInput" class="w-full mt-1 mb-3 px-3 py-2 bg-bg border border-border rounded-lg" placeholder="https://api-folkestone.e-hotelmanager.com">
      <label class="text-sm text-muted">Admin Token (optionnel)</label>
      <input id="adminTokenInput" type="password" class="w-full mt-1 mb-4 px-3 py-2 bg-bg border border-border rounded-lg" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <div class="flex justify-end gap-2">
        <button id="closeSettings" class="px-3 py-2 border border-border rounded-lg">Annuler</button>
        <button id="saveSettings" class="px-3 py-2 bg-accent text-black rounded-lg font-semibold">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-5 right-5 px-4 py-2 rounded-lg text-white font-medium shadow-lg hidden"></div>

  <script>
    const $ = s => document.querySelector(s);
    const LS = {
      get API(){ return localStorage.getItem('API_BASE') || defaultApiBase(); },
      set API(v){ localStorage.setItem('API_BASE', v); },
      get TOKEN(){ return localStorage.getItem('ADMIN_TOKEN') || ''; },
      set TOKEN(v){ localStorage.setItem('ADMIN_TOKEN', v); }
    };

    const defaultApiBase = () => {
      const h = window.location.host;
      if(h.startsWith('folkestone.')) return window.location.protocol + '//' + h.replace('folkestone.','api-folkestone.');
      if(h.startsWith('admin-')) return window.location.protocol + '//' + h.replace('admin-','api-');
      return window.location.origin;
    }

    const toast = (msg, ok=true) => {
      const t = $('#toast');
      t.textContent = msg;
      t.className = `fixed bottom-5 right-5 px-4 py-2 rounded-lg text-white font-medium shadow-lg ${ok?'bg-green-600':'bg-red-600'}`;
      t.classList.remove('hidden');
      setTimeout(()=>t.classList.add('hidden'),3000);
    };

    // Load hotels
    async function loadHotels(){
      try{
        const r = await fetch(LS.API.replace(/\/$/,'') + '/hotels');
        const j = await r.json();
        $('#hotelSelect').innerHTML = j.map(h=>`<option value="${h}">${h}</option>`).join('');
      }catch(e){
        $('#hotelSelect').innerHTML = '<option value="">Erreur API</option>';
        toast('Impossible de charger les h√¥tels', false);
      }
    }

    async function simulate(){
      const hotelId = $('#hotelSelect').value;
      if(!hotelId){ toast("Choisissez un h√¥tel", false); return; }
      $('#simulateBtn').disabled = true;
      $('#simulateBtn').textContent = 'Simulation en cours...';
      try{
        const res = await fetch(LS.API.replace(/\/$/,'') + '/simulate?hotel_id=' + encodeURIComponent(hotelId));
        const j = await res.json();
        showResults(j, hotelId);
      }catch(e){
        toast('Erreur lors de la simulation', false);
      }finally{
        $('#simulateBtn').disabled = false;
        $('#simulateBtn').textContent = 'Lancer la Simulation';
      }
    }

    function showResults(data, hotelId){
      $('#resultsSection').classList.remove('hidden');
      const body = $('#resultsBody'); body.innerHTML = '';
      const rows = data.results || [];
      if(rows.length===0){ body.innerHTML = '<tr><td colspan="5" class="px-3 py-3 text-center text-muted">Aucune donn√©e</td></tr>'; return; }
      let total = 0;
      for(const r of rows){
        body.innerHTML += `
          <tr>
            <td class="border border-border px-3 py-2">${r.ota||'-'}</td>
            <td class="border border-border px-3 py-2">${r.room_type||'-'}</td>
            <td class="border border-border px-3 py-2 text-right">${r.price?.toFixed(2)||'-'}</td>
            <td class="border border-border px-3 py-2 text-right">${r.discount||0}</td>
            <td class="border border-border px-3 py-2 text-right">${r.commission||0}</td>
          </tr>`;
        total += r.price||0;
      }
      $('#summaryStats').textContent = `Nombre de lignes: ${rows.length} | Tarif moyen: ${(total/rows.length).toFixed(2)} ‚Ç¨`;
      if(data.availability){
        showAvailability(data.availability);
      }
      // keep current data for export
      window.lastSimulation = {hotelId, results: rows, availability: data.availability||[]};
    }

    function showAvailability(avail){
      $('#availSection').classList.remove('hidden');
      const b = $('#availBody'); b.innerHTML='';
      let total=0;
      for(const r of avail){
        b.innerHTML += `<tr><td class="border border-border px-3 py-2">${r.room}</td><td class="border border-border px-3 py-2 text-right">${r.available}</td></tr>`;
        total += r.available;
      }
      $('#availSummary').textContent = `Total chambres disponibles: ${total}`;
    }

    async function exportExcel(){
      if(!window.lastSimulation){ toast('Aucune simulation √† exporter', false); return; }
      const r = await fetch(LS.API.replace(/\/$/,'') + '/export/excel', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(window.lastSimulation)
      });
      if(!r.ok){ toast('Erreur export Excel', false); return; }
      const blob = await r.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `simulation_${window.lastSimulation.hotelId}.xlsx`;
      a.click(); URL.revokeObjectURL(a.href);
      toast('Export Excel t√©l√©charg√©');
    }

    async function exportPdf(){
      if(!window.lastSimulation){ toast('Aucune simulation √† exporter', false); return; }
      const r = await fetch(LS.API.replace(/\/$/,'') + '/export/pdf', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(window.lastSimulation)
      });
      if(!r.ok){ toast('Erreur export PDF', false); return; }
      const blob = await r.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `simulation_${window.lastSimulation.hotelId}.pdf`;
      a.click(); URL.revokeObjectURL(a.href);
      toast('Export PDF t√©l√©charg√©');
    }

    // Settings modal
    $('#openSettings').addEventListener('click', ()=> $('#settingsModal').classList.remove('hidden'));
    $('#closeSettings').addEventListener('click', ()=> $('#settingsModal').classList.add('hidden'));
    $('#saveSettings').addEventListener('click', ()=>{
      LS.API = $('#apiBaseInput').value.trim() || defaultApiBase();
      LS.TOKEN = $('#adminTokenInput').value.trim();
      $('#settingsModal').classList.add('hidden');
      toast('Param√®tres enregistr√©s');
    });

    // Events
    $('#simulateBtn').addEventListener('click', simulate);
    $('#exportExcelBtn').addEventListener('click', exportExcel);
    $('#exportPdfBtn').addEventListener('click', exportPdf);

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
      $('#apiBaseInput').value = LS.API;
      $('#adminTokenInput').value = LS.TOKEN;
      loadHotels();
    });
  </script>
</body>
</html>
