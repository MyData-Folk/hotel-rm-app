<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur - RM Hôtel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-100 font-sans">
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center"><i class="fas fa-chart-line text-indigo-600 text-2xl mr-3"></i><h1 class="text-xl font-bold">Simulateur de Réservation</h1></div>
            <a href="https://admin-folkestone.e-hotelmanager.com" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 transition flex items-center"><i class="fas fa-cogs mr-2"></i><span>Gérer la Configuration</span></a>
        </div>
    </header>
    <main class="container mx-auto px-6 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="hotelId" class="block text-sm font-medium text-gray-700 mb-1">ID de l'hôtel</label>
                    <div class="flex">
                        <input type="text" id="hotelId" value="folkestone" class="w-full px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        <button id="refreshDataBtn" class="bg-purple-600 text-white px-4 py-2 rounded-r-md hover:bg-purple-700 transition"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>
                <div class="md:col-span-2 flex items-center bg-indigo-50 p-3 rounded-md">
                    <i class="fas fa-info-circle text-indigo-600 mr-3"></i>
                    <p id="statusMessage" class="text-sm text-gray-700">Cliquez sur <i class="fas fa-sync-alt"></i> pour charger/actualiser les données.</p>
                </div>
            </div>
        </div>
        <div id="main-content" class="opacity-50 pointer-events-none">
            <form id="simulationForm" class="bg-white rounded-lg shadow-lg p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                    <div><label for="simPartner" class="block text-sm font-medium text-gray-700 mb-1">Partenaire</label><select id="simPartner" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white"></select></div>
                    <div><label for="simRoomType" class="block text-sm font-medium text-gray-700 mb-1">Chambre</label><select id="simRoomType" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white"></select></div>
                    <div><label for="simRatePlan" class="block text-sm font-medium text-gray-700 mb-1">Tarif</label><select id="simRatePlan" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white"></select></div>
                    <div><label for="simStartDate" class="block text-sm font-medium text-gray-700 mb-1">Arrivée</label><input type="date" id="simStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <div><label for="simEndDate" class="block text-sm font-medium text-gray-700 mb-1">Départ</label><input type="date" id="simEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                </div>
                <div class="mt-6 text-right"><button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-md hover:bg-indigo-700 transition">Lancer la Simulation</button></div>
            </form>
            <div id="resultsContainer" class="mt-8 hidden">
                <h2 class="text-xl font-semibold mb-4">Résultats de la Simulation</h2>
                <div class="bg-white rounded-lg shadow-lg overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-gray-50 text-xs text-gray-500 uppercase tracking-wider"><tr><th class="px-6 py-3">Date</th><th class="px-6 py-3 text-right">Stock</th><th class="px-6 py-3 text-right">Prix Brut</th><th class="px-6 py-3 text-right">Commission</th><th class="px-6 py-3 text-right font-bold">Prix Net</th></tr></thead><tbody id="resultsTableBody" class="divide-y divide-gray-200"></tbody><tfoot id="resultsTableFoot" class="bg-gray-50 font-bold"></tfoot></table></div></div>
            </div>
        </div>
    </main>
    <div id="spinner-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="spinner"></div></div>
    <div id="toast" class="toast"></div>
    <script>
        const API_URL = 'https://api-folkestone.e-hotelmanager.com';
        let hotelData = {}, hotelConfig = {};
        const refreshDataBtn = document.getElementById('refreshDataBtn'), hotelIdInput = document.getElementById('hotelId'), statusMessage = document.getElementById('statusMessage'), mainContent = document.getElementById('main-content');
        const simPartnerSelect = document.getElementById('simPartner'), simRoomTypeSelect = document.getElementById('simRoomType'), simRatePlanSelect = document.getElementById('simRatePlan'), simulationForm = document.getElementById('simulationForm');
        const resultsContainer = document.getElementById('resultsContainer'), resultsTableBody = document.getElementById('resultsTableBody'), resultsTableFoot = document.getElementById('resultsTableFoot');
        const spinner = document.getElementById('spinner-overlay'), toastContainer = document.getElementById('toast');

        const showSpinner = () => spinner.classList.remove('hidden'); const hideSpinner = () => spinner.classList.add('hidden');
        const showToast = (message, isError = false) => {
            toastContainer.className = `toast show ${isError ? 'bg-red-500 text-white p-3 rounded-lg shadow-lg' : 'bg-green-500 text-white p-3 rounded-lg'}`;
            toastContainer.innerHTML = `<i class="fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'} mr-2"></i> ${message}`;
            setTimeout(() => toastContainer.classList.remove('show'), 3000);
        };
        const loadData = async () => {
            const hotelId = hotelIdInput.value; if (!hotelId) return showToast("ID d'hôtel requis.", true);
            showSpinner(); statusMessage.textContent = 'Chargement...'; mainContent.classList.add('opacity-50', 'pointer-events-none');
            try {
                const [dataRes, configRes] = await Promise.all([fetch(`${API_URL}/data?hotel_id=${hotelId}`), fetch(`${API_URL}/config?hotel_id=${hotelId}`)]);
                if (!dataRes.ok) throw new Error(`Données de planning introuvables`);
                if (!configRes.ok) throw new Error(`Données de configuration introuvables`);
                hotelData = await dataRes.json(); hotelConfig = await configRes.json();
                populateSelectors(); statusMessage.textContent = `Données pour "${hotelId}" chargées. Prêt à simuler.`;
                showToast('Données actualisées !'); mainContent.classList.remove('opacity-50', 'pointer-events-none');
            } catch (error) { statusMessage.innerHTML = `Erreur: ${error.message}`; showToast(error.message, true); }
            finally { hideSpinner(); }
        };
        const populateSelectors = () => {
            simPartnerSelect.innerHTML = '<option value="">En Direct (0%)</option>';
            Object.entries(hotelConfig.partners || {}).sort((a, b) => a[0].localeCompare(b[0])).forEach(([name, data]) => simPartnerSelect.innerHTML += `<option value="${name}">${name} (${data.commission}%)</option>`);
            simRoomTypeSelect.innerHTML = '';
            (hotelConfig.displayOrder?.rooms || Object.keys(hotelData)).filter(r => hotelData[r]).forEach(room => simRoomTypeSelect.innerHTML += `<option value="${room}">${room}</option>`);
            updateRatePlans();
        };
        const updateRatePlans = () => {
            simRatePlanSelect.innerHTML = '';
            const selectedRoom = simRoomTypeSelect.value;
            const selectedPartner = simPartnerSelect.value;
            if (hotelData[selectedRoom]?.plans) {
                let allPlans = Object.keys(hotelData[selectedRoom].plans);
                const partnerCodes = hotelConfig.partners?.[selectedPartner]?.codes;
                if(selectedPartner && partnerCodes && partnerCodes.length > 0) {
                     allPlans = allPlans.filter(plan => partnerCodes.includes(plan));
                }
                (hotelConfig.displayOrder?.plans || allPlans).filter(p => allPlans.includes(p)).forEach(plan => simRatePlanSelect.innerHTML += `<option value="${plan}">${plan}</option>`);
            }
        };
        const handleSimulation = async (e) => {
            e.preventDefault();
            const payload = { hotel_id: hotelIdInput.value, room: simRoomTypeSelect.value, plan: simRatePlanSelect.value, start: document.getElementById('simStartDate').value, end: document.getElementById('simEndDate').value, partner_name: simPartnerSelect.value };
            if (!payload.start || !payload.end || !payload.room || !payload.plan) return showToast("Tous les champs de simulation sont requis.", true);
            showSpinner();
            try {
                const response = await fetch(`${API_URL}/simulate`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json(); if (!response.ok) throw new Error(result.detail || 'Erreur');
                displayResults(result);
            } catch (error) { showToast(error.message, true); } finally { hideSpinner(); }
        };
        const displayResults = (data) => {
            resultsTableBody.innerHTML = '';
            if (!data.results?.length) {
                resultsTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-6 text-gray-500">Aucune donnée disponible.</td></tr>';
                resultsTableFoot.innerHTML = ''; resultsContainer.classList.remove('hidden'); return;
            }
            const formatCurrency = (val) => val != null ? val.toFixed(2).replace('.', ',') + ' €' : '–';
            data.results.forEach(day => {
                const stockColor = (day.stock ?? 0) > 5 ? 'text-green-600' : ((day.stock ?? 0) > 0 ? 'text-orange-500' : 'text-red-500');
                resultsTableBody.innerHTML += `<tr><td class="px-6 py-4">${day.date}</td><td class="px-6 py-4 text-right font-medium ${stockColor}">${day.stock ?? 'N/A'}</td><td class="px-6 py-4 text-right">${formatCurrency(day.price)}</td><td class="px-6 py-4 text-right">${formatCurrency(day.commission)}</td><td class="px-6 py-4 text-right font-bold text-indigo-600">${formatCurrency(day.net_price)}</td></tr>`;
            });
            resultsTableFoot.innerHTML = `<tr><td class="px-6 py-4 font-bold">Total</td><td></td><td class="px-6 py-4 text-right font-bold">${formatCurrency(data.summary.subtotal)}</td><td class="px-6 py-4 text-right font-bold">${formatCurrency(data.summary.total_commission)}</td><td class="px-6 py-4 text-right font-bold text-indigo-600">${formatCurrency(data.summary.total_net)}</td></tr>`;
            resultsContainer.classList.remove('hidden');
        };
        
        refreshDataBtn.addEventListener('click', loadData);
        simPartnerSelect.addEventListener('change', updateRatePlans);
        simRoomTypeSelect.addEventListener('change', updateRatePlans);
        simulationForm.addEventListener('submit', handleSimulation);
        
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>