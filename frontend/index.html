<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HotelVision - Plateforme de Gestion Hôtelière Intelligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Poppins', sans-serif;
        }
        #vanta-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.15;
        }
        .gradient-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }
        .btn-gradient-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transition: all 0.3s ease;
        }
        .btn-gradient-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -10px rgba(79, 70, 229, 0.6);
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
        }
        .tab-link {
            transition: all 0.3s ease;
        }
        .tab-link.tab-active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .form-input {
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
        }
        .form-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #4f46e5;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .sticky-table-header th {
            position: sticky;
            top: 0;
            background-color: #f8fafc;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="vanta-bg"></div>
    
    <header class="gradient-header text-white shadow-lg">
        <div class="container mx-auto px-4 py-8 text-center">
            <div class="flex items-center justify-center space-x-3">
                <i data-feather="home" class="w-8 h-8"></i>
                <h1 class="text-3xl md:text-4xl font-bold">HotelVision</h1>
            </div>
            <p id="header-subtitle" class="mt-2 text-lg text-blue-100">Simulateur Avancé & Gestion des Disponibilités</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="card p-6 md:p-8 mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex-grow w-full md:w-auto">
                    <label for="hotelId" class="block text-sm font-medium text-gray-700 mb-2">
                        <i data-feather="hotel" class="inline mr-2 w-4 h-4"></i> Sélectionnez votre hôtel :
                    </label>
                    <div class="flex">
                        <select id="hotelId" class="form-input rounded-r-none flex-grow px-4 py-2">
                            <option value="">-- Sélectionner --</option>
                        </select>
                        <button id="refreshDataBtn" class="btn btn-gradient-primary rounded-l-none px-4 py-2 flex items-center" title="Charger/Rafraîchir les données">
                            <i data-feather="refresh-cw" class="mr-2 w-4 h-4"></i> Rafraîchir
                        </button>
                    </div>
                </div>
                <div class="flex items-center gap-4 mt-4 md:mt-0">
                    <a href="https://admin-folkestone.e-hotelmanager.com" class="btn btn-secondary flex items-center px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">
                        <i data-feather="settings" class="mr-2 w-4 h-4"></i> Paramètres
                    </a>
                </div>
            </div>
            <p id="statusMessage" class="text-sm text-gray-600 mt-4 flex items-center">
                <i data-feather="info" class="mr-2 w-4 h-4"></i> Veuillez sélectionner un hôtel et cliquer sur rafraîchir.
            </p>
        </div>

        <div id="main-tools" class="card p-0 opacity-50 pointer-events-none transition-all duration-300">
            <div class="flex border-b border-gray-200">
                <button class="tab-link tab-active px-6 py-4" data-tab="simulator">
                    <i data-feather="calendar" class="mr-2 w-4 h-4"></i> Simulateur
                </button>
                <button class="tab-link px-6 py-4" data-tab="availability">
                    <i data-feather="check-circle" class="mr-2 w-4 h-4"></i> Disponibilités
                </button>
            </div>
            
            <div id="tab-content-simulator" class="p-6 md:p-8">
                <form id="simulationForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 items-end">
                    <div>
                        <label for="simPartner" class="block text-sm font-medium mb-1 flex items-center">
                            <i data-feather="users" class="mr-2 w-4 h-4"></i> Partenaire
                        </label>
                        <select id="simPartner" class="form-input w-full px-4 py-2">
                            <option value="">En Direct (0%)</option>
                        </select>
                    </div>
                    <div>
                        <label for="simRoomType" class="block text-sm font-medium mb-1 flex items-center">
                            <i data-feather="home" class="mr-2 w-4 h-4"></i> Type de chambre
                        </label>
                        <select id="simRoomType" class="form-input w-full px-4 py-2">
                            <option value="">-- Sélectionner --</option>
                        </select>
                    </div>
                    <div>
                        <label for="simRatePlan" class="block text-sm font-medium mb-1 flex items-center">
                            <i data-feather="dollar-sign" class="mr-2 w-4 h-4"></i> Plan tarifaire
                        </label>
                        <select id="simRatePlan" class="form-input w-full px-4 py-2">
                            <option value="">-- Sélectionner --</option>
                        </select>
                    </div>
                    <div>
                        <label for="simStartDate" class="block text-sm font-medium mb-1 flex items-center">
                            <i data-feather="calendar" class="mr-2 w-4 h-4"></i> Date d'arrivée
                        </label>
                        <input type="date" id="simStartDate" class="form-input w-full px-4 py-2">
                    </div>
                    <div>
                        <label for="simEndDate" class="block text-sm font-medium mb-1 flex items-center">
                            <i data-feather="calendar" class="mr-2 w-4 h-4"></i> Date de départ
                        </label>
                        <input type="date" id="simEndDate" class="form-input w-full px-4 py-2">
                    </div>
                    <div class="flex items-end">
                        <button type="submit" class="btn btn-gradient-primary w-full px-4 py-2 rounded-md text-white font-medium flex items-center justify-center">
                            <i data-feather="zap" class="mr-2 w-4 h-4"></i> Simuler
                        </button>
                    </div>
                </form>

                <div class="flex flex-col md:flex-row items-start md:items-center gap-4 mt-6 p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="applyCommission" checked class="rounded border-gray-300 h-4 w-4 text-indigo-600 focus:ring-indigo-500">
                        <label for="applyCommission" class="text-sm font-medium" id="commissionLabel">Appliquer commission (0%)</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="applyPartnerDiscount" checked class="rounded border-gray-300 h-4 w-4 text-indigo-600 focus:ring-indigo-500">
                        <label for="applyPartnerDiscount" class="text-sm font-medium" id="partnerDiscountLabel">Appliquer remise partenaire (0%)</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="promoDiscount" class="text-sm font-medium">Remise (%):</label>
                        <input type="number" id="promoDiscount" min="0" max="100" value="0" class="w-20 px-2 py-1 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
            </div>

            <div id="tab-content-availability" class="p-6 md:p-8 hidden">
                <form id="availabilityForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1 flex items-center">
                            <i data-feather="grid" class="mr-2 w-4 h-4"></i> Types de chambres
                        </label>
                        <div id="availRoomTypesContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 p-4 border rounded-lg bg-gray-50">
                            <!-- Les cases à cocher seront générées ici -->
                        </div>
                        <div class="flex gap-2 mt-2">
                          <button type="button" id="selectAllRoomsBtn" class="text-xs text-indigo-600 hover:text-indigo-800 flex items-center">
                            <i data-feather="check-square" class="mr-1 w-3 h-3"></i> Tout sélectionner
                          </button>
                          <span>/</span>
                          <button type="button" id="deselectAllRoomsBtn" class="text-xs text-indigo-600 hover:text-indigo-800 flex items-center">
                            <i data-feather="square" class="mr-1 w-3 h-3"></i> Tout désélectionner
                          </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                         <div>
                             <label for="availStartDate" class="block text-sm font-medium mb-1 flex items-center">
                                 <i data-feather="calendar" class="mr-2 w-4 h-4"></i> Date de début
                             </label>
                             <input type="date" id="availStartDate" class="form-input w-full px-4 py-2">
                         </div>
                         <div>
                             <label for="availEndDate" class="block text-sm font-medium mb-1 flex items-center">
                                 <i data-feather="calendar" class="mr-2 w-4 h-4"></i> Date de fin
                             </label>
                             <input type="date" id="availEndDate" class="form-input w-full px-4 py-2">
                         </div>
                         <div class="flex items-end">
                             <button type="submit" class="btn btn-gradient-primary w-full px-4 py-2 rounded-md text-white font-medium flex items-center justify-center">
                                 <i data-feather="search" class="mr-2 w-4 h-4"></i> Vérifier
                             </button>
                         </div>
                    </div>
                </form>
                <div id="availabilityResults" class="mt-6 hidden">
                    <div class="flex justify-between items-center border-b pb-4 mb-4">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center">
                            <i data-feather="list" class="mr-2 w-5 h-5"></i> Tableau des Disponibilités
                        </h2>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <button id="availabilityExcelBtn" class="btn btn-gradient-primary px-4 py-2 rounded-md text-white font-medium flex items-center justify-center">
                                <i data-feather="download" class="mr-2 w-4 h-4"></i> Excel (XLSM)
                            </button>
                            <button id="availabilityPdfBtn" class="px-4 py-2 border border-indigo-600 text-indigo-600 rounded-md shadow-sm text-sm font-medium hover:bg-indigo-50 flex items-center justify-center">
                                <i data-feather="file-text" class="mr-2 w-4 h-4"></i> PDF
                            </button>
                        </div>
                    </div>
                    <div id="availabilityTableContainer" class="overflow-x-auto relative max-h-[500px] overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <div id="resultsContainer" class="card mt-8 hidden animate-fade-in">
            <div class="border-b pb-4 mb-6">
                <h2 class="text-xl font-bold text-gray-800 flex items-center">
                    <i data-feather="file-text" class="mr-2 w-5 h-5"></i> Simulation : <span id="simRoomName" class="ml-1">-</span>
                </h2>
                <p class="text-sm text-gray-600 mt-1 flex items-center" id="simSourceInfo">
                    <i data-feather="info" class="mr-2 w-4 h-4"></i> Source: -
                </p>
            </div>
            <div class="overflow-x-auto relative max-h-[500px] overflow-y-auto">
                <table class="w-full text-sm sticky-table-header">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">Date</th>
                            <th class="px-4 py-3 text-right font-semibold text-gray-700">Prix Brut (€)</th>
                            <th class="px-4 py-3 text-right font-semibold text-gray-700">Prix Net (€)</th>
                            <th class="px-4 py-3 text-right font-semibold text-gray-700">Stock</th>
                            <th class="px-4 py-3 text-right font-semibold text-gray-700">Disponibilité</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div class="mt-6 p-4 bg-gray-50 rounded-lg grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i data-feather="calculator" class="mr-2 w-4 h-4"></i> Détail des calculs
                    </h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Sous-Total Brut:</span>
                            <span id="subtotalBrut" class="font-semibold">- €</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Remises & Promos:</span>
                            <span id="totalDiscount" class="font-semibold text-green-600">- €</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Total Commission:</span>
                            <span id="totalCommission" class="font-semibold text-red-600">- €</span>
                        </div>
                    </div>
                </div>
                <div class="border-l pl-6">
                    <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i data-feather="credit-card" class="mr-2 w-4 h-4"></i> Total Net Final
                    </h3>
                    <div id="totalNetFinal" class="text-2xl font-bold text-indigo-700">- €</div>
                </div>
            </div>
            <div class="mt-6 flex flex-col lg:flex-row justify-between gap-4">
                <button id="newSimulationBtn" class="btn btn-secondary px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 flex items-center justify-center self-start">
                    <i data-feather="plus" class="mr-2 w-4 h-4"></i> Nouvelle Simulation
                </button>
                <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
                    <button id="exportSimulationExcelBtn" class="btn btn-gradient-primary px-4 py-2 rounded-md text-white font-medium flex items-center justify-center">
                        <i data-feather="download" class="mr-2 w-4 h-4"></i> Exporter en Excel (XLSM)
                    </button>
                    <button id="exportSimulationPdfBtn" class="px-4 py-2 border border-indigo-600 text-indigo-600 rounded-md shadow-sm text-sm font-medium hover:bg-indigo-50 flex items-center justify-center">
                        <i data-feather="file-text" class="mr-2 w-4 h-4"></i> Exporter en PDF
                    </button>
                </div>
            </div>
        </div>
    </main>
  
    <div id="spinner-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="spinner"></div>
    </div>
    <div id="toast" class="toast"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Initialisation de Vanta.js pour l'arrière-plan
    VANTA.NET({
        el: "#vanta-bg",
        color: 0x4f46e5,
        backgroundColor: 0xf8fafc,
        points: 12,
        maxDistance: 20,
        spacing: 15
    });

    const API_URL = 'https://api-folkestone.e-hotelmanager.com';
    let hotelData = {}, hotelConfig = {}, currentSimulationData = null;

    const DOMElements = {
        hotelIdSelect: document.getElementById('hotelId'),
        refreshDataBtn: document.getElementById('refreshDataBtn'),
        statusMessage: document.getElementById('statusMessage'),
        mainTools: document.getElementById('main-tools'),
        simPartnerSelect: document.getElementById('simPartner'),
        simRoomTypeSelect: document.getElementById('simRoomType'),
        simRatePlanSelect: document.getElementById('simRatePlan'),
        simulationForm: document.getElementById('simulationForm'),
        simStartDate: document.getElementById('simStartDate'),
        simEndDate: document.getElementById('simEndDate'),
        resultsContainer: document.getElementById('resultsContainer'),
        resultsTableBody: document.getElementById('resultsTableBody'),
        spinner: document.getElementById('spinner-overlay'),
        toast: document.getElementById('toast'),
        applyCommission: document.getElementById('applyCommission'),
        applyPartnerDiscount: document.getElementById('applyPartnerDiscount'),
        promoDiscount: document.getElementById('promoDiscount'),
        exportSimulationExcelBtn: document.getElementById('exportSimulationExcelBtn'),
        exportSimulationPdfBtn: document.getElementById('exportSimulationPdfBtn'),
        newSimulationBtn: document.getElementById('newSimulationBtn'),
        availabilityForm: document.getElementById('availabilityForm'),
        availRoomTypesContainer: document.getElementById('availRoomTypesContainer'),
        availStartDate: document.getElementById('availStartDate'),
        availEndDate: document.getElementById('availEndDate'),
        availabilityResults: document.getElementById('availabilityResults'),
        availabilityTableContainer: document.getElementById('availabilityTableContainer'),
        availabilityExcelBtn: document.getElementById('availabilityExcelBtn'),
        availabilityPdfBtn: document.getElementById('availabilityPdfBtn'),
        selectAllRoomsBtn: document.getElementById('selectAllRoomsBtn'),
        deselectAllRoomsBtn: document.getElementById('deselectAllRoomsBtn'),
        commissionLabel: document.getElementById('commissionLabel'),
        partnerDiscountLabel: document.getElementById('partnerDiscountLabel')
    };

    let currentAvailabilityData = null;

    const showSpinner = () => {
        if (DOMElements.spinner) DOMElements.spinner.classList.remove('hidden');
    };
    
    const hideSpinner = () => {
        if (DOMElements.spinner) DOMElements.spinner.classList.add('hidden');
    };
    
    const showToast = (message, isError = false) => {
        if (!DOMElements.toast) return;
        DOMElements.toast.textContent = message;
        DOMElements.toast.className = `toast show ${isError ? 'bg-red-500' : 'bg-green-600'}`;
        setTimeout(() => {
            if (DOMElements.toast) DOMElements.toast.classList.remove('show');
        }, 4000);
    };

    const downloadBlob = (blob, filename) => {
        if (!blob) return;
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    };

    const TEXT_ENCODER = new TextEncoder();

    const CRC32_TABLE = (() => {
        const table = new Uint32Array(256);
        for (let i = 0; i < 256; i += 1) {
            let crc = i;
            for (let j = 0; j < 8; j += 1) {
                crc = (crc & 1) ? (0xEDB88320 ^ (crc >>> 1)) : (crc >>> 1);
            }
            table[i] = crc >>> 0;
        }
        return table;
    })();

    const crc32 = (input) => {
        const data = input instanceof Uint8Array ? input : TEXT_ENCODER.encode(String(input));
        let crc = -1;
        for (let i = 0; i < data.length; i += 1) {
            crc = (crc >>> 8) ^ CRC32_TABLE[(crc ^ data[i]) & 0xFF];
        }
        return (crc ^ -1) >>> 0;
    };

    const createZip = (files) => {
        const localParts = [];
        const centralParts = [];
        let offset = 0;
        const now = new Date();
        const dosTime = ((now.getHours() << 11) | (now.getMinutes() << 5) | Math.floor(now.getSeconds() / 2)) & 0xFFFF;
        const dosDate = (((now.getFullYear() - 1980) << 9) | ((now.getMonth() + 1) << 5) | now.getDate()) & 0xFFFF;

        files.forEach(file => {
            const nameBytes = TEXT_ENCODER.encode(file.name);
            const dataBytes = file.binary instanceof Uint8Array ? file.binary : TEXT_ENCODER.encode(file.data);
            const crc = crc32(dataBytes);

            const localHeader = new Uint8Array(30 + nameBytes.length);
            const localView = new DataView(localHeader.buffer);
            localView.setUint32(0, 0x04034b50, true);
            localView.setUint16(4, 20, true);
            localView.setUint16(6, 0, true);
            localView.setUint16(8, 0, true);
            localView.setUint16(10, dosTime, true);
            localView.setUint16(12, dosDate, true);
            localView.setUint32(14, crc, true);
            localView.setUint32(18, dataBytes.length, true);
            localView.setUint32(22, dataBytes.length, true);
            localView.setUint16(26, nameBytes.length, true);
            localView.setUint16(28, 0, true);
            localHeader.set(nameBytes, 30);

            localParts.push(localHeader, dataBytes);

            const centralHeader = new Uint8Array(46 + nameBytes.length);
            const centralView = new DataView(centralHeader.buffer);
            centralView.setUint32(0, 0x02014b50, true);
            centralView.setUint16(4, 20, true);
            centralView.setUint16(6, 20, true);
            centralView.setUint16(8, 0, true);
            centralView.setUint16(10, 0, true);
            centralView.setUint16(12, dosTime, true);
            centralView.setUint16(14, dosDate, true);
            centralView.setUint32(16, crc, true);
            centralView.setUint32(20, dataBytes.length, true);
            centralView.setUint32(24, dataBytes.length, true);
            centralView.setUint16(28, nameBytes.length, true);
            centralView.setUint16(30, 0, true);
            centralView.setUint16(32, 0, true);
            centralView.setUint16(34, 0, true);
            centralView.setUint16(36, 0, true);
            centralView.setUint32(38, 0, true);
            centralView.setUint32(42, offset, true);
            centralHeader.set(nameBytes, 46);

            centralParts.push(centralHeader);

            offset += localHeader.length + dataBytes.length;
        });

        const centralSize = centralParts.reduce((sum, part) => sum + part.length, 0);
        const localSize = localParts.reduce((sum, part) => sum + part.length, 0);

        const endRecord = new Uint8Array(22);
        const endView = new DataView(endRecord.buffer);
        endView.setUint32(0, 0x06054b50, true);
        endView.setUint16(4, 0, true);
        endView.setUint16(6, 0, true);
        endView.setUint16(8, files.length, true);
        endView.setUint16(10, files.length, true);
        endView.setUint32(12, centralSize, true);
        endView.setUint32(16, localSize, true);
        endView.setUint16(20, 0, true);

        const output = new Uint8Array(localSize + centralSize + endRecord.length);
        let cursor = 0;
        localParts.forEach(part => {
            output.set(part, cursor);
            cursor += part.length;
        });
        centralParts.forEach(part => {
            output.set(part, cursor);
            cursor += part.length;
        });
        output.set(endRecord, cursor);

        return output;
    };

    const escapeXml = (value) => String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&apos;');

    const columnNumberToName = (num) => {
        let columnName = '';
        let n = num;
        while (n > 0) {
            const remainder = (n - 1) % 26;
            columnName = String.fromCharCode(65 + remainder) + columnName;
            n = Math.floor((n - 1) / 26);
        }
        return columnName || 'A';
    };

    const buildWorksheetXml = (rows) => {
        const lines = ['<?xml version="1.0" encoding="UTF-8"?>',
            '<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">',
            '<sheetData>'];

        rows.forEach((row, rowIndex) => {
            const cells = [];
            row.forEach((value, cellIndex) => {
                if (value === null || value === undefined || value === '') return;
                const cellRef = `${columnNumberToName(cellIndex + 1)}${rowIndex + 1}`;
                let cellType = '';
                let cellValue = value;
                let isInlineStr = false;

                if (typeof value === 'number') {
                    cellValue = value;
                } else if (value instanceof Date) {
                    cellValue = Math.round((value.getTime() / 86400000) + 25569);
                } else if (typeof value === 'boolean') {
                    cellType = ' t="b"';
                    cellValue = value ? 1 : 0;
                } else {
                    const numeric = Number(value);
                    if (String(value).trim() !== '' && Number.isFinite(numeric) && !Number.isNaN(numeric)) {
                        cellValue = numeric;
                    } else {
                        isInlineStr = true;
                        cellValue = escapeXml(String(value));
                    }
                }

                if (isInlineStr) {
                    cells.push(`<c r="${cellRef}" t="inlineStr"><is><t>${cellValue}</t></is></c>`);
                } else {
                    cells.push(`<c r="${cellRef}"${cellType}><v>${escapeXml(String(cellValue))}</v></c>`);
                }
            });
            lines.push(`<row r="${rowIndex + 1}">${cells.join('')}</row>`);
        });

        lines.push('</sheetData>');
        lines.push('</worksheet>');
        return lines.join('');
    };

    const sanitizeSheetName = (name) => {
        const cleaned = (name || 'Feuille1').replace(/[\\/:*?\[\]]/g, ' ').trim().slice(0, 31);
        return cleaned || 'Feuille1';
    };

    const createXlsmBlob = (sheetName, rows) => {
        const worksheetXml = buildWorksheetXml(rows);
        const safeSheetName = sanitizeSheetName(sheetName);
        const created = new Date().toISOString();

        const files = [
            {
                name: '[Content_Types].xml',
                data: `<?xml version="1.0" encoding="UTF-8"?>\n<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">\n  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>\n  <Default Extension="xml" ContentType="application/xml"/>\n  <Override PartName="/xl/workbook.xml" ContentType="application/vnd.ms-excel.sheet.macroEnabled.main+xml"/>\n  <Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.ms-excel.worksheet+xml"/>\n  <Override PartName="/docProps/core.xml" ContentType="application/vnd.openxmlformats-package.core-properties+xml"/>\n  <Override PartName="/docProps/app.xml" ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml"/>\n</Types>`
            },
            {
                name: '_rels/.rels',
                data: `<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>\n</Relationships>`
            },
            {
                name: 'docProps/app.xml',
                data: `<?xml version="1.0" encoding="UTF-8"?>\n<Properties xmlns="http://schemas.openxmlformats.org/officeDocument/2006/extended-properties" xmlns:vt="http://schemas.openxmlformats.org/officeDocument/2006/docPropsVTypes">\n  <Application>HotelVision</Application>\n</Properties>`
            },
            {
                name: 'docProps/core.xml',
                data: `<?xml version="1.0" encoding="UTF-8"?>\n<cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:dcterms="http://purl.org/dc/terms/" xmlns:dcmitype="http://purl.org/dc/dcmitype/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">\n  <dc:creator>HotelVision</dc:creator>\n  <cp:lastModifiedBy>HotelVision</cp:lastModifiedBy>\n  <dcterms:created xsi:type="dcterms:W3CDTF">${created}</dcterms:created>\n  <dcterms:modified xsi:type="dcterms:W3CDTF">${created}</dcterms:modified>\n</cp:coreProperties>`
            },
            {
                name: 'xl/workbook.xml',
                data: `<?xml version="1.0" encoding="UTF-8"?>\n<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">\n  <sheets>\n    <sheet name="${escapeXml(safeSheetName)}" sheetId="1" r:id="rId1"/>\n  </sheets>\n</workbook>`
            },
            {
                name: 'xl/_rels/workbook.xml.rels',
                data: `<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>\n</Relationships>`
            },
            {
                name: 'xl/worksheets/sheet1.xml',
                data: worksheetXml
            }
        ];

        const zipBytes = createZip(files);
        return new Blob([zipBytes], { type: 'application/vnd.ms-excel.sheet.macroEnabled.12' });
    };

    const normalizeForPdf = (value) => String(value ?? '')
        .normalize('NFD')
        .replace(/[̀-ͯ]/g, '')
        .replace(/€/g, 'EUR')
        .replace(/[–—]/g, '-')
        .replace(/œ/g, 'oe')
        .replace(/Œ/g, 'OE');

    const escapePdfString = (value) => normalizeForPdf(value)
        .replace(/\\/g, '\\\\')
        .replace(/\(/g, '\\(')
        .replace(/\)/g, '\\)');

    const createPdfBlob = ({ lines, orientation = 'portrait', margin = 40 }) => {
        const width = orientation === 'landscape' ? 842 : 595;
        const height = orientation === 'landscape' ? 595 : 842;
        const startX = margin;
        const startY = height - margin;

        const commands = ['BT'];
        let currentFont = null;
        let isFirstLine = true;

        lines.forEach(rawLine => {
            const size = rawLine?.size || 12;
            const lineHeight = rawLine?.lineHeight || size + 4;
            const text = rawLine?.text ? escapePdfString(rawLine.text) : '';

            if (isFirstLine) {
                commands.push(`/F1 ${size} Tf`);
                commands.push(`1 0 0 1 ${startX} ${startY} Tm`);
                isFirstLine = false;
            } else {
                commands.push(`0 -${lineHeight.toFixed(2)} Td`);
                if (currentFont !== size) {
                    commands.push(`/F1 ${size} Tf`);
                }
            }

            currentFont = size;
            if (text) {
                commands.push(`(${text}) Tj`);
            }
        });

        commands.push('ET');
        const content = `${commands.join('\n')}\n`;
        const contentBytes = TEXT_ENCODER.encode(content);

        const objects = [
            '<< /Type /Catalog /Pages 2 0 R >>',
            '<< /Type /Pages /Kids [3 0 R] /Count 1 >>',
            `<< /Type /Page /Parent 2 0 R /MediaBox [0 0 ${width} ${height}] /Contents 4 0 R /Resources << /Font << /F1 5 0 R >> >> >>`,
            `<< /Length ${contentBytes.length} >>\nstream\n${content}endstream`,
            '<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica >>'
        ];

        const header = TEXT_ENCODER.encode('%PDF-1.4\n%\xE2\xE3\xCF\xD3\n');
        const objectBytes = [];
        const offsets = [0];
        let offset = header.length;

        objects.forEach((obj, index) => {
            offsets.push(offset);
            const bytes = TEXT_ENCODER.encode(`${index + 1} 0 obj\n${obj}\nendobj\n`);
            objectBytes.push(bytes);
            offset += bytes.length;
        });

        const xrefOffset = offset;
        let xref = `xref\n0 ${objects.length + 1}\n0000000000 65535 f \n`;
        for (let i = 1; i <= objects.length; i += 1) {
            xref += `${String(offsets[i]).padStart(10, '0')} 00000 n \n`;
        }
        const xrefBytes = TEXT_ENCODER.encode(xref);
        const trailer = TEXT_ENCODER.encode(`trailer\n<< /Size ${objects.length + 1} /Root 1 0 R >>\nstartxref\n${xrefOffset}\n%%EOF`);

        const totalLength = header.length + objectBytes.reduce((sum, bytes) => sum + bytes.length, 0) + xrefBytes.length + trailer.length;
        const output = new Uint8Array(totalLength);
        let cursor = 0;
        output.set(header, cursor);
        cursor += header.length;
        objectBytes.forEach(bytes => {
            output.set(bytes, cursor);
            cursor += bytes.length;
        });
        output.set(xrefBytes, cursor);
        cursor += xrefBytes.length;
        output.set(trailer, cursor);

        return new Blob([output], { type: 'application/pdf' });
    };

    const formatCurrency = (val) => {
        if (val === null || val === undefined) return 'N/A';
        const num = Number(val);
        if (Number.isNaN(num)) return `${val}`;
        return `${num.toFixed(2).replace('.', ',')} €`;
    };

    const toNumberOrEmpty = (val) => {
        if (val === null || val === undefined) return '';
        const num = Number(val);
        return Number.isNaN(num) ? '' : num;
    };

    const fetchHotels = async () => {
        try {
            const res = await fetch(`${API_URL}/hotels`);
            if (!res.ok) throw new Error('Impossible de charger les hôtels.');
            const hotels = await res.json();
            
            if (DOMElements.hotelIdSelect) {
                DOMElements.hotelIdSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
                hotels.forEach(id => {
                    DOMElements.hotelIdSelect.innerHTML += `<option value="${id}">${id}</option>`;
                });
            }
        } catch(error) {
            console.error('Erreur chargement hôtels:', error);
            showToast(error.message, true);
        }
    };

    const loadData = async () => {
        const hotelId = DOMElements.hotelIdSelect?.value;
        if (!hotelId) return showToast("Veuillez sélectionner un hôtel.", true);
        
        currentSimulationData = null;
        currentAvailabilityData = null;
        DOMElements.resultsContainer?.classList.add('hidden');
        DOMElements.availabilityResults?.classList.add('hidden');

        showSpinner();
        if (DOMElements.statusMessage) {
            DOMElements.statusMessage.textContent = 'Chargement des données...';
        }
        if (DOMElements.mainTools) {
            DOMElements.mainTools.classList.add('opacity-50', 'pointer-events-none');
        }
        
        try {
            const [dataRes, configRes] = await Promise.all([
                fetch(`${API_URL}/data?hotel_id=${encodeURIComponent(hotelId)}`),
                fetch(`${API_URL}/config?hotel_id=${encodeURIComponent(hotelId)}`)
            ]);
            
            if (!dataRes.ok) throw new Error('Données introuvables');
            if (!configRes.ok) throw new Error('Configuration introuvable');
            
            const data = await dataRes.json();
            hotelData = data.rooms || {};
            hotelConfig = await configRes.json();
            
            console.log('Données chargées:', { hotelData, hotelConfig });
            
            populateSelectors();
            
            if (DOMElements.statusMessage) {
                DOMElements.statusMessage.textContent = `Données pour '${hotelId}' chargées avec succès.`;
            }
            if (DOMElements.mainTools) {
                DOMElements.mainTools.classList.remove('opacity-50', 'pointer-events-none');
            }
            showToast(`Données pour ${hotelId} chargées avec succès`);
            
        } catch (error) {
            console.error('Erreur chargement données:', error);
            if (DOMElements.statusMessage) {
                DOMElements.statusMessage.textContent = `Erreur: ${error.message}`;
            }
            showToast(error.message, true);
        } finally {
            hideSpinner();
        }
    };

    const populateSelectors = () => {
        console.log('Populating selectors with data:', { hotelData, hotelConfig });
        
        if (!DOMElements.simPartnerSelect || !DOMElements.simRoomTypeSelect || !DOMElements.availRoomTypesContainer) {
            console.error('Sélecteurs manquants');
            return;
        }

        // Partenaires
        DOMElements.simPartnerSelect.innerHTML = '<option value="">En Direct (0%)</option>';
        
        if (hotelConfig.partners) {
            Object.keys(hotelConfig.partners).sort().forEach(name => {
                const partner = hotelConfig.partners[name];
                DOMElements.simPartnerSelect.innerHTML += `<option value="${name}">${name} (${partner.commission}%)</option>`;
            });
        }

        // Types de chambres
        const roomOrder = hotelConfig.displayOrder?.rooms || Object.keys(hotelData);
        DOMElements.simRoomTypeSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
        DOMElements.availRoomTypesContainer.innerHTML = '';
        
        roomOrder.filter(room => hotelData[room]).forEach(room => {
            DOMElements.simRoomTypeSelect.innerHTML += `<option value="${room}">${room}</option>`;
            DOMElements.availRoomTypesContainer.innerHTML += `
                <div class="flex items-center">
                    <input type="checkbox" id="room-${room}" value="${room}" checked class="room-checkbox rounded border-gray-300 h-4 w-4 text-indigo-600 focus:ring-indigo-500">
                    <label for="room-${room}" class="ml-2 text-sm">${room}</label>
                </div>`;
        });

        updateRatePlans();
    };
    
    const updateRatePlans = async () => {
        if (!DOMElements.simRoomTypeSelect || !DOMElements.simPartnerSelect || !DOMElements.hotelIdSelect || 
            !DOMElements.simRatePlanSelect || !DOMElements.commissionLabel || !DOMElements.partnerDiscountLabel) {
            console.error('Éléments manquants pour updateRatePlans');
            return;
        }

        const room = DOMElements.simRoomTypeSelect.value;
        const partner = DOMElements.simPartnerSelect.value;
        const hotelId = DOMElements.hotelIdSelect.value;
        
        if (!room || !hotelId) {
            DOMElements.simRatePlanSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
            return;
        }
        
        showSpinner();
        try {
            const params = new URLSearchParams({
                hotel_id: hotelId,
                room_type: room,
                partner_name: partner || ''
            });
            
            const res = await fetch(`${API_URL}/plans/partner?${params}`);
            if (!res.ok) throw new Error('Erreur chargement plans');
            
            const data = await res.json();
            console.log('Plans chargés:', data);
            
            DOMElements.simRatePlanSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
            
            if (data.plans && data.plans.length > 0) {
                data.plans.forEach(plan => {
                    DOMElements.simRatePlanSelect.innerHTML += `<option value="${plan}">${plan}</option>`;
                });
            } else {
                DOMElements.simRatePlanSelect.innerHTML = '<option value="">Aucun plan disponible</option>';
            }
            
            const partnerInfo = hotelConfig.partners?.[partner];
            if (partnerInfo) {
                DOMElements.commissionLabel.textContent = `Appliquer commission (${partnerInfo.commission || 0}%)`;
                DOMElements.partnerDiscountLabel.textContent = `Appliquer remise partenaire (${partnerInfo.defaultDiscount?.percentage || 0}%)`;
            } else {
                DOMElements.commissionLabel.textContent = `Appliquer commission (0%)`;
                DOMElements.partnerDiscountLabel.textContent = `Appliquer remise partenaire (0%)`;
            }
            
        } catch (error) {
            console.error('Erreur chargement plans:', error);
            DOMElements.simRatePlanSelect.innerHTML = '<option value="">Erreur chargement</option>';
            showToast('Erreur chargement des plans', true);
        } finally {
            hideSpinner();
        }
    };

    const handleSimulation = async (e) => {
        e.preventDefault();
        const payload = {
            hotel_id: DOMElements.hotelIdSelect.value,
            room: DOMElements.simRoomTypeSelect.value,
            plan: DOMElements.simRatePlanSelect.value,
            start: DOMElements.simStartDate.value,
            end: DOMElements.simEndDate.value,
            partner_name: DOMElements.simPartnerSelect.value || null,
            apply_commission: DOMElements.applyCommission.checked,
            apply_partner_discount: DOMElements.applyPartnerDiscount.checked,
            promo_discount: parseFloat(DOMElements.promoDiscount.value) || 0
        };
        
        if (!payload.start || !payload.end) return showToast("Les dates sont requises.", true);
        if (!payload.room) return showToast("Le type de chambre est requis.", true);
        if (!payload.plan) return showToast("Le plan tarifaire est requis.", true);
        
        showSpinner();
        try {
            const res = await fetch(`${API_URL}/simulate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const result = await res.json();
            if (!res.ok) throw new Error(result.detail || 'Erreur de simulation');
            
            displayResults(result);
            showToast('Simulation terminée avec succès');
            
        } catch (error) {
            console.error('Erreur simulation:', error);
            showToast(error.message, true);
        } finally {
            hideSpinner();
        }
    };

    const displayResults = (data) => {
        currentSimulationData = data;
        DOMElements.resultsContainer.classList.remove('hidden');
        
        document.getElementById('simRoomName').textContent = data.simulation_info.room;
        document.getElementById('simSourceInfo').textContent = `Source: ${data.simulation_info.source}`;
        
        DOMElements.resultsTableBody.innerHTML = data.results.map(day => {
            const stockColor = (day.stock ?? 0) > 2 ? 'text-green-600' : (day.stock ?? 0) > 0 ? 'text-orange-500' : 'text-red-500';
            return `<tr class="hover:bg-gray-50">
                <td class="px-4 py-3 whitespace-nowrap">${day.date_display}</td>
                <td class="px-4 py-3 text-right whitespace-nowrap">${formatCurrency(day.gross_price)}</td>
                <td class="px-4 py-3 text-right font-semibold text-indigo-700 whitespace-nowrap">${formatCurrency(day.net_price)}</td>
                <td class="px-4 py-3 text-right font-medium ${stockColor} whitespace-nowrap">${day.stock ?? 'N/A'}</td>
                <td class="px-4 py-3 text-right whitespace-nowrap">${day.availability}</td>
            </tr>`;
        }).join('');
        
        const { summary } = data;
        document.getElementById('subtotalBrut').textContent = formatCurrency(summary.subtotal_brut);
        document.getElementById('totalDiscount').textContent = `- ${formatCurrency(summary.total_discount)}`;
        document.getElementById('totalCommission').textContent = `- ${formatCurrency(summary.total_commission)}`;
        document.getElementById('totalNetFinal').textContent = formatCurrency(summary.total_net);
    };

    const handleAvailability = async (e) => {
        e.preventDefault();
        const selectedRooms = Array.from(document.querySelectorAll('.room-checkbox:checked')).map(cb => cb.value);
        if (selectedRooms.length === 0) return showToast("Veuillez sélectionner au moins une chambre.", true);
        
        const payload = {
            hotel_id: DOMElements.hotelIdSelect.value,
            start_date: DOMElements.availStartDate.value,
            end_date: DOMElements.availEndDate.value,
            room_types: selectedRooms
        };
        
        if (!payload.start_date || !payload.end_date) return showToast("Les dates sont requises.", true);
        
        showSpinner();
        try {
            const res = await fetch(`${API_URL}/availability`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const result = await res.json();
            if (!res.ok) throw new Error(result.detail || 'Erreur disponibilités');
            
            displayAvailabilityResults(result);
            showToast('Disponibilités chargées avec succès');

        } catch (error) {
            console.error('Erreur disponibilités:', error);
            showToast(error.message, true);
        } finally {
            hideSpinner();
        }
    };

    const displayAvailabilityResults = (data) => {
        currentAvailabilityData = data;
        DOMElements.availabilityResults.classList.remove('hidden');

        let tableHTML = `
            <table class="w-full text-sm sticky-table-header">
                <thead>
                    <tr>
                        <th class="px-4 py-3 text-left font-semibold text-gray-700 sticky left-0 bg-gray-50 z-10">Type de chambre</th>
        `;
        
        data.period.dates.forEach(date => {
            tableHTML += `<th class="px-2 py-2 text-center font-semibold text-gray-700 sticky top-0 bg-gray-50">${data.period.date_display[date]}</th>`;
        });
        
        tableHTML += '</tr></thead><tbody class="divide-y divide-gray-200">';
        
        Object.entries(data.availability).forEach(([roomName, dates]) => {
            tableHTML += '<tr class="hover:bg-gray-50">';
            tableHTML += `<td class="px-4 py-3 font-medium sticky left-0 bg-white z-10 whitespace-nowrap">${roomName}</td>`;
            
            data.period.dates.forEach(date => {
                const stock = dates[date];
                let bgColor = 'bg-red-100 text-red-800';
                if (stock > 0) bgColor = 'bg-orange-100 text-orange-800';
                if (stock > 2) bgColor = 'bg-green-100 text-green-800';
                tableHTML += `<td class="px-2 py-2 text-center font-semibold ${bgColor}">${stock}</td>`;
            });
            
            tableHTML += '</tr>';
        });
        
        tableHTML += '</tbody></table>';
        DOMElements.availabilityTableContainer.innerHTML = tableHTML;
    };

    const buildSimulationMetadata = () => {
        const info = currentSimulationData?.simulation_info || {};
        const hotelId = DOMElements.hotelIdSelect?.value || '';
        const period = info.start_date && info.end_date ? `${info.start_date} -> ${info.end_date}` : '';
        return [
            ['Hôtel', hotelId],
            ['Type de chambre', info.room || ''],
            ['Source', info.source || ''],
            ['Période', period]
        ];
    };

    const exportSimulationToExcel = () => {
        if (!currentSimulationData) {
            showToast('Aucune simulation à exporter.', true);
            return;
        }
        const { results = [], summary = {} } = currentSimulationData;
        const worksheetData = [
            ...buildSimulationMetadata(),
            [],
            ['Date', 'Prix Brut (€)', 'Prix Net (€)', 'Stock', 'Disponibilité'],
            ...results.map(day => [
                day.date_display || day.date || '',
                typeof day.gross_price === 'number' ? day.gross_price : (day.gross_price ?? ''),
                typeof day.net_price === 'number' ? day.net_price : (day.net_price ?? ''),
                day.stock ?? '',
                day.availability ?? ''
            ]),
            [],
            ['Sous-Total Brut', toNumberOrEmpty(summary.subtotal_brut)],
            ['Remises & Promos', toNumberOrEmpty(summary.total_discount)],
            ['Total Commission', toNumberOrEmpty(summary.total_commission)],
            ['Total Net Final', toNumberOrEmpty(summary.total_net)]
        ];

        const hotelId = DOMElements.hotelIdSelect?.value || 'hotel';
        const timestamp = new Date().toISOString().split('T')[0];
        const blob = createXlsmBlob('Simulation', worksheetData);
        downloadBlob(blob, `simulation_${hotelId}_${timestamp}.xlsm`);
        showToast('Export Excel généré.');
    };

    const exportSimulationToPdf = () => {
        if (!currentSimulationData) {
            showToast('Aucune simulation à exporter.', true);
            return;
        }
        const summary = currentSimulationData.summary || {};
        const summaryOrNA = (value, prefix = '') => {
            if (value === null || value === undefined) return 'N/A';
            const formatted = formatCurrency(value);
            return prefix ? `${prefix} ${formatted}` : formatted;
        };

        const metadata = buildSimulationMetadata().filter(([, value]) => value).map(([label, value]) => `${label} : ${value}`);
        const headers = ['Date', 'Prix Brut (€)', 'Prix Net (€)', 'Stock', 'Disponibilité'];
        const rows = (currentSimulationData.results || []).map(day => [
            day.date_display || day.date || '',
            typeof day.gross_price === 'number' ? day.gross_price.toFixed(2) : (day.gross_price ?? ''),
            typeof day.net_price === 'number' ? day.net_price.toFixed(2) : (day.net_price ?? ''),
            day.stock ?? '',
            day.availability ?? ''
        ]);

        const lines = [
            { text: 'Simulation de reservation', size: 18 },
            ...metadata.map(text => ({ text, size: 12 })),
            { text: '', size: 12 },
            { text: headers.join(' | '), size: 11 },
            ...rows.map(row => ({ text: row.join(' | '), size: 10 })),
            { text: '', size: 12 },
            { text: `Sous-Total Brut : ${summaryOrNA(summary.subtotal_brut)}`, size: 12 },
            { text: `Remises & Promos : ${summaryOrNA(summary.total_discount, '-')}`, size: 12 },
            { text: `Total Commission : ${summaryOrNA(summary.total_commission, '-')}`, size: 12 },
            { text: `Total Net Final : ${summaryOrNA(summary.total_net)}`, size: 12 }
        ];

        const blob = createPdfBlob({ lines, orientation: 'landscape' });
        const hotelId = DOMElements.hotelIdSelect?.value || 'hotel';
        const timestamp = new Date().toISOString().split('T')[0];
        downloadBlob(blob, `simulation_${hotelId}_${timestamp}.pdf`);
        showToast('Export PDF généré.');
    };

    const exportAvailabilityToExcel = () => {
        if (!currentAvailabilityData) {
            showToast('Aucune disponibilité à exporter.', true);
            return;
        }

        const { period, availability } = currentAvailabilityData;
        const dates = period?.dates || [];
        const headerRow = ['Type de chambre', ...dates.map(date => period?.date_display?.[date] || date)];
        const rows = Object.entries(availability || {}).map(([roomName, values]) => [
            roomName,
            ...dates.map(date => toNumberOrEmpty(values?.[date]))
        ]);

        const worksheetData = [
            ['Hôtel', DOMElements.hotelIdSelect?.value || ''],
            ['Période', dates.length ? `${dates[0]} -> ${dates[dates.length - 1]}` : ''],
            [],
            headerRow,
            ...rows
        ];

        const hotelId = DOMElements.hotelIdSelect?.value || 'hotel';
        const timestamp = new Date().toISOString().split('T')[0];
        const blob = createXlsmBlob('Disponibilites', worksheetData);
        downloadBlob(blob, `disponibilites_${hotelId}_${timestamp}.xlsm`);
        showToast('Export Excel des disponibilités généré.');
    };

    const exportAvailabilityToPdf = () => {
        if (!currentAvailabilityData) {
            showToast('Aucune disponibilité à exporter.', true);
            return;
        }
        const { period, availability } = currentAvailabilityData;
        const dates = period?.dates || [];

        const hotelId = DOMElements.hotelIdSelect?.value || '';
        const header = ['Type de chambre', ...dates.map(date => period?.date_display?.[date] || date)];
        const rows = Object.entries(availability || {}).map(([roomName, values]) => [
            roomName,
            ...dates.map(date => {
                const cellValue = values?.[date];
                if (cellValue === null || cellValue === undefined) return '';
                const num = Number(cellValue);
                return Number.isNaN(num) ? `${cellValue}` : num;
            })
        ]);

        const lines = [
            { text: 'Tableau des disponibilites', size: 18 }
        ];
        if (hotelId) {
            lines.push({ text: `Hotel : ${hotelId}`, size: 12 });
        }
        if (dates.length) {
            lines.push({ text: `Periode : ${dates[0]} -> ${dates[dates.length - 1]}`, size: 12 });
        }
        lines.push({ text: '', size: 12 });
        lines.push({ text: header.join(' | '), size: 11 });
        rows.forEach(row => {
            lines.push({ text: row.join(' | '), size: 10 });
        });

        const blob = createPdfBlob({ lines, orientation: 'landscape' });
        const timestamp = new Date().toISOString().split('T')[0];
        downloadBlob(blob, `disponibilites_${hotelId || 'hotel'}_${timestamp}.pdf`);
        showToast('Export PDF des disponibilités généré.');
    };
    
    // Event listeners
    DOMElements.refreshDataBtn.addEventListener('click', loadData);
    DOMElements.simRoomTypeSelect.addEventListener('change', updateRatePlans);
    DOMElements.simPartnerSelect.addEventListener('change', updateRatePlans);
    DOMElements.simulationForm.addEventListener('submit', handleSimulation);
    DOMElements.availabilityForm.addEventListener('submit', handleAvailability);
    DOMElements.newSimulationBtn.addEventListener('click', () => {
        DOMElements.resultsContainer.classList.add('hidden');
        currentSimulationData = null;
    });

    DOMElements.exportSimulationExcelBtn?.addEventListener('click', exportSimulationToExcel);
    DOMElements.exportSimulationPdfBtn?.addEventListener('click', exportSimulationToPdf);
    DOMElements.availabilityExcelBtn?.addEventListener('click', exportAvailabilityToExcel);
    DOMElements.availabilityPdfBtn?.addEventListener('click', exportAvailabilityToPdf);
    
    DOMElements.selectAllRoomsBtn.addEventListener('click', () => {
        document.querySelectorAll('.room-checkbox').forEach(cb => cb.checked = true);
    });
    
    DOMElements.deselectAllRoomsBtn.addEventListener('click', () => {
        document.querySelectorAll('.room-checkbox').forEach(cb => cb.checked = false);
    });
    
    document.querySelectorAll('.tab-link').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.tab-link').forEach(btn => btn.classList.remove('tab-active'));
            button.classList.add('tab-active');
            document.querySelectorAll('[id^="tab-content-"]').forEach(content => content.classList.add('hidden'));
            document.getElementById(`tab-content-${button.dataset.tab}`).classList.remove('hidden');
        });
    });

    // Initialisation des dates
    const today = new Date();
    const nextWeek = new Date(new Date().setDate(today.getDate() + 7));
    [DOMElements.simStartDate, DOMElements.availStartDate].forEach(el => el.value = today.toISOString().split('T')[0]);
    [DOMElements.simEndDate, DOMElements.availEndDate].forEach(el => el.value = nextWeek.toISOString().split('T')[0]);
    
    fetchHotels();
    feather.replace();
});
</script>
</body>
</html>
