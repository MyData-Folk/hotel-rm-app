<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur - RM Hôtel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="public/style.css">
</head>
<body class="bg-light-bg text-text-dark font-sans">
    <header class="bg-card-bg shadow-md">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center"><i class="fas fa-chart-line text-primary-color text-2xl mr-3"></i><h1 class="text-xl font-bold">Simulateur de Réservation</h1></div>
            <a href="/admin.html" class="bg-gray-200 text-text-dark px-4 py-2 rounded-md hover:bg-gray-300 transition flex items-center"><i class="fas fa-cogs mr-2"></i><span>Aller à l'Admin</span></a>
        </div>
    </header>
    <main class="container mx-auto px-6 py-8">
        <div class="bg-card-bg rounded-lg shadow-lg p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="hotelId" class="block text-sm font-medium text-text-medium mb-1">ID de l'hôtel</label>
                    <div class="flex">
                        <input type="text" id="hotelId" value="folkestone" class="w-full px-3 py-2 border border-border-color rounded-l-md focus:outline-none focus:ring-2 focus:ring-primary-color" required>
                        <button id="refreshDataBtn" class="bg-secondary-color text-white px-4 py-2 rounded-r-md hover:bg-purple-700 transition"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>
                <div class="md:col-span-2 flex items-center bg-indigo-50 p-3 rounded-md">
                    <i class="fas fa-info-circle text-primary-color mr-3"></i>
                    <p id="statusMessage" class="text-sm text-text-medium">Cliquez sur <i class="fas fa-sync-alt"></i> pour charger/actualiser les données.</p>
                </div>
            </div>
        </div>
        <form id="simulationForm" class="bg-card-bg rounded-lg shadow-lg p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                <div><label for="simPartner" class="block text-sm font-medium text-text-medium mb-1">Partenaire</label><select id="simPartner" class="w-full px-3 py-2 border border-border-color rounded-md bg-white" disabled></select></div>
                <div><label for="simRoomType" class="block text-sm font-medium text-text-medium mb-1">Chambre</label><select id="simRoomType" class="w-full px-3 py-2 border border-border-color rounded-md bg-white" disabled></select></div>
                <div><label for="simRatePlan" class="block text-sm font-medium text-text-medium mb-1">Tarif</label><select id="simRatePlan" class="w-full px-3 py-2 border border-border-color rounded-md bg-white" disabled></select></div>
                <div><label for="simStartDate" class="block text-sm font-medium text-text-medium mb-1">Arrivée</label><input type="date" id="simStartDate" class="w-full px-3 py-2 border border-border-color rounded-md"></div>
                <div><label for="simEndDate" class="block text-sm font-medium text-text-medium mb-1">Départ</label><input type="date" id="simEndDate" class="w-full px-3 py-2 border border-border-color rounded-md"></div>
            </div>
            <div class="mt-6 text-right"><button type="submit" class="bg-primary-color text-white font-bold py-2 px-6 rounded-md hover:bg-primary-hover transition">Lancer la Simulation</button></div>
        </form>
        <div id="resultsContainer" class="mt-8 hidden">
            <h2 class="text-xl font-semibold mb-4">Résultats de la Simulation</h2>
            <div class="bg-card-bg rounded-lg shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left"><thead class="bg-light-bg text-xs text-text-medium uppercase tracking-wider"><tr><th class="px-6 py-3">Date</th><th class="px-6 py-3 text-right">Stock</th><th class="px-6 py-3 text-right">Prix Brut</th><th class="px-6 py-3 text-right">Commission</th><th class="px-6 py-3 text-right font-bold">Prix Net</th></tr></thead><tbody id="resultsTableBody" class="divide-y divide-border-color"></tbody><tfoot id="resultsTableFoot" class="bg-light-bg font-bold"></tfoot></table>
                </div>
            </div>
        </div>
    </main>
    <div id="spinner-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="spinner"></div></div>
    <div id="toast" class="toast fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-md shadow-lg"></div>
    <script>
        const API_URL = ''; // Chemin relatif, l'API est sur le même domaine
        let hotelData = {}; let hotelConfig = {};
        const refreshDataBtn = document.getElementById('refreshDataBtn'); const hotelIdInput = document.getElementById('hotelId');
        const statusMessage = document.getElementById('statusMessage'); const formSelects = document.querySelectorAll('#simulationForm select');
        const simPartnerSelect = document.getElementById('simPartner'); const simRoomTypeSelect = document.getElementById('simRoomType');
        const simRatePlanSelect = document.getElementById('simRatePlan'); const simulationForm = document.getElementById('simulationForm');
        const resultsContainer = document.getElementById('resultsContainer'); const resultsTableBody = document.getElementById('resultsTableBody');
        const resultsTableFoot = document.getElementById('resultsTableFoot'); const spinner = document.getElementById('spinner-overlay');
        const toast = document.getElementById('toast');
        const showSpinner = () => spinner.classList.remove('hidden'); const hideSpinner = () => spinner.classList.add('hidden');
        const showToast = (message, success = true) => {
            toast.textContent = message; toast.style.backgroundColor = success ? 'var(--success-color)' : 'var(--error-color)';
            toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000);
        };
        const loadData = async () => {
            const hotelId = hotelIdInput.value; if (!hotelId) { showToast("Veuillez entrer un ID d'hôtel.", false); return; }
            showSpinner(); statusMessage.textContent = 'Chargement...'; resultsContainer.classList.add('hidden'); formSelects.forEach(sel => sel.disabled = true);
            try {
                const [dataRes, configRes] = await Promise.all([ fetch(`${API_URL}/data?hotel_id=${hotelId}`), fetch(`${API_URL}/config?hotel_id=${hotelId}`) ]);
                if (!dataRes.ok) throw new Error(`Données de planning non trouvées (Code: ${dataRes.status})`);
                if (!configRes.ok) throw new Error(`Données de configuration non trouvées (Code: ${configRes.status})`);
                hotelData = await dataRes.json(); hotelConfig = await configRes.json();
                populateSelectors(); statusMessage.textContent = `Données chargées pour "${hotelId}". Prêt à simuler.`;
                showToast('Données actualisées !'); formSelects.forEach(sel => sel.disabled = false);
            } catch (error) { statusMessage.innerHTML = `Erreur: ${error.message}.`; showToast(error.message, false); } finally { hideSpinner(); }
        };
        const populateSelectors = () => {
            simPartnerSelect.innerHTML = '<option value="">En Direct (0%)</option>';
            hotelConfig.ota_partners?.forEach(p => simPartnerSelect.innerHTML += `<option value="${p.id}">${p.name} (${p.commission}%)</option>`);
            simRoomTypeSelect.innerHTML = ''; Object.keys(hotelData).forEach(room => simRoomTypeSelect.innerHTML += `<option value="${room}">${room}</option>`);
            const updateRatePlans = () => {
                simRatePlanSelect.innerHTML = ''; const selectedRoom = simRoomTypeSelect.value;
                if (hotelData[selectedRoom]?.plans) { Object.keys(hotelData[selectedRoom].plans).forEach(plan => simRatePlanSelect.innerHTML += `<option value="${plan}">${plan}</option>`); }
            };
            simRoomTypeSelect.addEventListener('change', updateRatePlans); updateRatePlans();
        };
        const handleSimulation = async (e) => {
            e.preventDefault(); const payload = {
                hotel_id: hotelIdInput.value, room: simRoomTypeSelect.value, plan: simRatePlanSelect.value,
                start: document.getElementById('simStartDate').value, end: document.getElementById('simEndDate').value,
                partner_id: simPartnerSelect.value
            };
            if (!payload.start || !payload.end) { showToast("Veuillez sélectionner des dates.", false); return; }
            showSpinner();
            try {
                const response = await fetch(`${API_URL}/simulate`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json(); if (!response.ok) throw new Error(result.detail || 'Erreur');
                displayResults(result);
            } catch (error) { showToast(error.message, false); } finally { hideSpinner(); }
        };
        const displayResults = (data) => {
            resultsTableBody.innerHTML = ''; if (!data.results?.length) {
                resultsTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-6">Aucune donnée disponible.</td></tr>';
                resultsTableFoot.innerHTML = ''; resultsContainer.classList.remove('hidden'); return;
            }
            data.results.forEach(day => {
                const stockColor = (day.stock ?? 0) > 5 ? 'text-green-600' : ((day.stock ?? 0) > 0 ? 'text-orange-500' : 'text-red-500');
                const formatCurrency = (val) => val?.toFixed(2) ?? 'N/A';
                resultsTableBody.innerHTML += `<tr><td class="px-6 py-4">${day.date}</td><td class="px-6 py-4 text-right font-medium ${stockColor}">${day.stock ?? 'N/A'}</td><td class="px-6 py-4 text-right">${formatCurrency(day.price)} €</td><td class="px-6 py-4 text-right">${formatCurrency(day.commission)} €</td><td class="px-6 py-4 text-right font-bold text-primary-color">${formatCurrency(day.net_price)} €</td></tr>`;
            });
            resultsTableFoot.innerHTML = `<tr><td class="px-6 py-4">Total</td><td></td><td class="px-6 py-4 text-right">${data.summary.subtotal.toFixed(2)} €</td><td class="px-6 py-4 text-right">${data.summary.total_commission.toFixed(2)} €</td><td class="px-6 py-4 text-right text-primary-color">${data.summary.total_net.toFixed(2)} €</td></tr>`;
            resultsContainer.classList.remove('hidden');
        };
        refreshDataBtn.addEventListener('click', loadData); simulationForm.addEventListener('submit', handleSimulation);
    </script>
</body>
</html>